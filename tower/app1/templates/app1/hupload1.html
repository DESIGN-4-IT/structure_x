{% extends "app1/base.html" %}
{% load static %}  <!-- Load static here too for good measure -->

{% block title %}Home - KOmatrix LoadView{% endblock %}

{% block extra_css %}

    <link rel="stylesheet" href="styles.css">
    <style>
        

.content {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 90px 20px 20px;
    background: linear-gradient(to right, rgb(247, 248, 248), rgb(234, 252, 252));
    min-height: 100vh;
}

.form-container {
    background: #ffffff;
    border-radius: 12px;
    padding: 40px 30px;
    width: 90%;
    max-width: 700px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    animation: fadeIn 0.8s ease;
}

.form-container h2 {
    text-align: center;
    font-size: 25px;
    margin-bottom: 22px;
    color: #333;
}

.selected-structure-info {
    background: #e8f4fd;
    border: 1px solid #b6d7f2;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    font-size: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.existing-data-badge {
    background: #f39c12;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.existing-data-message {
    text-align: center;
    padding: 30px 20px;
}

.existing-data-message .alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 140px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

/* Upload Section */
.upload-section {
    display: flex;
    justify-content: center;
    margin-bottom: 25px;
}

.upload-box {
    padding: 25px;
    border: 2px dashed #ddd;
    border-radius: 10px;
    text-align: center;
    background-color: #fafafa;
    width: 100%;
    max-width: 500px;
    transition: all 0.3s ease;
}

.upload-box:hover {
    border-color: #3498db;
    background-color: #f8f9ff;
}

.upload-box p {
    margin: 12px 0;
    font-weight: 500;
    color: #444;
}

.file-input-container {
    position: relative;
    margin: 20px 0;
}

#file-input {
    display: none;
}

.file-input-label {
    display: block;
    padding: 20px;
    border: 2px dashed #3498db;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
    color: #3498db;
    font-weight: 600;
}

.file-input-label:hover {
    background: #e8f4fd;
    border-color: #2980b9;
}

.file-input-label i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

#file-name {
    display: block;
    margin-top: 10px;
    color: #7f8c8d;
    font-style: italic;
}

.upload-button {
    background: #27ae60;
    color: white;
    padding: 14px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    width: 100%;
    margin-top: 15px;
    transition: all 0.3s ease;
}

.upload-button:hover {
    background: #219a52;
    transform: translateY(-2px);
}

/* Update Link */
.update-link {
    text-align: center;
    margin: 25px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.update-link p {
    margin-bottom: 12px;
    color: #666;
}

.update-button {
    background: #e67e22;
    color: white;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-block;
}

.update-button:hover {
    background: #d35400;
    transform: translateY(-2px);
}

/* Attachment Section */
.attachment-section {
    background-color: #f9f9d8;
    padding: 20px;
    margin: 25px 0;
    text-align: center;
    border-radius: 8px;
    font-weight: 500;
    border-left: 4px solid #e6c229;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f8f9fa;
    font-size: 14px;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #3498db;
    background-color: #ffffff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Buttons Section */
.buttons {
    display: flex;
    gap: 15px;
    margin: 25px 0;
    flex-wrap: wrap;
}

.set-phase-button, .attachments-button {
    flex: 1;
    min-width: 180px;
    background-color: #3498db;
    color: white;
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.attachments-button {
    background-color: #27ae60;
}

.set-phase-button:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
}

.attachments-button:hover {
    background-color: #219a52;
    transform: translateY(-2px);
}

/* Load Cases Section */
/* Load Cases Section */
.load-cases-section {
    margin-top: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e1e4e8;
}

.load-case-links {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.load-case-link {
    display: inline-block;
    padding: 10px 20px;
    background-color: #f0f0f0;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: all 0.3s;
}

.load-case-link:hover {
    background-color: #e0e0e0;
    transform: translateY(-2px);
}

.load-case-link.active {
    background-color: #1252a7;
    color: white;
    border-color: #1252a7;
}

#load-cases-results {
    margin-top: 10px;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e1e4e8;
}

.load-cases-list, .group-load-cases-list {
    list-style-type: none;
    padding-left: 0;
}

.load-cases-list li, .group-load-cases-list li {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.load-cases-list li:hover, .group-load-cases-list li:hover {
    background-color: #f0f4f8;
}

.load-case-group {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    background: white;
}

.load-case-group h5 {
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    color: #1252a7;
}

.group-select-all {
    margin-bottom: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Selected Load Cases */
.selected-load-cases {
    margin-top: 25px;
    padding: 20px;
    background: #e8f4ff;
    border-radius: 8px;
    border: 1px solid #c3d9f8;
}

.selected-case {
    display: inline-block;
    margin: 5px;
    padding: 8px 15px;
    background: white;
    border-radius: 20px;
    border: 1px solid #c3d9f8;
    position: relative;
}

.remove-case {
    margin-left: 8px;
    cursor: pointer;
    color: #ff4757;
    font-weight: bold;
}

.remove-case:hover {
    color: #ff2e43;
}

/* Custom Group Creation Section */
#create-custom-group {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e1e4e8;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

#custom-group-name {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

#custom-group-name:focus {
    border-color: #1252a7;
    outline: none;
    box-shadow: 0 0 0 3px rgba(18, 82, 167, 0.1);
}

#create-custom-group-btn {
    background-color: #1252a7;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

#create-custom-group-btn:hover {
    background-color: #0e4285;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

#create-custom-group-btn:active {
    transform: translateY(0);
}


/* Responsive Design */
@media (max-width: 768px) {
    .content {
        padding: 80px 15px 15px;
    }
    
    .form-container {
        padding: 30px 20px;
        width: 95%;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .upload-box {
        padding: 20px;
    }
    
    .buttons {
        flex-direction: column;
    }
    
    .set-phase-button, .attachments-button {
        width: 100%;
    }
    
    .load-case-links {
        flex-direction: column;
    }
    
    .load-case-link {
        text-align: center;
    }
    
    #create-custom-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    #custom-group-name {
        min-width: auto;
        margin-bottom: 10px;
    }
    
    #create-custom-group-btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .form-container h2 {
        font-size: 22px;
    }
    
    .upload-box {
        padding: 15px;
    }
    
    .file-input-label {
        padding: 15px;
        font-size: 14px;
    }
    
    .upload-button {
        padding: 12px 20px;
        font-size: 15px;
    }
    
    .set-phase-button, .attachments-button {
        padding: 12px;
        font-size: 14px;
    }
}

@keyframes fadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* Base responsive button styles */
.btn-responsive {
    font-size: 0.775rem; /* Slightly larger than btn-sm for better readability */
    padding: 0.375rem 0.75rem; /* Compact padding */
    border-radius: 0.25rem;
}

.form-control-responsive {
    display: inline-block;
    width: 200px; /* Smaller default width for compactness when visible */
    font-size: 0.875rem; /* Compact font */
    padding: 0.375rem 0.75rem; /* Compact padding */
    border-radius: 0.25rem;
}
        
    </style>
{% endblock %}

{% block content %}
    
    
<div class="content">
    <div class="form-container">
        {% comment %} <h2>File Upload - {{ structure_type|title }}</h2> {% endcomment %}
        <h2>File Upload</h2>
        <!-- Display selected structure info -->
        {% if selected_structure %}
        <div class="selected-structure-info">
            <strong>Selected Structure:</strong> {{ selected_structure.structure }}
            {% if existing_file %}
            <span class="existing-data-badge">File Exists</span>
            {% endif %}
        </div>
        {% endif %}

        {% if not circuit_data_exists %}
        <!-- Show message if circuit data doesn't exist -->
        <div class="existing-data-message">
            <div class="alert">
                <strong>Please complete circuit definition first.</strong>
            </div>
            <div class="action-buttons">
                <a href="{% url 'hdeadend1' %}?structure_id={{ structure_id }}&structure_type={{ structure_type }}" class="btn btn-primary">
                    Go to Circuit Definition
                </a>
                <a href="{% url 'home' %}" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>
        
        {% elif existing_file %}
        <!-- Show options when file exists -->
        <div class="existing-data-message">
            <div class="alert">
                <strong>File already exists for this structure.</strong>
            </div>
            <div class="action-buttons">
                <a href="{% url 'hupload1_update' %}" class="btn btn-primary">Update Existing File</a>
            </div>
            
            <!-- Extraction section for existing files -->
            <div class="attachment-section">
                <h3>Extract Data from Existing File</h3>
                <select id="structure-select" class="form-control">
                    <option value="{{ structure_id }}" selected>{{ selected_structure.structure }}</option>
                </select>
            </div>
        </div>
        
        {% else %}
        <!-- Show upload form if no file exists -->
        <form method="post" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}
            
            <!-- Hide the structure dropdown since it's hardcoded -->
            <div style="display: none;">
                {{ form.structure }}
            </div>
            
            <div class="upload-section">
                <div class="upload-box">
                    <p>Upload File for: <strong>{{ selected_structure.structure }}</strong></p>
                    
                    <div class="file-input-container">
                        <input type="file" name="file" id="file-input" accept=".xls,.xlsx" required>
                        <label for="file-input" class="file-input-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Choose Excel File (.xls, .xlsx)
                        </label>
                        <span id="file-name">No file chosen</span>
                    </div>

                    <button type="submit" class="upload-button">Upload File</button>
                </div>
            </div>
        </form>

        <div class="update-link">
            <p>Need to update an existing file?</p>
            <a href="{% url 'hupload1_update' %}?structure_id={{ structure_id }}&structure_type={{ structure_type }}" class="update-button">
                Update Existing File
            </a>
        </div>

        <div class="attachment-section">
            <p>Extract Data for: <strong>{{ selected_structure.structure }}</strong></p>
            <select id="structure-select" class="form-control">
                <option value="{{ structure_id }}" selected>{{ selected_structure.structure }}</option>
            </select>
        </div>
        {% endif %}

        <!-- Load Cases and Data Extraction Sections -->
        {% if circuit_data_exists and existing_file %}
        <div class="load-cases-section">
            <h3>Load Cases</h3>
            <div class="load-case-links">
                <a href="#" id="imported-load-cases-link" class="load-case-link">Imported Load Cases</a>
                <a href="#" id="group-load-cases-link" class="load-case-link">Group Load Cases</a>
                <a href="#" id="custom-groups-link" class="load-case-link">Custom Groups</a>
            </div>
            
            <div id="load-cases-results"></div>
        </div>

        <div class="selected-load-cases" id="selected-load-cases" style="display: none;">
            <h4>Selected Load Cases:</h4>
            <div id="selected-cases-list"></div>
            
            <div id="create-custom-group" style="display: none;">
                <input type="text" id="custom-group-name" placeholder="Enter custom group name">
                <button id="create-custom-group-btn" class="btn btn-primary">Create Custom Group</button>
            </div>
        </div>

        <div class="buttons">
            <form id="set-phase-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="structure_id" value="{{ structure_id }}">
                <input type="hidden" name="go_button" value="set_phase">
                <input type="hidden" name="load_case_values" id="load-case-values-input">
                <button type="submit" class="set-phase-button">Set / Phase</button>
            </form>

            <form id="joint-labels-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="structure_id" value="{{ structure_id }}">
                <input type="hidden" name="go_button" value="joint_labels">
                <input type="hidden" name="load_case_values" id="load-case-values-input-joint">
                <button type="submit" class="attachments-button">Attachments Joint Labels</button>
            </form>
        </div>

        <div id="results-container"></div>
        {% endif %}
    </div>
</div>

       



    {% endblock %}

{% block extra_js %}

    <script>
        // Get the popup overlay and popups
        const monopolePopupOverlay = document.getElementById('monopole-popup-overlay');
        const monopolePopup1 = document.getElementById('monopole-popup1');
        const monopolePopup2 = document.getElementById('monopole-popup2'); // Add more popups as needed
    
        // Initialize a stack to keep track of opened popups
        let popupStack = [];
    
        // Function to show a popup
        function showPopup(popup) {
            monopolePopupOverlay.style.display = 'flex'; // Show the popup overlay
            popup.style.display = 'block'; // Show the specified popup
            popupStack.push(popup); // Push the popup to the stack
        }
    
        // Function to close the current popup
        function closePopup() {
            const currentPopup = popupStack.pop(); // Remove the current popup from the stack
            if (currentPopup) {
                currentPopup.style.display = 'none'; // Hide the current popup
            }
            
            if (popupStack.length > 0) {
                const previousPopup = popupStack[popupStack.length - 1]; // Get the previous popup
                previousPopup.style.display = 'block'; // Show the previous popup
            } else {
                monopolePopupOverlay.style.display = 'none'; // Hide the overlay if no popups left
            }
        }
    
    
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const structureSelect = document.getElementById('structure-select');
        const loadCasesSection = document.getElementById('load-cases-section');
        const importedLoadCasesLink = document.getElementById('imported-load-cases-link');
        const groupLoadCasesLink = document.getElementById('group-load-cases-link');
        const customGroupsLink = document.getElementById('custom-groups-link');
        const loadCasesResults = document.getElementById('load-cases-results');

        const selectedLoadCases = new Set();
        const selectedLoadCasesSection = document.getElementById('selected-load-cases');
        const selectedCasesList = document.getElementById('selected-cases-list');
        const loadCaseValuesInput = document.getElementById('load-case-values-input');
        const loadCaseValuesInputJoint = document.getElementById('load-case-values-input-joint');
        const setPhaseForm = document.getElementById('set-phase-form');
        const jointLabelsForm = document.getElementById('joint-labels-form');
        const createCustomGroupSection = document.getElementById('create-custom-group');
        const customGroupNameInput = document.getElementById('custom-group-name');
        const createCustomGroupBtn = document.getElementById('create-custom-group-btn');

        
        // Show load cases section when a structure is selected
        structureSelect.addEventListener('change', function() {
            if (this.value) {
                loadCasesSection.style.display = 'block';
            } else {
                loadCasesSection.style.display = 'none';
                loadCasesResults.innerHTML = '';
                selectedLoadCasesSection.style.display = 'none';
                createCustomGroupSection.style.display = 'none';
            }
        });

        function updateSelectedLoadCases() {
            if (selectedLoadCases.size > 0) {
                selectedLoadCasesSection.style.display = 'block';
                selectedCasesList.innerHTML = '';
                
                selectedLoadCases.forEach(caseName => {
                    const caseElement = document.createElement('div');
                    caseElement.className = 'selected-case';
                    caseElement.innerHTML = `
                        ${caseName}
                        <span class="remove-case" data-case="${caseName}">Ã—</span>
                    `;
                    selectedCasesList.appendChild(caseElement);
                });
                
                // Show create custom group option
                createCustomGroupSection.style.display = 'block';
                
                // Add remove event listeners
                document.querySelectorAll('.remove-case').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const caseName = this.dataset.case;
                        selectedLoadCases.delete(caseName);
                        updateSelectedLoadCases();
                    });
                });
            } else {
                selectedLoadCasesSection.style.display = 'none';
                createCustomGroupSection.style.display = 'none';
            }
        
            // Update hidden inputs
            loadCaseValuesInput.value = Array.from(selectedLoadCases).join(',');
            loadCaseValuesInputJoint.value = Array.from(selectedLoadCases).join(',');
        }

        function clearAllSelections() {
            selectedLoadCases.clear();
            updateSelectedLoadCases();

            // Uncheck all checkboxes in loadCasesResults
            loadCasesResults.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Handle Imported Load Cases link click
        importedLoadCasesLink.addEventListener('click', function(e) {
            e.preventDefault();
            clearAllSelections();

            const structureId = structureSelect.value;
            if (!structureId) {
                alert('Please select a structure first');
                return;
            }

            fetch(`/hupload1/?get_load_cases=true&structure_id=${structureId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    loadCasesResults.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }

                let html = '<h4>Imported Load Cases</h4>';
                if (data.values && data.values.length > 0) {
                    html += '<form id="load-cases-form">';
                    html += '<ul class="load-cases-list">';
                    data.values.forEach(caseName => {
                        const isChecked = selectedLoadCases.has(caseName) ? 'checked' : '';
                        html += `<li>
                            <input type="checkbox" name="load_case_values" value="${caseName}" ${isChecked}>
                            ${caseName}
                        </li>`;
                    });
                    html += '</ul>';
                    html += '</form>';
                } else {
                    html += '<p>No load cases found</p>';
                }
                loadCasesResults.innerHTML = html;

                // Add event listener for checkbox changes
                document.querySelectorAll('#load-cases-form input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedLoadCases.add(this.value);
                        } else {
                            selectedLoadCases.delete(this.value);
                        }
                        updateSelectedLoadCases();
                    });
                });
            })
            .catch(error => {
                loadCasesResults.innerHTML = `<div class="error">Error loading data: ${error}</div>`;
            });
        });

        // Handle Group Load Cases link click
        groupLoadCasesLink.addEventListener('click', function(e) {
            e.preventDefault();
            clearAllSelections();

            const structureId = structureSelect.value;
            if (!structureId) {
                alert('Please select a structure first');
                return;
            }

            fetch(`/hupload1/?get_grouped_load_cases=true&structure_id=${structureId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    loadCasesResults.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }

                let html = '<h4>Group Load Cases</h4>';
                if (data.groups && Object.keys(data.groups).length > 0) {
                    html += '<form id="grouped-load-cases-form">';
                    
                    for (const [groupName, cases] of Object.entries(data.groups)) {
                        html += `<div class="load-case-group">
                            <h5>${groupName}</h5>
                            <div class="group-select-all">
                                <input type="checkbox" id="select-all-${groupName}" class="select-all-group">
                                <label for="select-all-${groupName}">Select All</label>
                            </div>
                            <ul class="group-load-cases-list">`;
                        
                        cases.forEach(caseName => {
                            const isChecked = selectedLoadCases.has(caseName) ? 'checked' : '';
                            html += `<li>
                                <input type="checkbox" name="load_case_values" value="${caseName}" class="group-case-checkbox" data-group="${groupName}" ${isChecked}>
                                ${caseName}
                            </li>`;
                        });
                        
                        html += '</ul></div>';
                    }
                    
                    html += '</form>';
                } else {
                    html += '<p>No grouped load cases found</p>';
                }
                loadCasesResults.innerHTML = html;

                // Add select all functionality
                document.querySelectorAll('.select-all-group').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const groupName = this.id.replace('select-all-', '');
                        const caseCheckboxes = document.querySelectorAll(`.group-case-checkbox[data-group="${groupName}"]`);
                        caseCheckboxes.forEach(cb => {
                            cb.checked = this.checked;
                            if (this.checked) {
                                selectedLoadCases.add(cb.value);
                            } else {
                                selectedLoadCases.delete(cb.value);
                            }
                        });
                        updateSelectedLoadCases();
                    });
                });

                // Add event listener for individual checkbox changes
                document.querySelectorAll('.group-case-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedLoadCases.add(this.value);
                        } else {
                            selectedLoadCases.delete(this.value);
                            // Uncheck select-all if any checkbox is unchecked
                            const groupName = this.dataset.group;
                            const selectAll = document.getElementById(`select-all-${groupName}`);
                            if (selectAll) {
                                selectAll.checked = false;
                            }
                        }
                        updateSelectedLoadCases();
                    });
                });
            })
            .catch(error => {
                loadCasesResults.innerHTML = `<div class="error">Error loading data: ${error}</div>`;
            });
        });

// Handle Custom Groups link click
customGroupsLink.addEventListener('click', function(e) {
    e.preventDefault();
    clearAllSelections();

    const structureId = structureSelect.value;
    if (!structureId) {
        alert('Please select a structure first');
        return;
    }

    fetch(`/hupload1/?get_custom_groups_for_selection=true&structure_id=${structureId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            loadCasesResults.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        let html = '<h4>Custom Groups - Select Load Cases</h4>';
        if (data.custom_groups && Object.keys(data.custom_groups).length > 0) {
            html += '<form id="custom-groups-form">';
            
            for (const [groupName, cases] of Object.entries(data.custom_groups)) {
                html += `<div class="load-case-group" id="group-${groupName.replace(/\s+/g, '-')}">
                    <h5>
                        <span class="group-name-display">${groupName}</span>
                        <button class="btn btn-responsive btn-primary edit-group d-inline-block" data-group="${groupName}" style="margin-left: 10px;">Rename</button>
                        <button class="btn btn-responsive btn-danger delete-group d-inline-block" data-group="${groupName}" style="margin-left: 5px;">Delete</button>
                    </h5>
                    <div class="group-edit-form" style="display: none; margin-bottom: 10px;">
                        <input type="text" class="form-control-responsive edit-group-input" value="${groupName}" style="display: inline-block;">
                        <button class="btn btn-responsive btn-success save-edit d-inline-block" data-group="${groupName}" style="margin-left: 5px;">Save</button>
                        <button class="btn btn-responsive btn-secondary cancel-edit d-inline-block" data-group="${groupName}" style="margin-left: 5px;">Cancel</button>
                    </div>
                    <div class="group-select-all">
                        <input type="checkbox" id="select-all-custom-${groupName}" class="select-all-custom-group">
                        <label for="select-all-custom-${groupName}">Select All</label>
                    </div>
                    <ul class="custom-group-load-cases-list">`;
                
                cases.forEach(caseName => {
                    const isChecked = selectedLoadCases.has(caseName) ? 'checked' : '';
                    html += `<li>
                        <input type="checkbox" name="load_case_values" value="${caseName}" class="custom-group-case-checkbox" data-group="${groupName}" ${isChecked}>
                        ${caseName}
                    </li>`;
                });
                
                html += '</ul></div>';
            }
            
            html += '</form>';
        } else {
            html += '<p>No custom groups found</p>';
        }
        loadCasesResults.innerHTML = html;

        // Add select all functionality for custom groups
        document.querySelectorAll('.select-all-custom-group').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const groupName = this.id.replace('select-all-custom-', '');
                const caseCheckboxes = document.querySelectorAll(`.custom-group-case-checkbox[data-group="${groupName}"]`);
                caseCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedLoadCases.add(cb.value);
                    } else {
                        selectedLoadCases.delete(cb.value);
                    }
                });
                updateSelectedLoadCases();
            });
        });

        // Add edit functionality - FIXED: Use current structureId
        document.querySelectorAll('.edit-group').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const groupName = this.dataset.group;
                const groupElement = this.closest('.load-case-group');
                const displayElement = groupElement.querySelector('.group-name-display');
                const editForm = groupElement.querySelector('.group-edit-form');
                
                // Show edit form, hide display
                displayElement.style.display = 'none';
                this.style.display = 'none';
                groupElement.querySelector('.delete-group').style.display = 'none';
                editForm.style.display = 'block';
            });
        });

        document.querySelectorAll('.cancel-edit').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const groupName = this.dataset.group;
                const groupElement = this.closest('.load-case-group');
                const displayElement = groupElement.querySelector('.group-name-display');
                const editForm = groupElement.querySelector('.group-edit-form');
                
                // Hide edit form, show display
                editForm.style.display = 'none';
                displayElement.style.display = 'inline';
                groupElement.querySelector('.edit-group').style.display = 'inline-block';
                groupElement.querySelector('.delete-group').style.display = 'inline-block';
            });
        });

        document.querySelectorAll('.save-edit').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const oldGroupName = this.dataset.group;
                const newGroupName = this.closest('.group-edit-form').querySelector('.edit-group-input').value.trim();
                
                if (!newGroupName) {
                    alert('Group name cannot be empty');
                    return;
                }
                
                if (newGroupName === oldGroupName) {
                    // Just cancel if name didn't change
                    this.closest('.group-edit-form').querySelector('.cancel-edit').click();
                    return;
                }
                
                const formData = new FormData();
                formData.append('update_custom_group', 'true');
                formData.append('old_group_name', oldGroupName);
                formData.append('new_group_name', newGroupName);
                
                // Make structure_id optional - only include if available
                const currentStructureId = structureSelect.value;
                if (currentStructureId) {
                    formData.append('structure_id', currentStructureId);
                }
                
                fetch('/hupload1/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the UI
                        const groupElement = this.closest('.load-case-group');
                        groupElement.querySelector('.group-name-display').textContent = newGroupName;
                        groupElement.querySelector('.edit-group').dataset.group = newGroupName;
                        groupElement.querySelector('.delete-group').dataset.group = newGroupName;
                        groupElement.querySelector('.save-edit').dataset.group = newGroupName;
                        groupElement.querySelector('.cancel-edit').dataset.group = newGroupName;
                        
                        // Also update all checkboxes in this group
                        groupElement.querySelectorAll('.custom-group-case-checkbox').forEach(cb => {
                            cb.dataset.group = newGroupName;
                        });
                        
                        // Update the group ID
                        groupElement.id = `group-${newGroupName.replace(/\s+/g, '-')}`;
                        
                        // Update select-all checkbox ID if it exists
                        const selectAllCheckbox = groupElement.querySelector('.select-all-custom-group');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.id = `select-all-custom-${newGroupName}`;
                            const selectAllLabel = groupElement.querySelector('label[for="select-all-custom-' + oldGroupName + '"]');
                            if (selectAllLabel) {
                                selectAllLabel.setAttribute('for', `select-all-custom-${newGroupName}`);
                            }
                        }
                        
                        // Hide edit form
                        groupElement.querySelector('.group-edit-form').style.display = 'none';
                        groupElement.querySelector('.group-name-display').style.display = 'inline';
                        groupElement.querySelector('.edit-group').style.display = 'inline-block';
                        groupElement.querySelector('.delete-group').style.display = 'inline-block';
                        
                    } else {
                        alert('Error updating group: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error updating group: ' + error);
                });
            });
        });

        // Add event listener for individual checkbox changes in custom groups
        document.querySelectorAll('.custom-group-case-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedLoadCases.add(this.value);
                } else {
                    selectedLoadCases.delete(this.value);
                    // Uncheck select-all if any checkbox is unchecked
                    const groupName = this.dataset.group;
                    const selectAll = document.getElementById(`select-all-custom-${groupName}`);
                    if (selectAll) {
                        selectAll.checked = false;
                    }
                }
                updateSelectedLoadCases();
            });
        });

        // Add delete functionality - FIXED: Use current structureId
        document.querySelectorAll('.delete-group').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const groupName = this.dataset.group;
                if (confirm(`Are you sure you want to delete the group "${groupName}"?`)) {
                    // Get the current structure ID directly from the select element
                    const currentStructureId = structureSelect.value;
                    if (!currentStructureId) {
                        alert('Please select a structure first');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('delete_custom_group', 'true');
                    formData.append('structure_id', currentStructureId); // Use current value
                    formData.append('group_name', groupName);
                    
                    fetch('/hupload1/', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the group from UI without refreshing
                            this.closest('.load-case-group').remove();
                            // If no groups left, show message
                            if (!document.querySelector('.load-case-group')) {
                                loadCasesResults.innerHTML = '<p>No custom groups found</p>';
                            }
                        } else {
                            alert('Error deleting group: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error deleting group: ' + error);
                    });
                }
            });
        });
    })
    .catch(error => {
        loadCasesResults.innerHTML = `<div class="error">Error loading data: ${error}</div>`;
    });
});


        // Handle Create Custom Group button
        createCustomGroupBtn.addEventListener('click', function() {
            const structureId = structureSelect.value;
            const groupName = customGroupNameInput.value.trim();
            
            if (!structureId) {
                alert('Please select a structure first');
                return;
            }
            
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }
            
            if (selectedLoadCases.size === 0) {
                alert('Please select at least one load case');
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('create_custom_group', 'true');
            formData.append('structure_id', structureId);
            formData.append('group_name', groupName);
            selectedLoadCases.forEach(caseName => {
                formData.append('selected_cases', caseName);
            });
            
            // Send request
            fetch('/hupload1/', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Custom group "${groupName}" created successfully!`);
                    customGroupNameInput.value = '';
                    clearAllSelections();  // <-- clear selections and checkboxes
                } else {
                    alert('Error creating custom group: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error creating custom group: ' + error);
            });
        });




        // Handle form submissions
        setPhaseForm.addEventListener('submit', function(e) {
            const structureId = structureSelect.value;
            if (!structureId) {
                e.preventDefault();
                alert('Please select a structure first');
                return;
            }
            
            if (selectedLoadCases.size === 0) {
                e.preventDefault();
                alert('Please select at least one load case');
                return;
            }
            
            document.getElementById('structure-id-input').value = structureId;
            document.getElementById('load-case-values-input').value = Array.from(selectedLoadCases).join(',');
        });

        jointLabelsForm.addEventListener('submit', function(e) {
            const structureId = structureSelect.value;
            if (!structureId) {
                e.preventDefault();
                alert('Please select a structure first');
                return;
            }
            
            if (selectedLoadCases.size === 0) {
                e.preventDefault();
                alert('Please select at least one load case');
                return;
            }
            
            document.getElementById('structure-id-input-joint').value = structureId;
            document.getElementById('load-case-values-input-joint').value = Array.from(selectedLoadCases).join(',');
        });

        // Auto-hide messages
        setTimeout(function() {
            const messages = document.querySelectorAll('.alert');
            messages.forEach(function(message) {
                message.style.transition = 'opacity 0.5s ease-out';
                message.style.opacity = '0';
                setTimeout(function() {
                    message.remove();
                }, 500);
            });
        }, 3000); 
    });
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const structureId = '{{ structure_id }}';
    
    // File input handling
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    
    if (fileInput && fileName) {
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
            } else {
                fileName.textContent = 'No file chosen';
            }
        });
    }
    
    // Auto-load data if structure is selected and file exists
    if (structureId && {{ existing_file|yesno:"true,false" }}) {
        const structureSelect = document.getElementById('structure-select');
        if (structureSelect) {
            // Trigger change to load data immediately
            setTimeout(() => {
                structureSelect.dispatchEvent(new Event('change'));
            }, 500);
        }
    }
});
</script>


    {% endblock %}





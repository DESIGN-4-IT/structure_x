

def hdeadend1(request):
    if request.method == 'POST':
        form = HDeadendForm1(request.POST)
        if form.is_valid():
            try:
                form.save()
                return HttpResponseRedirect('/hupload1/')  # Redirect after successful save
            except IntegrityError:
                form.add_error('structure', 'Data already added for this structure.')
        # if error: fall through to render form with errors

    else:
        form = HDeadendForm1()

    return render(request, 'app1/hdeadend1.html', {'form': form})


def h_deadend_view1(request):
    h = HDeadend1.objects.all()
    return render(request, 'app1/h_deadend_view1.html', {'h': h})


class HDeadendForm1(forms.ModelForm):
    class Meta:
        model = HDeadend1
        fields = ['structure', 'num_3_phase_circuits', 'num_shield_wires', 'num_1_phase_circuits', 'num_communication_cables']

    def __init__(self, *args, **kwargs):
        super(HDeadendForm1, self).__init__(*args, **kwargs)
        self.fields['structure'].empty_label = "Select Structure"

        # Show only structures that don't already have a TowerDeadend
        used_structures = HDeadend1.objects.values_list('structure', flat=True)
        self.fields['structure'].queryset = ListOfStructure.objects.exclude(id__in=used_structures)
        
class HDeadend1(models.Model):
    CIRCUIT_CHOICES = [(i, str(i)) for i in range(1, 11)]

    structure = models.ForeignKey('ListOfStructure', on_delete=models.CASCADE, related_name='h_deadends1', unique=True)

    num_3_phase_circuits = models.PositiveIntegerField(choices=CIRCUIT_CHOICES)
    num_shield_wires = models.PositiveIntegerField(choices=CIRCUIT_CHOICES)
    num_1_phase_circuits = models.PositiveIntegerField(choices=CIRCUIT_CHOICES)
    num_communication_cables = models.PositiveIntegerField(choices=CIRCUIT_CHOICES)

    def __str__(self):
        return f"HDeadend {self.id} - Structure: {self.structure}"
    
    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['structure'], name='unique_h_per_structure1')
        ]

hdeadend1.html 

{% extends "app1/base.html" %}
{% load static %}  <!-- Load static here too for good measure -->

{% block title %}Home - KOmatrix LoadView{% endblock %}

{% block extra_css %}

    <link rel="stylesheet" href="styles.css">
    <style>
    

        /* Main Content Styling */
        .content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 90px 20px 20px; /* Top padding adjusted to leave space for fixed header */
            background: linear-gradient(to right,rgb(247, 248, 248),rgb(234, 252, 252));
            min-height: 100vh;
        }

        /* Form Styling */
        .form-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 40px 30px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease;
        }

        .form-container h2 {
            text-align: center;
            font-size: 25px;
            margin-bottom: 22px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f5f7fa;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #4facfe;
            background-color: #ffffff;
            outline: none;
        }

        /* Buttons */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .save-button, .view-button {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }

        .save-button {
            background-color: #4CAF50;
            color: white;
        }

        .view-button {
            background-color: #1252a7;
            color: white;
            text-decoration: none;
        }

        .save-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .view-button:hover {
            background-color: #2259a2ff;
            transform: translateY(-2px);
        }

        /* Fade-in Animation */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }


        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 10px 10px; /* Rounded only at the bottom */
            text-align: center;
            width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            position: relative;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden; /* Ensures content does not overflow */
        }
        
        .popup .popup-header {
            background-color: #ffec00;
            color: black;
            font-size: 12px;
            padding: 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0px 0px 0 0;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            width: calc(100% + 40px);  /* Ensure it covers full width */
            margin: -20px -20px 0 -20px;  /* Remove gaps and extend header to popup edges */
            box-sizing: border-box;  /* Prevent overflow beyond the container */
        }
        
        
        .popup-close {
            position: absolute;
            top: 10%;
            right: 1px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 30px;
            color: black;
            background-color: transparent;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .popup h3 {
            margin: 20px 0;
            font-size: 14px;
            color: black;
        }
        
        .popup .popup-btn {
            padding: 10px 15px; /* Increase padding for better button size */
            margin: 15px 30px;  /* Increase the margin between buttons */
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 20px;
            color: white;
            transition: background-color 0.3s ease;
        }
        
        .popup-btn.blue {
            background-color: #1252a7;
        }
        
        .popup-btn.green {
            background-color: green;
        }
        
        .popup-btn.red {
            background-color: red;
        }
        
        .popup-btn.yellow {
            background-color: yellow;
            color: black;
        }
        
        .popup-btn:hover {
            opacity: 0.9;
        }
        
        .blur {
            filter: blur(0.3spx);
        }
        
        
    </style>

{% endblock %}

{% block content %}
   
    
    <div class="content">
        <div class="form-container">
            <h2>Circuit Definition</h2>
            <form method="POST" id="monopole-form">
                {% csrf_token %}
                <div class="form-group">
                    <label>Select Structure</label>
                    {{ form.structure }}
                    {% if form.structure.errors %}
                        <div class="error-message">
                            {% for error in form.structure.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label>Define number of 3 - phase circuits</label>
                    {{ form.num_3_phase_circuits }}
                </div>
                <div class="form-group">
                    <label>Define number of shield wires associated with each other</label>
                    {{ form.num_shield_wires }}
                </div>
                <div class="form-group">
                    <label>Define number of 1 - phase circuits</label>
                    {{ form.num_1_phase_circuits }}
                </div>
                <div class="form-group">
                    <label>Define number of communication cables</label>
                    {{ form.num_communication_cables }}
                </div>
                <button class="save-button" type="submit">Save</button>
                <a href="{% url 'h_deadend_view1' %}" class="view-button">View</a>
            </form>
        </div>
    </div>
    
    
  {% endblock %}

{% block extra_js %}


<script>
    document.addEventListener("DOMContentLoaded", function() {
        const saveButton = document.querySelector(".save-button");
    
        saveButton.addEventListener("click", function() {
            // Redirect to the upload1 page
            window.location.href = '/hupload1/';
        });
    });
        
</script>
    
  {% endblock %}


***************************88

hupload1

def hupload1(request):
    if request.method == 'POST':
        # Handle file upload form
        if 'file' in request.FILES:
            form = HUDeadendForm1(request.POST, request.FILES)
            if form.is_valid():
                try:
                    uploaded_file = form.save()
                    
                    # Extract load cases from the uploaded file
                    extract_load_cases(uploaded_file)
                    
                    messages.success(request, 'File uploaded successfully!')
                    return redirect('hupload1')
                except IntegrityError:
                    form.add_error('structure', 'A file has already been uploaded for this structure.')
        # Handle the Go button POST request
        elif 'go_button' in request.POST:
            button_type = request.POST.get('go_button')
            load_case_values = request.POST.get('load_case_values', '')
            
            # Convert comma-separated string to list
            if load_case_values:
                load_cases = [case.strip() for case in load_case_values.split(',') if case.strip()]
            else:
                load_cases = []
                
            selected_values = {
                'button_type': button_type,  # Store which button was clicked
                'load_cases': load_cases,
                'structure_id': request.POST.get('structure_id')
            }
            request.session['selected_values'] = selected_values
            return redirect('hdata1')
    else:
        form = HUDeadendForm1()

    structures_with_files = ListOfStructure.objects.filter(huploaded_files1__isnull=False).distinct()

    # Handle AJAX requests for data
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        structure_id = request.GET.get('structure_id')
        if not structure_id:
            return JsonResponse({'error': 'Structure ID is required'}, status=400)

        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            latest_file = hUploadedFile1.objects.filter(structure=structure).latest('uploaded_at')
            df = pd.read_excel(latest_file.file.path, engine='openpyxl')

            if request.GET.get('get_set_phase'):
                # Process set/phase data
                set_phase_data = df[['Set No.', 'Phase No.']].dropna().drop_duplicates()
                data = set_phase_data.to_dict('records')
                columns = {'Set No.': 'Set No.', 'Phase No.': 'Phase No.'}
                return JsonResponse({'data': data, 'columns': columns})

            elif request.GET.get('get_joint_labels'):
                # Process joint labels
                joint_labels = df['Attach. Joint Labels'].dropna().unique().tolist()
                return JsonResponse({'values': joint_labels})
                
            elif request.GET.get('get_load_cases'):
                # Process load cases - extract unique load cases
                if 'Load Case Description' in df.columns:
                    load_cases = df['Load Case Description'].dropna().unique().tolist()
                    return JsonResponse({'values': load_cases})
                else:
                    return JsonResponse({'error': 'Load Case Description column not found'}, status=400)
                    
            elif request.GET.get('get_grouped_load_cases'):
                # Process grouped load cases
                if 'Load Case Description' in df.columns:
                    load_cases = df['Load Case Description'].dropna().unique().tolist()
                    
                    # Group load cases by their prefix (e.g., Hurricane, NESC, Rule)
                    grouped_cases = {}
                    for case in load_cases:
                        # Extract the prefix (first word before space)
                        if ' ' in case:
                            prefix = case.split(' ')[0]
                        else:
                            prefix = case
                            
                        if prefix not in grouped_cases:
                            grouped_cases[prefix] = []
                        grouped_cases[prefix].append(case)
                    
                    return JsonResponse({'groups': grouped_cases})
                else:
                    return JsonResponse({'error': 'Load Case Description column not found'}, status=400)

        except Exception as e:
            return JsonResponse({'error': str(e)}, status=500)

    return render(request, 'app1/hupload1.html', {
        'form': form,
        'structures_with_files': structures_with_files
    })


def extract_load_cases(uploaded_file):
    """Extract load cases from the uploaded Excel file and save to database"""
    try:
        # Delete existing load cases for this structure
        LoadCase.objects.filter(structure=uploaded_file.structure).delete()
        LoadCaseGroup.objects.filter(structure=uploaded_file.structure).delete()
        
        df = pd.read_excel(uploaded_file.file.path, engine='openpyxl')
        
        if 'Load Case Description' not in df.columns:
            return
            
        load_cases = df['Load Case Description'].dropna().unique().tolist()
        
        # Group load cases by their prefix
        grouped_cases = {}
        for case in load_cases:
            if ' ' in case:
                prefix = case.split(' ')[0]
            else:
                prefix = case
                
            if prefix not in grouped_cases:
                grouped_cases[prefix] = []
            grouped_cases[prefix].append(case)
        
        # Save to database
        for group_name, cases in grouped_cases.items():
            group = LoadCaseGroup.objects.create(
                name=group_name,
                structure=uploaded_file.structure
            )
            
            for case_name in cases:
                LoadCase.objects.create(
                    name=case_name,
                    group=group,
                    structure=uploaded_file.structure
                )
                
    except Exception as e:
        print(f"Error extracting load cases: {e}")


class HUDeadendForm1(forms.ModelForm):
    class Meta:
        model = hUploadedFile1
        fields = ('structure', 'file')

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        used_structures = hUploadedFile1.objects.values_list('structure_id', flat=True)
        self.fields['structure'].queryset = ListOfStructure.objects.exclude(id__in=used_structures)
        self.fields['structure'].empty_label = "Select Structure"

    def clean_file(self):
        uploaded_file = self.cleaned_data.get('file')
        ext = os.path.splitext(uploaded_file.name)[1].lower()
        if ext not in ['.xls', '.xlsx']:
            raise ValidationError("Only Excel files (.xls or .xlsx) are allowed.")
        return uploaded_file
    

class hUploadedFile1(models.Model):
    structure = models.ForeignKey(ListOfStructure, on_delete=models.CASCADE, related_name='huploaded_files1')
    file = models.FileField(upload_to='uploads/')
    uploaded_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.file.name} ({self.structure.structure})"

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['structure'], name='hunique_file_per_structure1')
            
        ]


hupload1.html


{% extends "app1/base.html" %}
{% load static %}  <!-- Load static here too for good measure -->

{% block title %}Home - KOmatrix LoadView{% endblock %}

{% block extra_css %}

    <link rel="stylesheet" href="styles.css">
    <style>
        

/* Main content wrapper */
.content {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    margin-top: 80px;
    min-height: calc(100vh - 80px);
}

/* Form container */
.form-container {
    background-color: #fff;
    border: 1px solid #e1e4e8;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    width: 90%;
    max-width: 800px;
    transition: all 0.3s ease;
}

/* Heading */
h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #1252a7;
    font-weight: 600;
    font-size: 28px;
}

h3, h4, h5 {
    color: #2c3e50;
    margin-bottom: 15px;
}

/* Upload section layout */
.upload-section {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

/* Upload box style */
.upload-box {
    padding: 25px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    text-align: center;
    background-color: #fafafa;
    width: 100%;
    max-width: 500px;
    transition: all 0.3s ease;
}

.upload-box:hover {
    border-color: #1252a7;
    background-color: #f8f9ff;
}

.upload-box p {
    margin: 12px 0;
    font-weight: 500;
    color: #444;
}

/* File input fields */
.upload-box input[type="file"], 
.upload-box select,
.form-control {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 15px;
    transition: border-color 0.3s;
}

.upload-box input[type="file"]:focus, 
.upload-box select:focus,
.form-control:focus {
    border-color: #1252a7;
    outline: none;
    box-shadow: 0 0 0 3px rgba(18, 82, 167, 0.1);
}

/* Attachment section */
.attachment-section {
    background-color: #f9f9d8;
    padding: 20px;
    margin-top: 30px;
    text-align: center;
    border-radius: 8px;
    font-weight: 500;
    border-left: 4px solid #e6c229;
}

/* Buttons section */
.buttons {
    display: flex;
    justify-content: space-around;
    margin-top: 25px;
    flex-wrap: wrap;
    gap: 15px;
    position: relative;
}

.buttons::before {
    content: "OR";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 0 10px;
    color: #666;
    font-weight: 500;
    z-index: 1;
}

.buttons::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #ddd;
    z-index: 0;
}

/* Upload button */
.upload-button {
    margin-top: 20px;
    width: 100%;
    background-color: #1252a7;
    color: white;
    padding: 12px 0;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.upload-button:hover {
    background-color: #0e4285;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.upload-button:active {
    transform: translateY(0);
}

/* Success message styling */
.messages {
    position: fixed;
    top: 80px;
    left: 0;
    right: 0;
    z-index: 1000;
    display: flex;
    justify-content: center;
    pointer-events: none;
}

.alert {
    padding: 15px 25px;
    border-radius: 8px;
    margin: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideDown 0.5s ease-out;
    pointer-events: auto;
    max-width: 90%;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Go button styling */
.set-phase-button, .attachments-button {
    flex: 1;
    min-width: 180px;
    background-color: #1252a7;
    color: white;
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 2;
}

.attachments-button {
    background-color: #00b32d;
}

.set-phase-button:hover {
    background-color: #0e4285;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.attachments-button:hover {
    background-color: #028a27;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.set-phase-button:active, .attachments-button:active {
    transform: translateY(0);
}

/* Load Cases Section */
.load-cases-section {
    margin-top: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e1e4e8;
}

.load-case-links {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.load-case-link {
    display: inline-block;
    padding: 10px 20px;
    background-color: #f0f0f0;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: all 0.3s;
}

.load-case-link:hover {
    background-color: #e0e0e0;
    transform: translateY(-2px);
}

.load-case-link.active {
    background-color: #1252a7;
    color: white;
    border-color: #1252a7;
}

#load-cases-results {
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e1e4e8;
}

.load-cases-list, .group-load-cases-list {
    list-style-type: none;
    padding-left: 0;
}

.load-cases-list li, .group-load-cases-list li {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.load-cases-list li:hover, .group-load-cases-list li:hover {
    background-color: #f0f4f8;
}

.load-case-group {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    background: white;
}

.load-case-group h5 {
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    color: #1252a7;
}

.group-select-all {
    margin-bottom: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Selected Load Cases */
.selected-load-cases {
    margin-top: 25px;
    padding: 20px;
    background: #e8f4ff;
    border-radius: 8px;
    border: 1px solid #c3d9f8;
}

.selected-case {
    display: inline-block;
    margin: 5px;
    padding: 8px 15px;
    background: white;
    border-radius: 20px;
    border: 1px solid #c3d9f8;
    position: relative;
}

.remove-case {
    margin-left: 8px;
    cursor: pointer;
    color: #ff4757;
    font-weight: bold;
}

.remove-case:hover {
    color: #ff2e43;
}

/* Data tables */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.data-table th, .data-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
}

.data-table th {
    background-color: #f2f2f2;
    font-weight: 600;
}

.joint-labels-list {
    list-style-type: none;
    padding: 0;
}

.joint-labels-list li {
    padding: 12px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.joint-labels-list li:hover {
    background-color: #f9f9f9;
}

.error {
    color: #ff4757;
    margin-top: 10px;
    padding: 10px;
    background: #ffeaea;
    border-radius: 6px;
    border-left: 4px solid #ff4757;
}

/* Form elements styling */
input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .content {
        padding: 15px;
        margin-top: 70px;
    }
    
    .form-container {
        width: 100%;
        padding: 20px;
    }
    
    .upload-box {
        padding: 20px;
    }
    
    .buttons {
        flex-direction: column;
        gap: 15px;
    }

    .set-phase-button, .attachments-button {
        width: 100%;
    }
    
    .attachment-section {
        padding: 15px;
    }
    
    .buttons::before, .buttons::after {
        display: none;
    }
    
    .load-case-links {
        flex-direction: column;
    }
    
    .load-case-link {
        text-align: center;
    }
    
    h2 {
        font-size: 24px;
    }
}

@media (max-width: 480px) {
    .content {
        padding: 10px;
        margin-top: 60px;
    }
    
    .form-container {
        padding: 15px;
    }
    
    .upload-box {
        padding: 15px;
    }
    
    .upload-button {
        padding: 10px 0;
    }
    
    .set-phase-button, .attachments-button {
        padding: 12px;
        font-size: 15px;
    }
    
    .alert {
        padding: 12px 20px;
        font-size: 14px;
    }
}

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 10px 10px; /* Rounded only at the bottom */
            text-align: center;
            width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            position: relative;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden; /* Ensures content does not overflow */
        }
        
        .popup .popup-header {
            background-color: #ffec00;
            color: black;
            font-size: 12px;
            padding: 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0px 0px 0 0;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            width: calc(100% + 40px);  /* Ensure it covers full width */
            margin: -20px -20px 0 -20px;  /* Remove gaps and extend header to popup edges */
            box-sizing: border-box;  /* Prevent overflow beyond the container */
        }
        
        
        .popup-close {
            position: absolute;
            top: 10%;
            right: 1px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 30px;
            color: black;
            background-color: transparent;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .popup h3 {
            margin: 20px 0;
            font-size: 14px;
            color: black;
        }
        
        .popup .popup-btn {
            padding: 10px 15px; /* Increase padding for better button size */
            margin: 15px 30px;  /* Increase the margin between buttons */
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 20px;
            color: white;
            transition: background-color 0.3s ease;
        }
        
        .popup-btn.blue {
            background-color: #1252a7;
        }
        
        .popup-btn.green {
            background-color: green;
        }
        
        .popup-btn.red {
            background-color: red;
        }
        
        .popup-btn.yellow {
            background-color: yellow;
            color: black;
        }
        
        .popup-btn:hover {
            opacity: 0.9;
        }
        
        .blur {
            filter: blur(0.3spx);
        }
       
        
        
        
    </style>
{% endblock %}

{% block content %}
    
    
<div class="content">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="form-container">
        <h2>File Upload</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="upload-section">
                <div class="upload-box">
                    <p>Select Structure</p>
                    {{ form.structure }}

                    <p>Drag files to upload</p>
                    <input type="file" name="file" accept=".xls,.xlsx" required>

                    <button type="submit" class="upload-button">Upload File</button>
                </div>
            </div>
        </form>

        <div class="attachment-section">
            <p>Select Structure to Extract Data</p>
            <select id="structure-select" class="form-control">
                <option value="">-- Select Structure --</option>
                {% for structure in structures_with_files %}
                <option value="{{ structure.id }}">{{ structure.structure }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- New Load Cases Section -->
        <div class="load-cases-section" style="margin-top: 20px; display: none;" id="load-cases-section">
            <h3>Load Cases</h3>
            <div class="load-case-links">
                <a href="#" id="imported-load-cases-link" class="load-case-link">Imported Load Cases</a>
                <a href="#" id="group-load-cases-link" class="load-case-link">Group Load Cases</a>
            </div>
            
            <div id="load-cases-results" style="margin-top: 20px;">
                <!-- Load cases results will be displayed here -->
            </div>
        </div>

        <div class="selected-load-cases" id="selected-load-cases" style="margin-top: 20px; display: none;">
            <h4>Selected Load Cases:</h4>
            <div id="selected-cases-list"></div>
        </div>

        <div class="buttons">
    <form id="set-phase-form" method="post" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="structure_id" id="structure-id-input">
        <input type="hidden" name="go_button" value="set_phase">
        <input type="hidden" name="load_case_values" id="load-case-values-input">
        <button type="submit" class="set-phase-button">Set / Phase</button>
    </form>

    <form id="joint-labels-form" method="post" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="structure_id" id="structure-id-input-joint">
        <input type="hidden" name="go_button" value="joint_labels">
        <input type="hidden" name="load_case_values" id="load-case-values-input-joint">
        <button type="submit" class="attachments-button">Attachments Joint Labels</button>
    </form>
</div>

        <div id="results-container" style="margin-top: 20px;">
            <!-- Results will be displayed here -->
        </div>

        <!-- Hidden form for submitting -->
        <form id="hidden-form" method="post" style="display: none;">
            {% csrf_token %}
            <input type="hidden" name="structure_id" id="structure-id-input">
            <input type="hidden" name="go_button" value="1">
        </form>
    </div>
</div>



    {% endblock %}

{% block extra_js %}

    <script>
        // Get the popup overlay and popups
        const monopolePopupOverlay = document.getElementById('monopole-popup-overlay');
        const monopolePopup1 = document.getElementById('monopole-popup1');
        const monopolePopup2 = document.getElementById('monopole-popup2'); // Add more popups as needed
    
        // Initialize a stack to keep track of opened popups
        let popupStack = [];
    
        // Function to show a popup
        function showPopup(popup) {
            monopolePopupOverlay.style.display = 'flex'; // Show the popup overlay
            popup.style.display = 'block'; // Show the specified popup
            popupStack.push(popup); // Push the popup to the stack
        }
    
        // Function to close the current popup
        function closePopup() {
            const currentPopup = popupStack.pop(); // Remove the current popup from the stack
            if (currentPopup) {
                currentPopup.style.display = 'none'; // Hide the current popup
            }
            
            if (popupStack.length > 0) {
                const previousPopup = popupStack[popupStack.length - 1]; // Get the previous popup
                previousPopup.style.display = 'block'; // Show the previous popup
            } else {
                monopolePopupOverlay.style.display = 'none'; // Hide the overlay if no popups left
            }
        }
    
    
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const structureSelect = document.getElementById('structure-select');
        const setPhaseButton = document.getElementById('set-phase-button');
        const jointLabelsButton = document.getElementById('joint-labels-button');
        const structureIdInput = document.getElementById('structure-id-input');
        const loadCasesSection = document.getElementById('load-cases-section');
        const importedLoadCasesLink = document.getElementById('imported-load-cases-link');
        const groupLoadCasesLink = document.getElementById('group-load-cases-link');
        const loadCasesResults = document.getElementById('load-cases-results');

        const selectedLoadCases = new Set();
        const selectedLoadCasesSection = document.getElementById('selected-load-cases');
        const selectedCasesList = document.getElementById('selected-cases-list');
        const loadCaseValuesInput = document.getElementById('load-case-values-input');
        const loadCaseValuesInputJoint = document.getElementById('load-case-values-input-joint');
        const setPhaseForm = document.getElementById('set-phase-form');
        const jointLabelsForm = document.getElementById('joint-labels-form');

        // Show load cases section when a structure is selected
        structureSelect.addEventListener('change', function() {
            if (this.value) {
                loadCasesSection.style.display = 'block';
            } else {
                loadCasesSection.style.display = 'none';
                loadCasesResults.innerHTML = '';
            }
        });

        function updateSelectedLoadCases() {
        if (selectedLoadCases.size > 0) {
            selectedLoadCasesSection.style.display = 'block';
            selectedCasesList.innerHTML = '';
            
            selectedLoadCases.forEach(caseName => {
                const caseElement = document.createElement('div');
                caseElement.className = 'selected-case';
                caseElement.innerHTML = `
                    ${caseName}
                    <span class="remove-case" data-case="${caseName}">×</span>
                `;
                selectedCasesList.appendChild(caseElement);
            });
            
            // Add remove event listeners
            document.querySelectorAll('.remove-case').forEach(btn => {
                btn.addEventListener('click', function() {
                    const caseName = this.dataset.case;
                    selectedLoadCases.delete(caseName);
                    updateSelectedLoadCases();
                });
            });
        } else {
            selectedLoadCasesSection.style.display = 'none';
        }
    
        // Update hidden inputs
        loadCaseValuesInput.value = Array.from(selectedLoadCases).join(',');
        loadCaseValuesInputJoint.value = Array.from(selectedLoadCases).join(',');
    }

        // Handle Imported Load Cases link click
        importedLoadCasesLink.addEventListener('click', function(e) {
    e.preventDefault();
    const structureId = structureSelect.value;
    if (!structureId) {
        alert('Please select a structure first');
        return;
    }

    fetch(`/hupload1/?get_load_cases=true&structure_id=${structureId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            loadCasesResults.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        let html = '<h4>Imported Load Cases</h4>';
        if (data.values && data.values.length > 0) {
            html += '<form id="load-cases-form">';
            html += '<ul class="load-cases-list">';
            data.values.forEach(caseName => {
                const isChecked = selectedLoadCases.has(caseName) ? 'checked' : '';
                html += `<li>
                    <input type="checkbox" name="load_case_values" value="${caseName}" ${isChecked}>
                    ${caseName}
                </li>`;
            });
            html += '</ul>';
            html += '</form>';
        } else {
            html += '<p>No load cases found</p>';
        }
        loadCasesResults.innerHTML = html;

        // Add event listener for checkbox changes
        document.querySelectorAll('#load-cases-form input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedLoadCases.add(this.value);
                } else {
                    selectedLoadCases.delete(this.value);
                }
                updateSelectedLoadCases();
            });
        });

    })
    .catch(error => {
        loadCasesResults.innerHTML = `<div class="error">Error loading data: ${error}</div>`;
    });
});

// Replace the group load cases click handler
groupLoadCasesLink.addEventListener('click', function(e) {
    e.preventDefault();
    const structureId = structureSelect.value;
    if (!structureId) {
        alert('Please select a structure first');
        return;
    }

    fetch(`/hupload1/?get_grouped_load_cases=true&structure_id=${structureId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            loadCasesResults.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        let html = '<h4>Group Load Cases</h4>';
        if (data.groups && Object.keys(data.groups).length > 0) {
            html += '<form id="grouped-load-cases-form">';
            
            for (const [groupName, cases] of Object.entries(data.groups)) {
                html += `<div class="load-case-group">
                    <h5>${groupName}</h5>
                    <div class="group-select-all">
                        <input type="checkbox" id="select-all-${groupName}" class="select-all-group">
                        <label for="select-all-${groupName}">Select All</label>
                    </div>
                    <ul class="group-load-cases-list">`;
                
                cases.forEach(caseName => {
                    const isChecked = selectedLoadCases.has(caseName) ? 'checked' : '';
                    html += `<li>
                        <input type="checkbox" name="load_case_values" value="${caseName}" class="group-case-checkbox" data-group="${groupName}" ${isChecked}>
                        ${caseName}
                    </li>`;
                });
                
                html += '</ul></div>';
            }
            
            html += '</form>';
        } else {
            html += '<p>No grouped load cases found</p>';
        }
        loadCasesResults.innerHTML = html;

        // Add select all functionality
        document.querySelectorAll('.select-all-group').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const groupName = this.id.replace('select-all-', '');
                const caseCheckboxes = document.querySelectorAll(`.group-case-checkbox[data-group="${groupName}"]`);
                caseCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedLoadCases.add(cb.value);
                    } else {
                        selectedLoadCases.delete(cb.value);
                    }
                });
                updateSelectedLoadCases();
            });
        });

        // Add event listener for individual checkbox changes
        document.querySelectorAll('.group-case-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedLoadCases.add(this.value);
                } else {
                    selectedLoadCases.delete(this.value);
                    // Uncheck select-all if any checkbox is unchecked
                    const groupName = this.dataset.group;
                    const selectAll = document.getElementById(`select-all-${groupName}`);
                    if (selectAll) {
                        selectAll.checked = false;
                    }
                }
                updateSelectedLoadCases();
            });
        });
        
    })
    .catch(error => {
        loadCasesResults.innerHTML = `<div class="error">Error loading data: ${error}</div>`;
    });
});

setPhaseForm.addEventListener('submit', function(e) {
    const structureId = structureSelect.value;
    if (!structureId) {
        e.preventDefault();
        alert('Please select a structure first');
        return;
    }
    
    if (selectedLoadCases.size === 0) {
        e.preventDefault();
        alert('Please select at least one load case');
        return;
    }
    
    document.getElementById('structure-id-input').value = structureId;
    document.getElementById('load-case-values-input').value = Array.from(selectedLoadCases).join(',');
    console.log("Submitting load cases:", Array.from(selectedLoadCases).join(',')); // Debug
});

jointLabelsForm.addEventListener('submit', function(e) {
    const structureId = structureSelect.value;
    if (!structureId) {
        e.preventDefault();
        alert('Please select a structure first');
        return;
    }
    
    if (selectedLoadCases.size === 0) {
        e.preventDefault();
        alert('Please select at least one load case');
        return;
    }
    
    document.getElementById('structure-id-input-joint').value = structureId;
    document.getElementById('load-case-values-input-joint').value = Array.from(selectedLoadCases).join(',');
    console.log("Submitting load cases:", Array.from(selectedLoadCases).join(',')); // Debug
});

        // Handle Set/Phase button click
        setPhaseButton.addEventListener('click', function() {
            const structureId = structureSelect.value;
            if (!structureId) {
                alert('Please select a structure first');
                return;
            }
            
            // Set structure ID and submit
            structureIdInput.value = structureId;
            document.getElementById('hidden-form').submit();
        });

        // Handle Joint Labels button click
        jointLabelsButton.addEventListener('click', function() {
            const structureId = structureSelect.value;
            if (!structureId) {
                alert('Please select a structure first');
                return;
            }
            
            // Set structure ID and submit
            structureIdInput.value = structureId;
            document.getElementById('hidden-form').submit();
        });
    });

    setTimeout(function() {
        const messages = document.querySelectorAll('.alert');
        messages.forEach(function(message) {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
            }, 500);
        });
    }, 3000); 
</script>

    {% endblock %}


********************************************88

hdata1

def hdata1(request):
    # Get selected values from session
    selected_values = request.session.get('selected_values', {})
    structure_id = selected_values.get('structure_id')
    button_type = selected_values.get('button_type', '')
    selected_load_cases = selected_values.get('load_cases', [])
    
    # If coming directly from buttons without specific filters
    if not structure_id and 'go_button' in request.POST:
        structure_id = request.POST.get('structure_id')
        button_type = request.POST.get('go_button')
        load_case_values = request.POST.get('load_case_values', '')
        
        # Convert comma-separated string to list
        if load_case_values:
            selected_load_cases = [case.strip() for case in load_case_values.split(',') if case.strip()]
        else:
            selected_load_cases = []
            
        if structure_id:
            selected_values = {
                'structure_id': structure_id,
                'button_type': button_type,
                'load_cases': selected_load_cases
            }
            request.session['selected_values'] = selected_values
    
    if structure_id:
        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            latest_file = hUploadedFile1.objects.filter(structure=structure).latest('uploaded_at')
            df = pd.read_excel(latest_file.file.path, engine='openpyxl')

            # Filter by selected load cases if any are selected
            if selected_load_cases and 'Load Case Description' in df.columns:
                print(f"Filtering by load cases: {selected_load_cases}")  # Debug print
                # Filter the dataframe to include only selected load cases
                df = df[df['Load Case Description'].isin(selected_load_cases)]
                print(f"Filtered dataframe shape: {df.shape}")  # Debug print

            # Prepare complete data for table display - include ALL columns
            load_data = []
            for _, row in df.iterrows():
                row_data = {}
                # Add all columns from the dataframe
                for col in df.columns:
                    if pd.notna(row[col]):
                        # Convert numeric values to appropriate types
                        if pd.api.types.is_numeric_dtype(df[col]):
                            row_data[col] = float(row[col])
                        else:
                            row_data[col] = str(row[col])
                    else:
                        row_data[col] = '' if pd.api.types.is_string_dtype(df[col]) else 0
                load_data.append(row_data)

            # Get unique values for display based on filtered data
            joint_labels = [str(label) for label in df['Attach. Joint Labels'].unique()] if 'Attach. Joint Labels' in df.columns else []
            set_numbers = [str(num) for num in df['Set No.'].dropna().unique()] if 'Set No.' in df.columns else []
            phase_numbers = [str(num) for num in df['Phase No.'].dropna().unique()] if 'Phase No.' in df.columns else []

        except Exception as e:
            joint_labels = []
            set_numbers = []
            phase_numbers = []
            load_data = []
            print(f"Error processing Excel file: {str(e)}")
    else:
        joint_labels = []
        set_numbers = []
        phase_numbers = []
        load_data = []

    return render(request, 'app1/hdata1.html', {
        'joint_labels': joint_labels,
        'set_numbers': set_numbers,
        'phase_numbers': phase_numbers,
        'load_data': load_data,
        'load_data_json': json.dumps(load_data),
        'selected_values': selected_values,
        'all_columns': list(df.columns) if structure_id and 'df' in locals() else [],
        'button_type': button_type
    })
    
import math
import json
from django.shortcuts import render

def calculation_view(request):
    if request.method == 'GET':
        # Get calculation data from request parameters
        calculation_data_json = request.GET.get('calculation_data')
        
        if calculation_data_json:
            try:
                calculation_data = json.loads(calculation_data_json)
                
                # Add resultant calculation to each record
                for record in calculation_data:
                    vert = float(record.get('Structure Loads Vert. (lbs)', 0) or 0)
                    trans = float(record.get('Structure Loads Trans. (lbs)', 0) or 0)
                    long = float(record.get('Structure Loads Long. (lbs)', 0) or 0)
                    
                    # Calculate SQRT(Vert² + Trans² + Long²) for each record
                    resultant = math.sqrt(vert**2 + trans**2 + long**2)
                    record['Resultant (lbs)'] = round(resultant, 2)
                
                # Group data by Set No. (for display purposes)
                grouped_data = {}
                for record in calculation_data:
                    set_no = record.get('Set No.', 'Unknown')
                    if set_no not in grouped_data:
                        grouped_data[set_no] = []
                    grouped_data[set_no].append(record)
                
                # Calculate max values for each set (optional, if still needed)
                set_max_values = {}
                for set_no, records in grouped_data.items():
                    vert_values = [float(record.get('Structure Loads Vert. (lbs)', 0) or 0) for record in records]
                    trans_values = [float(record.get('Structure Loads Trans. (lbs)', 0) or 0) for record in records]
                    long_values = [float(record.get('Structure Loads Long. (lbs)', 0) or 0) for record in records]
                    
                    set_max_values[set_no] = {
                        'max_vert': max(vert_values),
                        'max_trans': max(trans_values),
                        'max_long': max(long_values),
                        'count': len(records)
                    }
                
                # Calculate combined values across all sets (optional, if still needed)
                combined_vert = sum([values['max_vert'] for values in set_max_values.values()])
                combined_trans = sum([values['max_trans'] for values in set_max_values.values()])
                combined_long = sum([values['max_long'] for values in set_max_values.values()])
                
                # Calculate the SQRT formula for combined values (optional)
                combined_sqrt = math.sqrt(combined_vert**2 + combined_trans**2 + combined_long**2)
                
                # Prepare context for template
                context = {
                    'grouped_data': grouped_data,
                    'set_max_values': set_max_values,
                    'combined_vert': combined_vert,
                    'combined_trans': combined_trans,
                    'combined_long': combined_long,
                    'combined_sqrt': combined_sqrt,
                    'calculation_data': calculation_data
                }
                
                return render(request, 'app1/calculation.html', context)
                
            except json.JSONDecodeError:
                error = 'Invalid calculation data format'
        else:
            error = 'No calculation data provided'
    
    return render(request, 'app1/calculation.html', {'error': error or 'An error occurred during calculation'})


hdata1.html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Page</title>


{% load static %}  <!-- Load static here too for good measure -->

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<!-- Load dependencies -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   

    <style>
       
        :root {
            /* Primary Colors */
            --primary-blue: #4976b5ff;  /* Deepened primary blue */
            --dark-blue: #0d3a7a;
            --light-blue: #e1eaf5;
            --middle-blue:#1252a7;
            
            /* Accent Colors */
            --accent-yellow: #ffc107;
            --dark-yellow: #e6a800;
            --light-yellow: #fff8e6;
            
            /* Background Colors */
            --bg-light: #f8fafc;
            --bg-medium: #f0f4f8;
            --bg-dark: #e1e8ed;
            
            /* Text Colors */
            --text-dark: #2d3748;
            --text-medium: #4a5568;
            --text-light: #718096;
            
            /* UI Colors */
            --ui-white: #ffffff;
            --ui-light: #edf2f7;
            --ui-medium: #e2e8f0;
            --ui-dark: #cbd5e0;
            
            /* Status Colors */
            --success: #38a169;
            --warning: #dd6b20;
            --error: #e53e3e;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            
            /* Transitions */
            --transition-fast: all 0.15s ease;
            --transition-normal: all 0.3s ease;
            --transition-slow: all 0.5s ease;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            /* Spacing */
            --space-xs: 2.95rem;
            --space-sm: 0.5rem;

            --space-smm: 0.8rem;
            --space-mdd: 2rem;

            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            box-shadow: var(--shadow-lg);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            padding: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-md);
            height: 60px;
            position: relative; /* Added for better positioning control */
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            flex: 1; /* Allow it to take available space */
        }

        .logo img {
            height: 36px;
            width: auto;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
            margin-top:2px;
        }

        .header-title {
            color: var(--accent-yellow);
            font-size: 1.25rem;
            font-weight: 600;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Main Navigation */
        .main-nav {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the navigation */
            flex: 2; /* Take more space to help with centering */
        }


        .menu {
            display: flex;
            list-style: none;
            gap: var(--space-xs);
            justify-content: center; /* Center menu items */
            width: 100%; /* Take full width of its container */
        }

        .menu-item {
            position: relative;
        }

        .menu-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: var(--space-sm) var(--space-md); /* Increased padding */
            display: block;
            font-weight: 500;
            transition: var(--transition-fast);
            border-radius: var(--radius-sm);
            font-size: 1.1rem;
            position: relative;
            margin-top:7px;
        }

        .menu-link:hover, 
        .menu-item:hover .menu-link {
            color: var(--ui-white);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .menu-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background-color: var(--accent-yellow);
            transition: var(--transition-fast);
        }

        .menu-item:hover .menu-link::after {
            width: 60%;
        }
   

        .menu-item:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
        }


        /* Search Bar */
        .search {
            position: relative;
            display: flex;
            justify-content: flex-end; /* Push search to the right */
            flex: 1; /* Allow it to take available space */
            margin-left:100px;
        }
        .search-input {
            padding: var(--space-sm) var(--space-md) var(--space-sm) 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            width: 200px;
            transition: var(--transition-normal);
            font-size: 0.9rem;
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--ui-white);
            backdrop-filter: blur(5px);
            padding:5px;
            margin-top:-5px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-yellow);
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
            width: 250px;
            background-color: rgba(255, 255, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
        }

        .search-highlight {
            background-color: rgba(255, 193, 7, 0.3);
            border-radius: 2px;
        }
        
  :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
        --success-color: #28a745;
        --warning-color: #ffc107;
    }
    
    .container {
        max-width: 98%;
        margin: 0 auto;
        padding: 15px;
        background-color: white;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
    }
    
    h3 {
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #eee;
        font-weight: 600;
        font-size: 1.5rem;
    }
    
    /* Layout adjustments */
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -10px;
    }
    
    .col-md-4, .col-md-8 {
        padding: 0 10px;
        box-sizing: border-box;
    }
    
    /* Left column (controls) - reduced width */
    .col-md-4 {
        width: 30%;
        flex: 0 0 30%;
        max-width: 30%;
    }
    
    /* Right column (canvas) - increased width */
    .col-md-8 {
        width: 70%;
        flex: 0 0 70%;
        max-width: 70%;
    }
    
    @media (max-width: 1200px) {
        .col-md-4 {
            width: 35%;
            flex: 0 0 35%;
            max-width: 35%;
        }
        
        .col-md-8 {
            width: 65%;
            flex: 0 0 65%;
            max-width: 65%;
        }
    }
    
    @media (max-width: 992px) {
        .col-md-4, .col-md-8 {
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
            margin-bottom: 20px;
        }
        
        .container {
            padding: 12px;
        }
    }
    
    /* Form Elements */
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-color);
        font-size: 14px;
    }
    
    select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: white;
        font-size: 14px;
        transition: border-color 0.3s;
    }
    
    select:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    select option {
        padding: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    select option:hover {
        background-color: #f0f0f0;
    }
    
    .calculation-btn {
        margin: 15px 0;
        padding: 10px 18px;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .calculation-btn:hover:not(:disabled) {
        background-color: #2980b9;
    }
    
    .calculation-btn:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
    }
    
    .selected-count {
        margin-left: 12px;
        font-weight: bold;
        color: var(--primary-color);
        background: #f1f8ff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
    }

    /* Load Display Table - full width when below */
    #load-display {
        background-color: var(--light-gray);
        padding: 18px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-top: 20px;
        width: 100%;
    }
    
    #load-display h5 {
        margin-top: 0;
        color: var(--secondary-color);
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-top: 15px;
        width: 100%;
    }
    
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 0;
        font-size: 13px;
    }
    
    .table th {
        background-color: #e9ecef;
        font-weight: 600;
        position: sticky;
        top: 0;
        padding: 10px 8px;
        border: 1px solid var(--border-color);
        font-size: 13px;
    }
    
    .table td {
        padding: 8px;
        border: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .table th:first-child,
    .table td:first-child {
        text-align: center;
        width: 40px;
    }
    
    .table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .table tr:hover {
        background-color: rgba(52, 152, 219, 0.05);
    }
    
    /* Checkbox styling */
    .record-checkbox {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }
    
    /* Drag and Drop Feedback */
    option[draggable="true"] {
        cursor: grab;
    }
    
    option[draggable="true"]:active {
        cursor: grabbing;
    }
    
    model-viewer {
        --poster-color: transparent;
    }
    
    .table tr.highlight {
        animation: highlight 1.5s;
    }

    @keyframes highlight {
        0% { background-color: rgba(255, 220, 0, 0.5); }
        100% { background-color: transparent; }
    }
    
    .checkbox-list {
        max-height: 220px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 10px;
        border-radius: 6px;
        background: white;
        margin-bottom: 0;
    }
    
    .checkbox-list label {
        display: block;
        cursor: move;
        padding: 6px;
        margin-bottom: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
        font-size: 13px;
    }
    
    .checkbox-list label:hover {
        background-color: #f0f8ff;
    }
    
    .model-viewer-container {
        width: 100%;
        height: 550px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #joint-markers-container, 
    #set-markers-container, 
    #phase-markers-container,
    #load-displays-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }
    
    .joint-marker {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.85);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        transform: translate(-50%, -50%);
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        cursor: move;
        user-select: none;
        pointer-events: auto;
        z-index: 5;
        transition: all 0.2s;
    }
    
    .joint-marker:hover {
        background-color: white;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    
    .set-marker {
        background-color: rgba(0, 0, 255, 0.15);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 255, 0.5);
        font-size: 12px;
        font-weight: 600;
        color: #0000aa;
    }
    
    .phase-marker {
        background-color: rgba(0, 255, 0, 0.15);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid rgba(0, 128, 0, 0.5);
        font-size: 12px;
        font-weight: 600;
        color: #006600;
    }
    
    .drag-item {
        display: block;
        padding: 6px 8px;
        margin: 4px 0;
        cursor: move;
        background-color: var(--light-gray);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 13px;
    }
    
    .drag-item:hover {
        background-color: #e9ecef;
        transform: translateX(3px);
    }
    
    .drag-item:active {
        cursor: grabbing;
    }

    .load-display {
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        width: 200px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
        pointer-events: auto;
    }
    
    .load-display-header {
        font-weight: 600;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--primary-color);
        font-size: 14px;
    }
    
    .load-display-content div {
        margin-bottom: 6px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
    }
    
    .editable {
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 3px;
        transition: background-color 0.2s;
        min-width: 50px;
        text-align: right;
    }
    
    .editable:hover {
        background-color: #f0f0f0;
    }
    
    .close-btn {
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        color: #999;
        transition: color 0.2s;
    }
    
    .close-btn:hover {
        color: var(--accent-color);
    }
    
    .size-controls {
        position: absolute;
        top: 8px;
        right: 30px;
        display: flex;
        gap: 5px;
    }
    
    .size-btn {
        width: 22px;
        height: 22px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s;
    }
    
    .size-btn:hover {
        background: #e9ecef;
    }
    
    .value-edit {
        width: 60px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px;
        text-align: right;
    }
    
    /* Mobile optimizations */
    @media (max-width: 992px) {
        .container {
            padding: 10px;
        }
        
        h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .model-viewer-container {
            height: 450px;
        }
        
        .load-display {
            width: 180px;
            padding: 10px;
            font-size: 13px;
        }
        
        .calculation-btn {
            width: 100%;
            margin: 10px 0;
        }
        
        .selected-count {
            display: block;
            margin: 10px 0;
            text-align: center;
        }
        
        .table th, 
        .table td {
            padding: 8px 6px;
            font-size: 12px;
        }
        
        .checkbox-list {
            max-height: 200px;
        }
        
        #load-display {
            padding: 15px;
        }
    }
    
    @media (max-width: 768px) {
        .model-viewer-container {
            height: 400px;
        }
        
        .load-display {
            width: 160px;
            padding: 8px;
            font-size: 12px;
        }
        
        .table th, 
        .table td {
            padding: 6px 4px;
            font-size: 12px;
        }
        
        .joint-marker {
            font-size: 11px;
            padding: 3px 6px;
        }
        
        .checkbox-list {
            max-height: 180px;
        }
    }
    
    @media (max-width: 576px) {
        .model-viewer-container {
            height: 350px;
        }
        
        .load-display {
            width: 140px;
            padding: 6px;
            font-size: 11px;
        }
        
        .table th, 
        .table td {
            padding: 5px 3px;
            font-size: 11px;
        }
        
        .calculation-btn {
            font-size: 13px;
            padding: 8px 12px;
        }
        
        .selected-count {
            font-size: 12px;
            padding: 4px 8px;
        }
    }
    
    /* Loading state */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    /* Visual feedback for selections */
    input[type="checkbox"]:checked + span {
        font-weight: 600;
        color: var(--secondary-color);
    }
    
    /* Custom scrollbar for better aesthetics */
    .checkbox-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .checkbox-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .checkbox-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }
    
    .checkbox-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Section headers */
    .section-header {
        font-size: 15px;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid #eee;
    }
    
    /* Button group styling */
    .btn-container {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    </style>


</head>
<body>

    <header>
        <div class="navbar">
            <div class="logo-container">
                <div class="logo">
                    <a href="#"><img src="{% static 'app1/images/new_logo.png' %}" alt="Logo"></a>
                </div>
                <h1 class="header-title">KOmatrix LoadView</h1>
            </div>

            <nav class="main-nav">
            
                <ul class="menu" id="mainMenu">
                    
                    <li class="menu-item">
                        <a href="#" class="menu-link">About</a>
                    </li>

                    <li class="menu-item">
                        <a href="{% url 'home' %}" class="menu-link">Services</a>
                       
                    </li>
                   
                    <li class="menu-item">
                        <a href="#" class="menu-link">Contact Us</a>
                    </li>

                    <li class="menu-item">
                        <a href="#" class="menu-link">Help</a>
                    </li>
                </ul>

                <div class="search">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search..." id="searchInput">
                </div>
            </nav>
        </div>
    </header>

<div class="container">
    <h3>OVERHEAD LOAD DESIGN CRITERIA</h3>
    
    <div class="row">
        <!-- Left side - Selection Options (reduced width) -->
        <div class="col-md-4">
            {% if button_type == 'joint_labels' %}
            <!-- Show only joint labels section when joint labels button was clicked -->
            <div class="form-group">
                <label for="joint-labels">Attachment Joint Labels:</label>
                <div class="checkbox-list" id="joint-labels">
                    {% for label in joint_labels %}
                        <label draggable="true" class="drag-item" data-type="joint" data-value="{{ label }}">
                            <input type="checkbox" name="joint-labels" value="{{ label }}"> {{ label }}
                        </label>
                    {% endfor %}
                </div>
            </div>
            {% elif button_type == 'set_phase' %}
            <!-- Show only set/phase sections when set/phase button was clicked -->
            <div class="form-group">
                <label for="set-numbers">Set No.:</label>
                <div class="checkbox-list" id="set-numbers">
                    {% for num in set_numbers %}
                        <label draggable="true" class="drag-item" data-type="set" data-value="{{ num }}">
                            <input type="checkbox" name="set-numbers" value="{{ num }}"> {{ num }}
                        </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="phase-numbers">Phase No.:</label>
                <div class="checkbox-list" id="phase-numbers">
                    {% for num in phase_numbers %}
                        <label draggable="true" class="drag-item" data-type="phase" data-value="{{ num }}">
                            <input type="checkbox" name="phase-numbers" value="{{ num }}"> {{ num }}
                        </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right side - 3D Model Viewer (increased width) -->
        <div class="col-md-8">
            <div class="model-viewer-container">
                <canvas id="model-canvas"></canvas>
                <div id="joint-markers-container"></div>
                <div id="set-markers-container"></div>
                <div id="phase-markers-container"></div>
                <div id="load-displays-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Load Display Table - now placed below and full width -->
    <div id="load-display">
        <h5>Load Values</h5>
        <div class="btn-container">
            <button id="calculate-btn" class="calculation-btn" disabled>
                <span>Calculate Selected Records</span>
            </button>
            <span id="selected-count" class="selected-count">0 selected</span>
        </div>
        <div class="table-container">
            <table class="table table-bordered" id="load-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        {% for column in all_columns %}
                            <th>{{ column }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>



<!-- Include Three.js library -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>



<script>
    // Load data passed from Django
    const loadData = JSON.parse('{{ load_data_json|escapejs }}');
    
    // Three.js variables
    let scene, camera, renderer, model, controls;
    const jointMarkers = {};
    const selectedJoints = new Set();
    const loadDisplays = {};
    const setMarkers = {};
    const phaseMarkers = {};
    const selectedSets = new Set();
    const selectedPhases = new Set();
    let activeJoint = null;
    const selectedRecords = new Set();
    let allTableData = [];

    
    // Initialize the 3D model viewer
    function initModelViewer() {
        // Create scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        
        // Create camera
        camera = new THREE.PerspectiveCamera(75, 800 / 600, 0.1, 1000);
        camera.position.set(5, 5, 5);
        
        // Create renderer
        const canvas = document.getElementById('model-canvas');
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);
        
        // Add controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
        
        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);
        
        // Load GLB model
        const loader = new THREE.GLTFLoader();
        loader.load(
            "{% static 'app1/images/tower3d.glb' %}",
            function (gltf) {
                model = gltf.scene;
                scene.add(model);
                
                // Center the model
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                
                // Auto-rotate
                model.rotation.y = Math.PI / 4;
                
                // Start animation loop
                animate();
            },
            undefined,
            function (error) {
                console.error('Error loading model:', error);
            }
        );
        
        // Handle window resize
        window.addEventListener('resize', onWindowResize);
    }
    
    // Add a marker for a joint on the 3D model
    function addJointMarker(jointLabel) {
        if (jointMarkers[jointLabel]) return; // Already exists
        
        // Find the load data for this joint
        const jointLoadData = loadData.find(item => item['Attach. Joint Labels'] === jointLabel);
        if (!jointLoadData) return;
        
        // Create a marker (smaller and without red dot)
        const geometry = new THREE.SphereGeometry(0.02, 16, 16); // Much smaller
        const material = new THREE.MeshBasicMaterial({ color: 0x333333 });
        const sphere = new THREE.Mesh(geometry, material);
        
        // Position the marker (you'll need to adjust this based on your model)
        sphere.position.set(
            (Math.random() - 0.5) * 2,
            Math.random() * 2,
            (Math.random() - 0.5) * 2
        );
        
        // Add label (HTML overlay)
        const markerDiv = document.createElement('div');
        markerDiv.className = 'joint-marker';
        markerDiv.textContent = jointLabel;
        markerDiv.style.position = 'absolute';
        markerDiv.style.cursor = 'move';
        markerDiv.style.pointerEvents = 'auto';
        markerDiv.dataset.jointLabel = jointLabel;
        document.getElementById('joint-markers-container').appendChild(markerDiv);
        
        // Click handler for the marker
        markerDiv.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleLoadDisplay(jointLabel);
        });
        
        // Store references
        jointMarkers[jointLabel] = {
            mesh: sphere,
            div: markerDiv,
            loadData: jointLoadData,
            isDragging: false,
            fontSize: 12 // Default font size
        };
        
        scene.add(sphere);
        updateMarkerPosition(sphere, markerDiv);
        
        // Make marker draggable
        makeJointDraggable(markerDiv, jointLabel);
    }
    

    
    // Toggle load display visibility
    function toggleLoadDisplay(jointLabel) {
        if (loadDisplays[jointLabel]) {
            // Hide if already showing
            removeLoadDisplay(jointLabel);
            activeJoint = null;
        } else {
            // Show if hidden
            addLoadDisplay(jointLabel, jointMarkers[jointLabel].mesh.position);
            activeJoint = jointLabel;
            
            // Hide any other active displays
            Object.keys(loadDisplays).forEach(label => {
                if (label !== jointLabel) {
                    removeLoadDisplay(label);
                }
            });
        }
    }
    
    // Make joint marker draggable
    function makeJointDraggable(element, jointLabel) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        element.onmousedown = dragMouseDown;
        
        function dragMouseDown(e) {
            e.preventDefault();
            e.stopPropagation();
            
            jointMarkers[jointLabel].isDragging = true;
            
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }
        
        function elementDrag(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            // Set the element's new position
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
            
            // Update the 3D position
            update3DPositionFromScreen(jointLabel, parseInt(element.style.left), parseInt(element.style.top));
            
            // Update load display position if visible
            if (loadDisplays[jointLabel]) {
                updateLoadDisplayPosition(
                    loadDisplays[jointLabel].div, 
                    jointMarkers[jointLabel].mesh.position
                );
            }
        }

    
    function closeDragElement() {
            jointMarkers[jointLabel].isDragging = false;
            // Stop moving when mouse button is released
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    
    // Update 3D position from screen coordinates
    function update3DPositionFromScreen(jointLabel, x, y) {
        const vector = new THREE.Vector3(
            (x / renderer.domElement.clientWidth) * 2 - 1,
            -(y / renderer.domElement.clientHeight) * 2 + 1,
            0.5
        );
        
        vector.unproject(camera);
        jointMarkers[jointLabel].mesh.position.copy(vector);
    }
    
    // Add load display for a joint
    function addLoadDisplay(jointLabel, position) {
        if (loadDisplays[jointLabel]) return; // Already exists
        
        const jointInfo = jointMarkers[jointLabel];
        if (!jointInfo) return;
        
        const displayDiv = document.createElement('div');
        displayDiv.className = 'load-display';
        displayDiv.dataset.jointLabel = jointLabel;
        displayDiv.style.position = 'absolute';
        displayDiv.style.pointerEvents = 'auto';
        
        displayDiv.innerHTML = `
            <div class="load-display-header">
                <span>${jointLabel}</span>
                <span class="close-btn" title="Remove">×</span>
            </div>
            <div class="load-display-content">
                <div>Vert: <span class="editable" data-field="vert">${jointInfo.loadData['Structure Loads Vert. (lbs)'] || '0'}</span> lbs</div>
                <div>Trans: <span class="editable" data-field="trans">${jointInfo.loadData['Structure Loads Trans. (lbs)'] || '0'}</span> lbs</div>
                <div>Long: <span class="editable" data-field="long">${jointInfo.loadData['Structure Loads Long. (lbs)'] || '0'}</span> lbs</div>
            </div>
            <div class="size-controls">
                <div class="size-btn" data-action="increase">+</div>
                <div class="size-btn" data-action="decrease">-</div>
            </div>
        `;
        
        document.getElementById('load-displays-container').appendChild(displayDiv);
        
        // Position the display
        updateLoadDisplayPosition(displayDiv, position);
        
        // Store reference
        loadDisplays[jointLabel] = {
            div: displayDiv,
            position: position
        };
        
        // Add close button event
        displayDiv.querySelector('.close-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            removeJointMarker(jointLabel);
            removeLoadDisplay(jointLabel);
            
            // Uncheck the checkbox
            const checkbox = document.querySelector(`input[value="${jointLabel}"]`);
            if (checkbox) {
                checkbox.checked = false;
                selectedJoints.delete(jointLabel);
                updateTable(Array.from(selectedJoints));
            }
        });
        
        // Add size control events
        displayDiv.querySelector('[data-action="increase"]').addEventListener('click', function(e) {
            e.stopPropagation();
            jointMarkers[jointLabel].fontSize = Math.min(24, jointMarkers[jointLabel].fontSize + 1);
            jointMarkers[jointLabel].div.style.fontSize = `${jointMarkers[jointLabel].fontSize}px`;
        });
        
        displayDiv.querySelector('[data-action="decrease"]').addEventListener('click', function(e) {
            e.stopPropagation();
            jointMarkers[jointLabel].fontSize = Math.max(8, jointMarkers[jointLabel].fontSize - 1);
            jointMarkers[jointLabel].div.style.fontSize = `${jointMarkers[jointLabel].fontSize}px`;
        });
        
        // Add editable fields (same as before)
        displayDiv.querySelectorAll('.editable').forEach(el => {
            el.addEventListener('click', function(e) {
                e.stopPropagation();
                const field = this.dataset.field;
                const currentValue = this.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'value-edit';
                input.value = currentValue;
                
                this.textContent = '';
                this.appendChild(input);
                input.focus();
                
                input.addEventListener('blur', function() {
                    const newValue = parseFloat(this.value) || 0;
                    const parent = this.parentElement;
                    parent.textContent = newValue;
                    parent.classList.add('editable');
                    
                    // Update the data
                    const jointLabel = parent.closest('.load-display').dataset.jointLabel;
                    const jointInfo = jointMarkers[jointLabel];
                    if (jointInfo) {
                        if (field === 'vert') {
                            jointInfo.loadData['Structure Loads Vert. (lbs)'] = newValue;
                        } else if (field === 'trans') {
                            jointInfo.loadData['Structure Loads Trans. (lbs)'] = newValue;
                        } else if (field === 'long') {
                            jointInfo.loadData['Structure Loads Long. (lbs)'] = newValue;
                        }
                    }
                    
                    // Update the table
                    updateTable(Array.from(selectedJoints));
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });
        });
        
        // Make the display draggable
        makeDraggable(displayDiv, jointLabel);
    }
    
    // Make load display draggable
    function makeDraggable(element, jointLabel) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        element.onmousedown = dragMouseDown;
        
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }
        
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            // Set the element's new position
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
            
            // Update the marker position reference
            if (loadDisplays[jointLabel]) {
                loadDisplays[jointLabel].position = getPositionFromScreen(
                    parseInt(element.style.left), 
                    parseInt(element.style.top)
                );
            }
        }
        
        function closeDragElement() {
            // Stop moving when mouse button is released
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    
    // Convert screen coordinates to 3D position
    function getPositionFromScreen(x, y) {
        const vector = new THREE.Vector3(
            (x / renderer.domElement.clientWidth) * 2 - 1,
            -(y / renderer.domElement.clientHeight) * 2 + 1,
            0.5
        );
        
        vector.unproject(camera);
        return vector;
    }
    
    // Remove load display
    function removeLoadDisplay(jointLabel) {
        if (!loadDisplays[jointLabel]) return;
        
        document.getElementById('load-displays-container').removeChild(loadDisplays[jointLabel].div);
        delete loadDisplays[jointLabel];
    }
    
    // Update HTML marker position based on 3D position
    function updateMarkerPosition(mesh, div) {
        const vector = mesh.position.clone();
        vector.project(camera);
        
        const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
        const y = (-(vector.y * 0.5) + 0.5) * renderer.domElement.clientHeight;
        
        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
    }
    
    // Update load display position based on 3D position
    function updateLoadDisplayPosition(div, position) {
        const vector = position.clone();
        vector.project(camera);
        
        const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
        const y = (-(vector.y * 0.5) + 0.5) * renderer.domElement.clientHeight;
        
        div.style.left = `${x + 20}px`; // Offset slightly from the marker
        div.style.top = `${y}px`;
    }
    
    // Remove a joint marker
    function removeJointMarker(jointLabel) {
        if (!jointMarkers[jointLabel]) return;
        
        scene.remove(jointMarkers[jointLabel].mesh);
        document.getElementById('joint-markers-container').removeChild(jointMarkers[jointLabel].div);
        delete jointMarkers[jointLabel];
    }
    
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        // Update marker positions
        for (const jointLabel in jointMarkers) {
            updateMarkerPosition(jointMarkers[jointLabel].mesh, jointMarkers[jointLabel].div);
            
            // Update load display positions if they exist
            if (loadDisplays[jointLabel]) {
                updateLoadDisplayPosition(
                    loadDisplays[jointLabel].div, 
                    jointMarkers[jointLabel].mesh.position
                );
            }
        }
        
        renderer.render(scene, camera);
    }
    
    function onWindowResize() {
        const container = document.getElementById('model-viewer');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
    
    // Clear table
    function clearTable() {
        document.getElementById('load-table').getElementsByTagName('tbody')[0].innerHTML = '';
    }


    function handleRecordSelection(e) {
    const index = parseInt(e.target.dataset.index);
    const record = allTableData[index];
    
    if (e.target.checked) {
        selectedRecords.add(record);
    } else {
        selectedRecords.delete(record);
    }
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCount = document.getElementById('selected-count');
    const calculateBtn = document.getElementById('calculate-btn');
    
    selectedCount.textContent = `${selectedRecords.size} selected`;
    calculateBtn.disabled = selectedRecords.size === 0;
}

// Add event listener for calculate button
// Update the calculate button event listener
document.getElementById('calculate-btn').addEventListener('click', function() {
    if (selectedRecords.size > 0) {
        // Prepare data for calculation - convert Set to Array
        const calculationData = Array.from(selectedRecords);
        
        // Create a form to submit the data
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = '/calculation/';
        form.target = '_blank';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'calculation_data';
        input.value = JSON.stringify(calculationData);
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
});
    
    // Update table with selected labels
function updateTable() {
    clearTable();
    const tbody = document.getElementById('load-table').getElementsByTagName('tbody')[0];
    
    // Get all column names from the table headers
    const columns = Array.from(document.querySelectorAll('#load-table thead th'))
        .map(th => th.textContent.trim())
        .filter(col => col !== 'Select'); // Exclude the Select column
    
    // Store all table data for later reference
    allTableData = [];
    
    // Add new rows from the filtered data
    loadData.forEach((item, index) => {
        const row = tbody.insertRow();
        allTableData.push(item); // Store reference to this data
        
        // Add checkbox cell
        const checkboxCell = row.insertCell();
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'record-checkbox';
        checkbox.dataset.index = index;
        checkbox.addEventListener('change', handleRecordSelection);
        checkboxCell.appendChild(checkbox);
        
        // Add cells for each column
        columns.forEach(column => {
            const cell = row.insertCell();
            cell.textContent = item[column] !== undefined ? item[column] : '';
        });
    });
    
    // Update selected count
    updateSelectedCount();

    // Only add joints if we're in joint labels mode and joints are selected
    {% if button_type == 'joint_labels' %}
    Array.from(selectedJoints).forEach(label => {
        const loadInfo = loadData.find(item => item['Attach. Joint Labels'] === label);
        if (loadInfo) {
            const newRow = tbody.insertRow();
            
            // Add cells for each column
            columns.forEach(column => {
                const cell = newRow.insertCell();
                cell.textContent = loadInfo[column] !== undefined ? loadInfo[column] : '';
            });
        }
    });
    {% endif %}
    
    // Only add sets if we're in set/phase mode and sets are selected
    {% if button_type == 'set_phase' %}
    Array.from(selectedSets).forEach(setNum => {
        // Find all rows with this set number
        const setData = loadData.filter(item => item['Set No.'] == setNum);
        
        if (setData.length > 0) {
            // Add a header row for the set
            const headerRow = tbody.insertRow();
            const headerCell = headerRow.insertCell();
            headerCell.colSpan = columns.length;
            headerCell.textContent = `Set ${setNum}`;
            headerCell.style.textAlign = 'center';
            headerCell.style.backgroundColor = '#e6f2ff';
            headerCell.style.fontWeight = 'bold';
            
            // Add all data rows for this set
            setData.forEach(item => {
                const row = tbody.insertRow();
                columns.forEach(column => {
                    const cell = row.insertCell();
                    cell.textContent = item[column] !== undefined ? item[column] : '';
                });
            });
        }
    });
    
    // Only add phases if we're in set/phase mode and phases are selected
    Array.from(selectedPhases).forEach(phaseNum => {
        // Find all rows with this phase number
        const phaseData = loadData.filter(item => item['Phase No.'] == phaseNum);
        
        if (phaseData.length > 0) {
            // Add a header row for the phase
            const headerRow = tbody.insertRow();
            const headerCell = headerRow.insertCell();
            headerCell.colSpan = columns.length;
            headerCell.textContent = `Phase ${phaseNum}`;
            headerCell.style.textAlign = 'center';
            headerCell.style.backgroundColor = '#e6ffe6';
            headerCell.style.fontWeight = 'bold';
            
            // Add all data rows for this phase
            phaseData.forEach(item => {
                const row = tbody.insertRow();
                columns.forEach(column => {
                    const cell = row.insertCell();
                    cell.textContent = item[column] !== undefined ? item[column] : '';
                });
            });
        }
    });
    {% endif %}
}

    
    // Set up event listeners
    function addMarker(itemType, itemValue) {
    if (itemType === 'joint') {
        if (jointMarkers[itemValue]) return;
        addJointMarker(itemValue);
    } 
    else if (itemType === 'set') {
        if (setMarkers[itemValue]) return;
        addSetMarker(itemValue);
    }
    else if (itemType === 'phase') {
        if (phaseMarkers[itemValue]) return;
        addPhaseMarker(itemValue);
    }
}

// Function to add a set marker
function addSetMarker(setNumber) {
    const geometry = new THREE.SphereGeometry(0.03, 16, 16);
    const material = new THREE.MeshBasicMaterial({ color: 0x0000ff }); // Blue for sets
    const sphere = new THREE.Mesh(geometry, material);
    
    // Position the marker
    sphere.position.set(
        (Math.random() - 0.5) * 2,
        Math.random() * 2,
        (Math.random() - 0.5) * 2
    );
    
    // Add label
    const markerDiv = document.createElement('div');
    markerDiv.className = 'set-marker';
    markerDiv.textContent = `Set ${setNumber}`;
    markerDiv.style.position = 'absolute';
    markerDiv.style.color = 'blue';
    markerDiv.dataset.setNumber = setNumber;
    document.getElementById('set-markers-container').appendChild(markerDiv);
    
    setMarkers[setNumber] = {
        mesh: sphere,
        div: markerDiv,
        isDragging: false
    };
    
    scene.add(sphere);
    updateMarkerPosition(sphere, markerDiv);
    makeDraggable(markerDiv, setNumber, 'set');
}

// Function to add a phase marker
function addPhaseMarker(phaseNumber) {
    const geometry = new THREE.SphereGeometry(0.03, 16, 16);
    const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 }); // Green for phases
    const sphere = new THREE.Mesh(geometry, material);
    
    // Position the marker
    sphere.position.set(
        (Math.random() - 0.5) * 2,
        Math.random() * 2,
        (Math.random() - 0.5) * 2
    );
    
    // Add label
    const markerDiv = document.createElement('div');
    markerDiv.className = 'phase-marker';
    markerDiv.textContent = `Phase ${phaseNumber}`;
    markerDiv.style.position = 'absolute';
    markerDiv.style.color = 'green';
    markerDiv.dataset.phaseNumber = phaseNumber;
    document.getElementById('phase-markers-container').appendChild(markerDiv);
    
    phaseMarkers[phaseNumber] = {
        mesh: sphere,
        div: markerDiv,
        isDragging: false
    };
    
    scene.add(sphere);
    updateMarkerPosition(sphere, markerDiv);
    makeDraggable(markerDiv, phaseNumber, 'phase');
}

    // Set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
    // Initialize 3D viewer
    initModelViewer();
    updateTable();

    // Handle checkbox changes for all types
    ['joint', 'set', 'phase'].forEach(type => {
        const container = document.getElementById(`${type}-${type === 'joint' ? 'labels' : 'numbers'}`);
        if (container) {
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const itemValue = this.value;
                    
                    if (type === 'joint') {
                        if (this.checked) {
                            selectedJoints.add(itemValue);
                            addMarker('joint', itemValue);
                        } else {
                            selectedJoints.delete(itemValue);
                            removeJointMarker(itemValue);
                        }
                    } 
                    else if (type === 'set') {
                        if (this.checked) {
                            selectedSets.add(itemValue);
                            addMarker('set', itemValue);
                        } else {
                            selectedSets.delete(itemValue);
                            if (setMarkers[itemValue]) {
                                scene.remove(setMarkers[itemValue].mesh);
                                document.getElementById('set-markers-container').removeChild(setMarkers[itemValue].div);
                                delete setMarkers[itemValue];
                            }
                        }
                    }
                    else if (type === 'phase') {
                        if (this.checked) {
                            selectedPhases.add(itemValue);
                            addMarker('phase', itemValue);
                        } else {
                            selectedPhases.delete(itemValue);
                            if (phaseMarkers[itemValue]) {
                                scene.remove(phaseMarkers[itemValue].mesh);
                                document.getElementById('phase-markers-container').removeChild(phaseMarkers[itemValue].div);
                                delete phaseMarkers[itemValue];
                            }
                        }
                    }
                    
                    updateTable();
                });
            });
        }
    });


        
        // Make labels draggable
         document.querySelectorAll('.drag-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('type', this.dataset.type);
            e.dataTransfer.setData('value', this.dataset.value);
            e.dataTransfer.effectAllowed = 'copy';
        });
    });
        
        // Set up drop zone on model viewer
        const modelCanvas = document.getElementById('model-canvas');
    modelCanvas.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    });
    
    modelCanvas.addEventListener('drop', function(e) {
        e.preventDefault();
        const itemType = e.dataTransfer.getData('type');
        const itemValue = e.dataTransfer.getData('value');
        
        // Find the corresponding checkbox and check it
        let checkbox;
        if (itemType === 'joint') {
            checkbox = document.querySelector(`input[name="joint-labels"][value="${itemValue}"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            }
        }
        else if (itemType === 'set') {
            checkbox = document.querySelector(`input[name="set-numbers"][value="${itemValue}"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            }
        }
        else if (itemType === 'phase') {
            checkbox = document.querySelector(`input[name="phase-numbers"][value="${itemValue}"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            }
        }
    });
});
        
       
</script>


{% comment %} this js is for header bar  {% endcomment %}
   
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchIcon = document.querySelector('.search-icon');
    
    // Debounce function to limit search frequency
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, wait);
        };
    }
    
    // Function to search and highlight only matching text
    function searchCurrentPage(term) {
        // Remove all previous highlights
        removeHighlights();
        
        if (!term.trim()) return;
        
        // Get only the main content area (exclude header and sidebar)
        const mainContent = document.querySelector('.main-content');
        
        // Create a regular expression for case-insensitive matching
        const regex = new RegExp(term, 'gi');
        
        // Walk through all text nodes in main content
        const walker = document.createTreeWalker(
            mainContent,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        let node;
        let found = false;
        
        while (node = walker.nextNode()) {
            // Skip empty nodes or nodes in script/style elements
            if (!node.nodeValue.trim() || 
                node.parentNode.tagName === 'SCRIPT' || 
                node.parentNode.tagName === 'STYLE') {
                continue;
            }
            
            const matches = node.nodeValue.match(regex);
            if (matches) {
                const span = document.createElement('span');
                span.className = 'search-highlight';
                
                // Replace each match with a highlighted span
                const newText = node.nodeValue.replace(regex, match => 
                    `<span class="search-highlight">${match}</span>`
                );
                
                // Create a temporary element to parse the HTML
                const temp = document.createElement('div');
                temp.innerHTML = newText;
                
                // Replace the text node with the new content
                const parent = node.parentNode;
                while (temp.firstChild) {
                    parent.insertBefore(temp.firstChild, node);
                }
                parent.removeChild(node);
                
                if (!found) {
                    // Scroll to first match
                    const firstHighlight = document.querySelector('.search-highlight');
                    if (firstHighlight) {
                        firstHighlight.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                        found = true;
                    }
                }
            }
        }
        
        if (!found && term.length > 0) {
            showNoResultsMessage(term);
        }
    }
    
    // Remove all highlights and restore original text
    function removeHighlights() {
        const highlights = document.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            parent.replaceChild(
                document.createTextNode(highlight.textContent),
                highlight
            );
            // Normalize to merge adjacent text nodes
            parent.normalize();
        });
        
        // Remove any existing "no results" message
        const existingMessage = document.getElementById('search-no-results');
        if (existingMessage) existingMessage.remove();
    }
    
    // Show temporary "no results" message
    function showNoResultsMessage(term) {
        const message = document.createElement('div');
        message.id = 'search-no-results';
        message.textContent = `No results found for "${term}"`;
        message.style.position = 'fixed';
        message.style.bottom = '20px';
        message.style.right = '20px';
        message.style.backgroundColor = 'var(--error)';
        message.style.color = 'white';
        message.style.padding = '10px 20px';
        message.style.borderRadius = 'var(--radius-md)';
        message.style.boxShadow = 'var(--shadow-md)';
        message.style.zIndex = '2000';
        message.style.animation = 'fadeIn 0.3s ease';
        
        document.body.appendChild(message);
        
        // Remove message after 3 seconds
        setTimeout(() => {
            message.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => message.remove(), 300);
        }, 3000);
    }
    
    // Add styles for highlighting
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .search-highlight {
            background-color: rgba(255, 193, 7, 0.5);
            border-radius: 2px;
            padding: 0 2px;
            color: #000;
        }
    `;
    document.head.appendChild(style);
    
    // Event listener with debounce
    searchInput.addEventListener('input', debounce(function(e) {
        const term = e.target.value.trim();
        searchCurrentPage(term);
        
        // Optional: If you want to also search server-side:
        if (term.length > 2) {
            fetch('/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: `search_term=${encodeURIComponent(term)}`
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server results:', data.results);
                // Handle server results if needed
            });
        }
    }, 300));
    
    // Click on search icon to focus input
    searchIcon.addEventListener('click', function() {
        searchInput.focus();
    });
    
    // Clear search when clicking Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            removeHighlights();
        }
    });
});
</script>

 </body>
</html>



calculation.html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculation Results</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
            --danger: #e74c3c;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        h3 {
            color: var(--primary);
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
        }

        h4 {
            color: var(--secondary);
            margin: 20px 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h4 i {
            color: var(--accent);
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 25px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f8ff;
        }

        .highlight {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }

        .resultant-cell {
            background-color: #fff3cd;
            font-weight: bold;
            color: #856404;
        }

        .result {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            color: var(--dark);
            display: inline-block;
        }

        .error {
            background-color: #ffebee;
            color: var(--danger);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            border-left: 4px solid var(--danger);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--dark);
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-primary {
            background-color: var(--primary);
            color: white;
        }

        .badge-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .set-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0 20px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a252f;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2980b9;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h2 {
                font-size: 1.8rem;
            }
            
            th, td {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .set-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media print {
            .action-buttons, footer {
                display: none;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h2><i class="fas fa-calculator"></i> Calculation Results</h2>
            <p>Detailed analysis of structural load calculations</p>
        </header>
        
        {% if error %}
            <div class="error">
                <i class="fas fa-exclamation-circle"></i> {{ error }}
            </div>
        {% else %}
            <div class="card">
                <h3><i class="fas fa-list-ol"></i> Selected Records Grouped by Set Number</h3>
                
                {% for set_no, records in grouped_data.items %}
                    <div class="set-container">
                        <div class="set-header">
                            <h4><i class="fas fa-cubes"></i> Set No. {{ set_no }} <span class="badge badge-primary">{{ records|length }} records</span></h4>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        {% for key in records.0.keys %}
                                            <th>{{ key }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in records %}
                                        <tr>
                                            {% for key, value in record.items %}
                                                {% if key == 'Resultant (lbs)' %}
                                                    <td class="resultant-cell">{{ value }}</td>
                                                {% else %}
                                                    <td>{{ value }}</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="result">
                            <i class="fas fa-chart-bar"></i> Max Values for Set {{ set_no }}:
                            {% for set_key, set_data in set_max_values.items %}
                                {% if set_key == set_no %}
                                    Vert = {{ set_data.max_vert|floatformat:2 }},
                                    Trans = {{ set_data.max_trans|floatformat:2 }},
                                    Long = {{ set_data.max_long|floatformat:2 }}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
            
            <div class="card">
                <h3><i class="fas fa-layer-group"></i> Combined Results</h3>
                
                <div class="stats-grid">
                    {% for set_no, values in set_max_values.items %}
                    <div class="stat-card">
                        <div class="stat-label">Set {{ set_no }}</div>
                        <div class="stat-value">{{ values.max_vert|floatformat:2 }}</div>
                        <div class="stat-label">Max Vert (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Set {{ set_no }}</div>
                        <div class="stat-value">{{ values.max_trans|floatformat:2 }}</div>
                        <div class="stat-label">Max Trans (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Set {{ set_no }}</div>
                        <div class="stat-value">{{ values.max_long|floatformat:2 }}</div>
                        <div class="stat-label">Max Long (lbs)</div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="table-container">
                    <table>
                        <tr>
                            <th>Set No.</th>
                            <th>Max Vert (lbs)</th>
                            <th>Max Trans (lbs)</th>
                            <th>Max Long (lbs)</th>
                        </tr>
                        {% for set_no, values in set_max_values.items %}
                        <tr>
                            <td>{{ set_no }}</td>
                            <td>{{ values.max_vert|floatformat:2 }}</td>
                            <td>{{ values.max_trans|floatformat:2 }}</td>
                            <td>{{ values.max_long|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="highlight">
                            <td><strong>Sum</strong></td>
                            <td><strong>{{ combined_vert|floatformat:2 }}</strong></td>
                            <td><strong>{{ combined_trans|floatformat:2 }}</strong></td>
                            <td><strong>{{ combined_long|floatformat:2 }}</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> Back to Home
                </button>
            </div>
        {% endif %}
        
        <footer>
            <p>Generated on {% now "F j, Y, g:i a" %} | Structural Analysis Tool</p>
        </footer>
    </div>
</body>
</html>




first read complete promt and act as experince developer 

so i wanted to apply same backend 


def mdeadend5(request):        # **************
    structure_id = request.GET.get('structure_id')
    structure_type = request.GET.get('structure_type')
    
    # DEBUG: Print session data at the start of circuit definition
    print(f"DEBUG [MDeadend5 Page] - Session data received:")    # **************
    print(f"  selected_structure_type: {request.session.get('selected_structure_type')}")
    print(f"  selected_structure_id: {request.session.get('selected_structure_id')}")
    print(f"  active_popups: {request.session.get('active_popups', [])}")
    print(f"  popup_selections: {request.session.get('popup_selections', {})}")
    print(f"  Query params - structure_type: {structure_type}, structure_id: {structure_id}")
    
    # Use session data if query params are missing
    if not structure_type and 'selected_structure_type' in request.session:
        structure_type = request.session['selected_structure_type']
    
    if not structure_id and 'selected_structure_id' in request.session:
        structure_id = request.session['selected_structure_id']
    
    # Initialize variables
    structure = None
    existing_data = False
    existing_circuit_data = None
    
    # Get structure object safely
    if structure_id:
        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            # Check if data already exists for this structure
            existing_data = MDeadend5.objects.filter(structure=structure).exists()   # **************
            
            # NEW: If data exists, get the latest record
            if existing_data:
                existing_circuit_data = MDeadend5.objects.filter(structure=structure).latest('id')  # **************
                print(f"DEBUG [Existing Data Found] - Found existing MonopoleDeadend data for structure ID: {structure_id}")  # **************
        except ListOfStructure.DoesNotExist:
            return redirect('home')
        except MDeadend5.DoesNotExist:         # *******************
            existing_circuit_data = None
            print(f"DEBUG [No Existing Data] - No MonopoleDeadend data found for structure ID: {structure_id}")  # **************
    
    # Handle Next button click
    if request.method == 'GET' and request.GET.get('next') == 'true':
        if structure_id and structure_type and existing_data:
            # Redirect to upload page
            return HttpResponseRedirect(f'/mupload5/?structure_id={structure_id}&structure_type={structure_type}')  # **************
        else:
            return redirect('home')
    
    if request.method == 'POST':
        # If data already exists, prevent saving new data
        if existing_data:
            return render(request, 'app1/mdeadend5.html', {   # *************
                'form': MDeadendForm5(instance=existing_circuit_data),    # *************
                'structure_type': structure_type,
                'selected_structure': structure,
                'structure_id': structure_id,
                'existing_data': existing_data,
                'session_popups': request.session.get('active_popups', []),
                'session_structure_type': request.session.get('selected_structure_type', ''),
                'session_circuit_definition': request.session.get('circuit_definition', {}),
            })
        
        form = MDeadendForm5(request.POST)     # ****************
        if form.is_valid():
            try:
                # Force the structure from URL parameter
                instance = form.save(commit=False)
                if structure:
                    instance.structure = structure
                instance.save()
                
                # Store structure info in session for upload page
                request.session['selected_structure_id'] = structure_id
                request.session['selected_structure_type'] = structure_type
                request.session['circuit_structure_id'] = instance.id
                
                # NEW: Store circuit definition data in session
                circuit_definition_data = {
                    'num_3_phase_circuits': form.cleaned_data.get('num_3_phase_circuits'),
                    'num_shield_wires': form.cleaned_data.get('num_shield_wires'),
                    'num_1_phase_circuits': form.cleaned_data.get('num_1_phase_circuits'),
                    'num_communication_cables': form.cleaned_data.get('num_communication_cables'),
                    'circuit_model': 'MDeadend5',    # **************
                    'circuit_id': instance.id,
                    'timestamp': time.time(),
                }
                
                # Store in session
                request.session['circuit_definition'] = circuit_definition_data
                
                # Debug: Print stored circuit definition data
                print(f"DEBUG [MDeadend5] - Stored in session:")    # *************
                print(f"  Circuit Definition Data: {circuit_definition_data}")
                
                # Debug: Print complete session data
                print(f"DEBUG [Complete Session - MDeadend5] - All session data:")   # **********
                print(f"  Structure Type: {request.session.get('selected_structure_type')}")
                print(f"  Structure ID: {request.session.get('selected_structure_id')}")
                print(f"  Active Popups: {request.session.get('active_popups', [])}")
                print(f"  Popup Selections: {request.session.get('popup_selections', {})}")
                print(f"  Circuit Definition: {request.session.get('circuit_definition', {})}")
                
                # Redirect directly to upload page after successful save
                return HttpResponseRedirect(f'/mupload5/?structure_id={structure_id}&structure_type={structure_type}')   # ****************
            except IntegrityError:
                form.add_error('structure', 'Data already added for this structure.')
            except Exception as e:
                form.add_error(None, f'Error saving data: {str(e)}')
        else:
            # Form is invalid - debug print errors
            print(f"DEBUG [MDeadend5 Form Errors] - Form validation failed:")  # **************
            for field, errors in form.errors.items():
                print(f"  {field}: {errors}")
    else:
        # GET request - create form
        if existing_data and existing_circuit_data:
            # NEW: If data exists, populate form with database data
            form = MDeadendForm5(instance=existing_circuit_data)   # **************
            
            # NEW: Also update session with existing database data
            circuit_definition_data = {
                'num_3_phase_circuits': existing_circuit_data.num_3_phase_circuits,
                'num_shield_wires': existing_circuit_data.num_shield_wires,
                'num_1_phase_circuits': existing_circuit_data.num_1_phase_circuits,
                'num_communication_cables': existing_circuit_data.num_communication_cables,
                'circuit_model': 'MDeadend5',               # *******************
                'circuit_id': existing_circuit_data.id,
                'timestamp': time.time(),
            }
            
            # Update session with existing database data
            request.session['circuit_definition'] = circuit_definition_data
            
            print(f"DEBUG [Existing Data Loaded] - Loaded existing data from database:")
            print(f"  Circuit Definition Data: {circuit_definition_data}")
        else:
            # Create empty form for new data
            form = MDeadendForm5()                # ***************
        
        # Debug: Print session state on GET request
        print(f"DEBUG [MDeadendForm5 GET Request] - Current session state:")   # ***************
        print(f"  Circuit Definition in session: {request.session.get('circuit_definition', 'Not set')}")

    return render(request, 'app1/mdeadend5.html', {     # ***************
        'form': form,
        'structure_type': structure_type,
        'selected_structure': structure,
        'structure_id': structure_id,
        'existing_data': existing_data,
        'session_popups': request.session.get('active_popups', []),
        'session_structure_type': request.session.get('selected_structure_type', ''),
        'session_circuit_definition': request.session.get('circuit_definition', {}),
    })



def mdeadend5_update(request, pk):                    # ***************
    hdeadend = get_object_or_404(MDeadend5, pk=pk)       # ***************

    selected_structure = hdeadend.structure
    structure_id = selected_structure.id

    # ✅ Correct: Always fetch TYPE from URL (same as create flow)
    structure_type = request.GET.get('structure_type') or request.session.get('selected_structure_type')

    if request.method == 'POST':
        form = MDeadend5FormUpdateForm(request.POST, instance=hdeadend)   # ***************
        if form.is_valid():
            try:
                form.save()

                # ✅ Save structure type correctly into session
                request.session['selected_structure_id'] = structure_id
                request.session['selected_structure_type'] = structure_type

                return HttpResponseRedirect(
                    f'/mupload5/?structure_id={structure_id}&structure_type={structure_type}'  # ***************
                )

            except Exception as e:
                form.add_error(None, f'Error updating record: {str(e)}')
    else:
        form = MDeadend5FormUpdateForm(instance=hdeadend)    # ***************

    return render(request, 'app1/mdeadend5_update.html', {    # ***************
        'form': form,
        'hdeadend': hdeadend,
        'structure_id': structure_id,
        'structure_type': structure_type,  # ✅ Pass correct type
    })


class TDeadend8(models.Model):             # **************
    CIRCUIT_CHOICES = [
        (0, "0"),
    ] + [(i, str(i)) for i in range(1, 11)]

    structure = models.ForeignKey(
        'ListOfStructure',
        on_delete=models.CASCADE,
        related_name='t_deadends8',             # **************
        unique=True
    )

    num_3_phase_circuits = models.PositiveIntegerField(choices=CIRCUIT_CHOICES, null=True, blank=True)
    num_shield_wires = models.PositiveIntegerField(choices=CIRCUIT_CHOICES, null=True, blank=True)
    num_1_phase_circuits = models.PositiveIntegerField(choices=CIRCUIT_CHOICES, null=True, blank=True)
    num_communication_cables = models.PositiveIntegerField(choices=CIRCUIT_CHOICES, null=True, blank=True)

    def __str__(self):
        return f"TowerDeadend {self.id} - Structure: {self.structure}"   # **************

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['structure'], name='unique_t_per_structure8')  # **************
        ]



class TDeadendForm8(forms.ModelForm):
    class Meta:
        model = TDeadend8                # *************** Here ***********
        fields = ['structure', 'num_3_phase_circuits', 'num_shield_wires', 'num_1_phase_circuits', 'num_communication_cables']

    def __init__(self, *args, **kwargs):
        super(TDeadendForm8, self).__init__(*args, **kwargs)          # *************** Here ***********
        self.fields['structure'].empty_label = "Select Structure"

        # Show only structures that don't already have a TowerDeadend
        used_structures = TDeadend8.objects.values_list('structure', flat=True)     # *************** Here ***********
        self.fields['structure'].queryset = ListOfStructure.objects.exclude(id__in=used_structures)


class TDeadend8FormUpdateForm(forms.ModelForm):   # here
    class Meta:
        model = TDeadend7   # here
        fields = ['structure', 'num_3_phase_circuits', 'num_shield_wires', 'num_1_phase_circuits', 'num_communication_cables']

    def __init__(self, *args, **kwargs):
        super(TDeadend7FormUpdateForm, self).__init__(*args, **kwargs)   # here
        self.fields['structure'].empty_label = "Select Structure"
        # Make structure field read-only for update
        self.fields['structure'].disabled = True


************************************************************


def mupload5(request):    # ***************
    structure_id = (
        request.GET.get('structure_id') or
        request.POST.get('structure_id') or
        request.session.get('selected_structure_id')
    )
    
    # Validate and sanitize structure_id
    if structure_id:
        try:
            structure_id = int(structure_id)
        except (ValueError, TypeError):
            structure_id = None
    
    # Fallback to session if still None
    if not structure_id:
        session_structure_id = request.session.get('selected_structure_id')
        if session_structure_id:
            try:
                structure_id = int(session_structure_id)
            except (ValueError, TypeError):
                structure_id = None
    
    # If still invalid, redirect (structure_id is required)
    if not structure_id:
        return redirect('home')
    
    structure_type = (
        request.GET.get('structure_type') or
        request.POST.get('structure_type') or
        request.session.get('selected_structure_type')
    )
    circuit_id = request.GET.get('circuit_id')
    
    # Debug loggin
    print(f"DEBUG [mupload5] - Received structure_id: {structure_id}")   # **************
    print(f"DEBUG [mupload5] - Received circuit_id: '{circuit_id}' (type: {type(circuit_id)})")  # **************
    
    # Check if circuit_id is the string 'null' or 'undefined'
    if circuit_id in ['null', 'undefined', 'None', '']:
        print(f"DEBUG [mupload5] - circuit_id is invalid string: '{circuit_id}', setting to None")   # **************
        circuit_id = None
    
    structure = None
    existing_file = False
    circuit_data_exists = False
    circuit_data = None
    
    if structure_id:
        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            
            # If circuit_id is None, try to get it from session
            if not circuit_id:
                print(f"DEBUG [mupload5] - No circuit_id in URL, checking session")  # **************
                # Check session for circuit_definition
                circuit_definition = request.session.get('circuit_definition')
                if circuit_definition and 'circuit_id' in circuit_definition:
                    circuit_id = circuit_definition.get('circuit_id')
                    print(f"DEBUG [mupload5] - Got circuit_id from session circuit_definition: {circuit_id}")   # **************
                
                # Check if we have a circuit_structure_id in session
                if not circuit_id and 'circuit_structure_id' in request.session:
                    circuit_id = request.session.get('circuit_structure_id')
                    print(f"DEBUG [mupload5] - Got circuit_id from circuit_structure_id: {circuit_id}")  # **************
                
                # Check if there's any MDeadend5 data for this structure
                if not circuit_id:
                    circuit_exists = MDeadend5.objects.filter(structure=structure).exists()  # *************
                    if circuit_exists:
                        circuit_data = MDeadend5.objects.filter(structure=structure).latest('id')  # *************
                        circuit_id = circuit_data.id
                        print(f"DEBUG [MDeadend5] - Found circuit data by structure lookup: {circuit_id}")   # *************
            
            # Now process circuit_id if we have one
            if circuit_id:
                # Convert to integer if it's a string
                if isinstance(circuit_id, str):
                    if circuit_id.isdigit():
                        circuit_id = int(circuit_id)
                        print(f"DEBUG [mupload5] - Converted circuit_id to int: {circuit_id}")  # *************
                    else:
                        print(f"DEBUG [mupload5] - circuit_id is string but not digit: '{circuit_id}', setting to None")  # *************
                        circuit_id = None
                
                # Try to get circuit data by circuit_id
                if circuit_id:
                    try:
                        circuit_data = MDeadend5.objects.get(id=circuit_id, structure=structure)  # *************
                        circuit_data_exists = True
                        print(f"DEBUG [mupload5] - Found circuit data by circuit_id: {circuit_id}")  # *************
                    except MDeadend5.DoesNotExist:    # *************
                        print(f"DEBUG [mupload5] - Circuit not found by circuit_id {circuit_id}, trying structure lookup")  # *************
                        # Fall back to structure lookup
                        circuit_exists = MDeadend5.objects.filter(structure=structure).exists()  # *************
                        if circuit_exists:
                            circuit_data = MDeadend5.objects.filter(structure=structure).latest('id')  # *************
                            circuit_data_exists = True
                            circuit_id = circuit_data.id
                            print(f"DEBUG [mupload5] - Found circuit data by structure: {circuit_id}")  # *************
                        else:
                            circuit_data_exists = False
                            print(f"DEBUG [mupload5] - No circuit data found for structure")   # *************
                    except ValueError as e:
                        print(f"DEBUG [mupload5] - ValueError with circuit_id {circuit_id}: {e}")   # *************
                        # Try structure lookup as fallback
                        circuit_exists = MDeadend5.objects.filter(structure=structure).exists()  # *************
                        if circuit_exists:
                            circuit_data = MDeadend5.objects.filter(structure=structure).latest('id')  # *************
                            circuit_data_exists = True
                            circuit_id = circuit_data.id
                            print(f"DEBUG [mupload5] - Fallback: Found circuit data by structure: {circuit_id}")  # *************
                        else:
                            circuit_data_exists = False
            else:
                # No circuit_id at all, check if circuit data exists for structure
                circuit_exists = MDeadend5.objects.filter(structure=structure).exists()  # *************
                if circuit_exists:
                    circuit_data = MDeadend5.objects.filter(structure=structure).latest('id')  # *************
                    circuit_data_exists = True
                    circuit_id = circuit_data.id
                    print(f"DEBUG [mupload5] - No circuit_id provided, found by structure: {circuit_id}")  # *************
                else:
                    circuit_data_exists = False
                    print(f"DEBUG [mupload5] - No circuit_id and no circuit data found for structure")  # *************
                    
        except ListOfStructure.DoesNotExist:
            return redirect('home')
    else:
        return redirect('home')
    
    # Check if circuit data exists
    if not circuit_data_exists:
        print(f"DEBUG [mupload5] - No circuit data found, redirecting to mdeadend")  # *************
        # Redirect to circuit definition page
        redirect_url = f'/mdeadend5/?structure_id={structure_id}&structure_type={structure_type}'  # *************
        if circuit_id:
            redirect_url += f'&circuit_id={circuit_id}'
        return HttpResponseRedirect(redirect_url)
    
    # Ensure session has circuit data
    if circuit_data:
        circuit_definition_data = {
            'num_3_phase_circuits': circuit_data.num_3_phase_circuits,
            'num_shield_wires': circuit_data.num_shield_wires,
            'num_1_phase_circuits': circuit_data.num_1_phase_circuits,
            'num_communication_cables': circuit_data.num_communication_cables,
            'circuit_model': 'MDeadend5',  # *************
            'circuit_id': circuit_data.id,
            'timestamp': time.time(),
        }
        request.session['circuit_definition'] = circuit_definition_data
        request.session['circuit_structure_id'] = circuit_data.id
        print(f"DEBUG [mupload5] - Updated session with circuit_id: {circuit_data.id}")    # *************
    
    if request.method == 'POST':
        # Handle file upload
        if 'file' in request.FILES:
            # Check if file already exists for this structure
            existing_file_check = mUploadedFile5.objects.filter(structure=structure).exists()  # ***********
            
            if existing_file_check:
                return render(request, 'app1/mupload5.html', {
                    'form': MUDeadendForm5(),    # ***************
                    'structures_with_files': ListOfStructure.objects.filter(muploaded_files5__isnull=False).distinct(),  # ************
                    'selected_structure': structure,
                    'structure_type': structure_type,
                    'structure_id': structure_id,
                    'circuit_id': circuit_id,
                    'existing_file': existing_file_check,
                    'circuit_data_exists': circuit_data_exists
                })
            
            form = MUDeadendForm5(request.POST, request.FILES)  # ***************
            if form.is_valid():
                try:
                    # Force the structure from URL parameter
                    instance = form.save(commit=False)
                    instance.structure = structure
                    instance.save()
                    
                    mextract_load_cases5(instance)   # ***************
                    
                    # Don't clear circuit-related session data
                    request.session.pop('selected_structure_id', None)
                    request.session.pop('selected_structure_type', None)
                    
                    # Redirect to show updated state
                    redirect_url = f'/mupload5/?structure_id={structure_id}&structure_type={structure_type}'  # ***************
                    if circuit_id:
                        redirect_url += f'&circuit_id={circuit_id}'
                    return HttpResponseRedirect(redirect_url)
                    
                except IntegrityError as e:
                    form.add_error('structure', 'A file has already been uploaded for this structure.')
                except Exception as e:
                    form.add_error(None, f'Error uploading file: {str(e)}')
            else:
                # Form is invalid, show errors
                for field, errors in form.errors.items():
                    for error in errors:
                        messages.error(request, f'{field}: {error}')
        
        # Handle Set/Phase or Attachment Joint Label selection and redirect
        elif 'set_phase_button' in request.POST:
            # Store selection in session and redirect to canvas container
            selected_values = {
                'button_type': 'set_phase',
                'structure_id': structure_id,
                'circuit_id': circuit_id
            }
            request.session['selected_values'] = selected_values
            return redirect('hdata1')
            
        elif 'joint_labels_button' in request.POST:
            # Store selection in session and redirect to canvas container
            selected_values = {
                'button_type': 'joint_labels',
                'structure_id': structure_id,
                'circuit_id': circuit_id
            }
            request.session['selected_values'] = selected_values
            return redirect('hdata1')
        
        # Handle custom group operations
        elif 'create_custom_group' in request.POST:
            structure_id = request.POST.get('structure_id')
            group_name = request.POST.get('group_name')
            selected_cases = request.POST.getlist('selected_cases')
            
            if structure_id and group_name:
                try:
                    structure = ListOfStructure.objects.get(id=structure_id)
                    
                    # Create custom group
                    custom_group = LoadCaseGroup.objects.create(
                        name=group_name,
                        structure=structure,
                        is_custom=True
                    )
                    
                    # Add selected cases to the custom group
                    for case_name in selected_cases:
                        LoadCase.objects.create(
                            name=case_name,
                            group=custom_group,
                            structure=structure
                        )
                    
                    return JsonResponse({'success': True})
                except Exception as e:
                    return JsonResponse({'success': False, 'error': str(e)})
        
        elif 'update_custom_group' in request.POST:
            old_group_name = request.POST.get('old_group_name')
            new_group_name = request.POST.get('new_group_name')
            
            if old_group_name and new_group_name and structure_id:
                try:
                    structure = ListOfStructure.objects.get(id=structure_id)
                    group = LoadCaseGroup.objects.get(
                        structure=structure,
                        name=old_group_name,
                        is_custom=True
                    )
                    group.name = new_group_name
                    group.save()
                    return JsonResponse({'success': True})
                except Exception as e:
                    return JsonResponse({'success': False, 'error': str(e)})
        
        elif 'delete_custom_group' in request.POST:
            group_name = request.POST.get('group_name')
            
            if group_name and structure_id:
                try:
                    structure = ListOfStructure.objects.get(id=structure_id)
                    LoadCaseGroup.objects.filter(
                        structure=structure,
                        name=group_name,
                        is_custom=True
                    ).delete()
                    return JsonResponse({'success': True})
                except Exception as e:
                    return JsonResponse({'success': False, 'error': str(e)})
    
    else:  # GET request
        # GET request - check for existing file
        existing_file = mUploadedFile5.objects.filter(structure=structure).exists()  # ***************
        form = MUDeadendForm5()    # ************
        
    structures_with_files = ListOfStructure.objects.filter(muploaded_files5__isnull=False).distinct()  # ***************

    # Handle AJAX requests for data (GET requests only)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        structure_id = request.GET.get('structure_id')
        if not structure_id:
            return JsonResponse({'error': 'Structure ID is required'}, status=400)

        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            latest_file = mUploadedFile5.objects.filter(structure=structure).latest('uploaded_at')  # ***************
            df = pd.read_excel(latest_file.file.path, engine='openpyxl')

            if request.GET.get('get_set_phase'):
                # Process set/phase data
                set_phase_data = df[['Set No.', 'Phase No.']].dropna().drop_duplicates()
                data = set_phase_data.to_dict('records')
                columns = {'Set No.': 'Set No.', 'Phase No.': 'Phase No.'}
                return JsonResponse({'data': data, 'columns': columns})

            elif request.GET.get('get_joint_labels'):
                # Process joint labels
                joint_labels = df['Attach. Joint Labels'].dropna().unique().tolist()
                return JsonResponse({'values': joint_labels})
            
            elif request.GET.get('get_load_cases'):
                # Process load cases - extract unique load cases
                if 'Load Case Description' in df.columns:
                    load_cases = df['Load Case Description'].dropna().unique().tolist()
                    return JsonResponse({'values': load_cases})
                else:
                    return JsonResponse({'error': 'Load Case Description column not found'}, status=400)
                    
            elif request.GET.get('get_grouped_load_cases'):
                # Process grouped load cases
                if 'Load Case Description' in df.columns:
                    load_cases = df['Load Case Description'].dropna().unique().tolist()
                    
                    # Group load cases by their prefix (e.g., Hurricane, NESC, Rule)
                    grouped_cases = {}
                    for case in load_cases:
                        # Extract the prefix (first word before space)
                        if ' ' in case:
                            prefix = case.split(' ')[0]
                        else:
                            prefix = case
                            
                        if prefix not in grouped_cases:
                            grouped_cases[prefix] = []
                        grouped_cases[prefix].append(case)
                    
                    return JsonResponse({'groups': grouped_cases})
                else:
                    return JsonResponse({'error': 'Load Case Description column not found'}, status=400)
            
            # Get custom groups for a structure
            elif request.GET.get('get_custom_groups_for_selection'):
                custom_groups = LoadCaseGroup.objects.filter(
                    structure=structure, 
                    is_custom=True
                ).prefetch_related('load_cases')
                
                groups_data = {}
                for group in custom_groups:
                    groups_data[group.name] = [case.name for case in group.load_cases.all()]
                
                return JsonResponse({'custom_groups': groups_data})
                
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=500)

    # Ensure circuit_id is always passed to template
    if not circuit_id and circuit_data:
        circuit_id = circuit_data.id
    
    return render(request, 'app1/mupload5.html', {     # ****************
        'form': form,
        'structures_with_files': structures_with_files,
        'selected_structure': structure,
        'structure_type': structure_type,
        'structure_id': structure_id,
        'circuit_id': circuit_id,
        'existing_file': existing_file,
        'circuit_data_exists': circuit_data_exists
    })



def mupload5_update(request):    # *************
    """
    Single page update view with structure selection and file upload
    """
    structure_id = request.GET.get('structure_id')
    structure_type = request.GET.get('structure_type')
    
    if request.method == 'POST':
        form = MUDeadendUpdateForm5(request.POST, request.FILES)   # *************
        if form.is_valid():
            try:
                structure = form.cleaned_data['structure']
                new_file = form.cleaned_data['file']
                
                # Get the existing file for this structure
                uploaded_file = mUploadedFile5.objects.get(structure=structure)  # *************
                
                # Delete the old file from storage
                if uploaded_file.file:
                    uploaded_file.file.delete(save=False)
                
                # Update the file field and save
                uploaded_file.file = new_file
                uploaded_file.save()
                
                # Re-extract load cases from the updated file
                mextract_load_cases5(uploaded_file)     # ****************
                
                messages.success(request, f'File for {structure.structure} updated successfully!')
                return redirect('mupload5_update')     # ****************
                  
            except mUploadedFile5.DoesNotExist:     # **************
                messages.error(request, 'No uploaded file found for this structure.')
            except IntegrityError as e:
                messages.error(request, 'File with this structure already exists.')
            except Exception as e:
                messages.error(request, f'Error updating file: {str(e)}')
    else:
        form = MUDeadendUpdateForm5()       # **************

    return render(request, 'app1/mupload5_update.html', {       # **************
        'form': form,
        'structure_id': structure_id,
        'structure_type': structure_type
    })



class MUDeadendForm5(forms.ModelForm):   # *************
    class Meta:
        model = mUploadedFile5               # *************
        fields = ('structure', 'file')

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Remove the filtering if we're hardcoding the structure in the view
        used_structures = mUploadedFile5.objects.values_list('structure_id', flat=True)   # *************
        self.fields['structure'].queryset = ListOfStructure.objects.exclude(id__in=used_structures)
        self.fields['structure'].empty_label = "Select Structure"
        # Make the field not required since we're setting it in the view
        self.fields['structure'].required = False

    def clean_file(self):
        uploaded_file = self.cleaned_data.get('file')
        ext = os.path.splitext(uploaded_file.name)[1].lower()
        if ext not in ['.xls', '.xlsx']:
            raise ValidationError("Only Excel files (.xls or .xlsx) are allowed.")
        return uploaded_file

class MUDeadendUpdateForm5(forms.Form):    # ************
    structure = forms.ModelChoiceField(
        queryset=ListOfStructure.objects.none(),
        empty_label="Select Structure to Update",
        required=True
    )
    
    file = forms.FileField(
        required=True,
        widget=forms.FileInput(attrs={'accept': '.xls,.xlsx'})
    )

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Only show structures that have uploaded files
        used_structures = mUploadedFile5.objects.values_list('structure_id', flat=True)   # ************
        self.fields['structure'].queryset = ListOfStructure.objects.filter(id__in=used_structures)

    def clean(self):
        cleaned_data = super().clean()
        structure = cleaned_data.get('structure')
        
        if structure and not mUploadedFile5.objects.filter(structure=structure).exists():   # ************
            raise ValidationError("No uploaded file found for this structure.")
        
        return cleaned_data

    def clean_file(self):
        uploaded_file = self.cleaned_data.get('file')
        if uploaded_file:
            ext = os.path.splitext(uploaded_file.name)[1].lower()
            if ext not in ['.xls', '.xlsx']:
                raise ValidationError("Only Excel files (.xls or .xlsx) are allowed.")
        return uploaded_file



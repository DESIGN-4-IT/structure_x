// ... (rest of the script remains unchanged until the relevant functions)

// NEW: Global variable to track the full active combinations list (updated after AJAX)
let fullActiveCombinations = JSON.parse('{{ active_combinations|safe|escapejs }}');  // Initialize with template data

// ... (other code)

// MODIFIED: Update storeCombinations to handle the full list
async function storeCombinations(status) {
    if (combinationsToConfirm.length === 0) return;

    try {
        const response = await fetch('{% url "store_set_phase_combinations" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken 
            },
            body: JSON.stringify({
                combinations: combinationsToConfirm,
                status: status
            })
        });

        const result = await response.json();

        if (response.ok) {
            console.log(result.message);
            
            // NEW: Update the global variable with the full list from the server
            fullActiveCombinations = result.active_combinations || [];
            
            // MODIFIED: Use the full list to update the display (renamed function)
            updateActiveCombinationsDisplay();
            updateTable();
            
            // Optionally show success message
            showSuccessMessage(`Combinations stored as ${status}`);
        } else {
            alert('Error storing combinations: ' + result.message);
        }
    } catch (error) {
        console.error('Network or other error:', error);
        alert('An unexpected error occurred. Check console.');
    } finally {
        combinationsToConfirm = [];
    }
}

// MODIFIED: Rename and update to render the full list (not just new ones)
function updateActiveCombinationsDisplay() {
    const displayElement = document.getElementById('active-combinations');
    displayElement.innerHTML = '';  // Clear existing list

    // Use the global full list (updated after AJAX) or fall back to initial template data
    const activeCombinationsList = fullActiveCombinations;

    if (activeCombinationsList.length === 0) {
        displayElement.innerHTML = '<p class="text-muted">No combinations active.</p>';
        return;
    }

    activeCombinationsList.forEach(combo => {
        // combo will be like "1-2-Ahead"
        const [set, phase, status] = combo.split('-'); 
        
        const badgeClass = status === 'Ahead' ? 'badge-success' : 'badge-warning';
        const item = document.createElement('span');
        item.className = 'badge badge-primary mr-1 mb-1';
        item.innerHTML = `Set ${set}, Phase ${phase} <span class="badge ${badgeClass}">${status}</span>`;
        item.dataset.set = set;
        item.dataset.phase = phase;
        item.dataset.status = status;
        // Optionally add a remove button
        // item.innerHTML += '<button class="close ml-1" onclick="removeCombination(\'' + combo + '\')">&times;</button>';
        displayElement.appendChild(item);
    });
}

// REMOVE: The old updateActiveCombinationsDisplayFromResponse function (no longer needed)

// ... (rest of the script remains unchanged)
{% extends "app1/base.html" %}
{% load static %}  <!-- Load static here too for good measure -->

{% block title %}Home - KOmatrix LoadView{% endblock %}

{% block extra_css %}

    <link rel="stylesheet" href="styles.css">
    <style>
    

    .content {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 90px 20px 20px;
    background: linear-gradient(to right, rgb(247, 248, 248), rgb(234, 252, 252));
    min-height: 100vh;
}

.form-container {
    background: #ffffff;
    border-radius: 12px;
    padding: 40px 30px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    animation: fadeIn 0.8s ease;
}

.form-container h2 {
    text-align: center;
    font-size: 25px;
    margin-bottom: 22px;
    color: #333;
}

.selected-structure-info {
    background: #e8f4fd;
    border: 1px solid #b6d7f2;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    font-size: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.existing-data-badge {
    background: #f39c12;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.existing-data-message {
    text-align: center;
    padding: 30px 20px;
}

.existing-data-message .alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f8f9fa;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group select:focus,
.form-group input:focus {
    border-color: #4facfe;
    background-color: #ffffff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
}

.help-text {
    color: #7f8c8d;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

.form-buttons {
    margin-top: 30px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.save-button, .next-button, .view-button, .cancel-button {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 140px;
}

.save-button {
    background: #27ae60;
    color: white;
}

.save-button:hover {
    background: #219a52;
    transform: translateY(-2px);
}

.next-button {
    background: #e67e22;
    color: white;
}

.next-button:hover {
    background: #d35400;
    transform: translateY(-2px);
}

.view-button {
    background: #3498db;
    color: white;
}

.view-button:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.cancel-button {
    background: #95a5a6;
    color: white;
}

.cancel-button:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 140px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-next {
    background: #27ae60;
    color: white;
}

.btn-next:hover {
    background: #219a52;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

/* Responsive design */
@media (max-width: 768px) {
    .content {
        padding: 80px 15px 15px;
    }
    
    .form-container {
        padding: 30px 20px;
        width: 95%;
    }
    
    .form-buttons {
        flex-direction: column;
    }
    
    .save-button, .next-button, .view-button, .cancel-button {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn {
        width: 100%;
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    .form-container h2 {
        font-size: 22px;
    }
    
    .form-group label {
        font-size: 14px;
    }
    
    .form-group select,
    .form-group input {
        padding: 10px 12px;
        font-size: 14px;
    }
    
    .save-button, .next-button, .view-button, .cancel-button {
        padding: 12px 20px;
        font-size: 13px;
    }
}

@keyframes fadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}


  .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 10px 10px; /* Rounded only at the bottom */
            text-align: center;
            width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            position: relative;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden; /* Ensures content does not overflow */
        }
        
        .popup .popup-header {
            background-color: #ffec00;
            color: black;
            font-size: 12px;
            padding: 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0px 0px 0 0;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            width: calc(100% + 40px);  /* Ensure it covers full width */
            margin: -20px -20px 0 -20px;  /* Remove gaps and extend header to popup edges */
            box-sizing: border-box;  /* Prevent overflow beyond the container */
        }
        
        
        .popup-close {
            position: absolute;
            top: 10%;
            right: 1px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 30px;
            color: black;
            background-color: transparent;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .popup h3 {
            margin: 20px 0;
            font-size: 14px;
            color: black;
        }
        
        .popup .popup-btn {
            padding: 10px 15px; /* Increase padding for better button size */
            margin: 15px 30px;  /* Increase the margin between buttons */
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 20px;
            color: white;
            transition: background-color 0.3s ease;
        }
        
        .popup-btn.blue {
            background-color: #007bff;
        }
        
        .popup-btn.green {
            background-color: green;
        }
        
        .popup-btn.red {
            background-color: red;
        }
        
        .popup-btn.yellow {
            background-color: yellow;
            color: black;
        }
        
        .popup-btn:hover {
            opacity: 0.9;
        }
        
        .blur {
            filter: blur(0.3spx);
        }
        
        
    </style>

{% endblock %}

{% block content %}
   
    
<div class="content">
    <div class="form-container">
        <h2>Circuit Definition</h2>
        
        <!-- Display selected structure info -->
        {% if selected_structure %}
        <div class="selected-structure-info">
            <strong>Selected Structure:</strong> {{ selected_structure.structure }}
            {% if existing_data %}
            <span class="existing-data-badge">Data Exists</span>
            {% endif %}
        </div>
        {% endif %}

        {% if existing_data %}
        <!-- Show view options when data exists -->
         {% if existing_circuit_data %}
        <input type="hidden" id="existing-circuit-id" value="{{ existing_circuit_data.id }}">
        {% endif %}

        <div class="existing-data-message">
            <div class="alert">
                <strong>Circuit definition already exists for this structure.</strong>
            </div>
            <div class="action-buttons">
                <a href="{% url 'tower_deadend_view1' %}" class="btn btn-primary">View Existing Data</a>
                
                <!-- Use a button instead of direct link to trigger popups -->
                <button id="continue-to-upload-btn" class="btn btn-next">Continue to Upload</button>
                
                <a href="{% url 'home' %}" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>
        {% else %}
        <!-- Show form only if no existing data -->
        <form method="POST" id="tower-form">
            {% csrf_token %}
            {% if existing_circuit_data %}
            <input type="hidden" name="circuit_id" value="{{ existing_circuit_data.id }}">
            {% endif %}
            <!-- Hidden field for structure -->
            {% if selected_structure %}
            <input type="hidden" name="structure" value="{{ selected_structure.id }}">
            {% endif %}
            
            <!-- Display form fields -->
            <div class="form-group">
                <label>Define number of 3-phase circuits</label>
                {{ form.num_3_phase_circuits }}
                {% if form.num_3_phase_circuits.errors %}
                    <div class="error-message">
                        {% for error in form.num_3_phase_circuits.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label>Define number of shield wires</label>
                {{ form.num_shield_wires }}
                {% if form.num_shield_wires.errors %}
                    <div class="error-message">
                        {% for error in form.num_shield_wires.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label>Define number of 1-phase circuits</label>
                {{ form.num_1_phase_circuits }}
                {% if form.num_1_phase_circuits.errors %}
                    <div class="error-message">
                        {% for error in form.num_1_phase_circuits.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label>Define number of communication cables</label>
                {{ form.num_communication_cables }}
                {% if form.num_communication_cables.errors %}
                    <div class="error-message">
                        {% for error in form.num_communication_cables.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Display any other form fields -->
            {% for field in form %}
                {% if field.name not in 'structure,num_3_phase_circuits,num_shield_wires,num_1_phase_circuits,num_communication_cables' and field.name != 'csrfmiddlewaretoken' %}
                <div class="form-group">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="error-message">
                            {% for error in field.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="help-text">{{ field.help_text }}</small>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
            
            <!-- Display non-field errors -->
            {% if form.non_field_errors %}
            <div class="error-message">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="form-buttons">
                <button class="save-button" type="submit">Save & Continue</button>
                <a href="{% url 'home' %}" class="cancel-button">Cancel</a>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<!-- Session Debug Information -->
<div class="session-info" style="background-color: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <h4>Session Debug Information:</h4>
    <p><strong>Structure Type:</strong> {{ session_structure_type|default:"Not set" }}</p>
    <p><strong>Structure ID:</strong> {{ structure_id|default:"Not set" }}</p>
    <p><strong>Popup Actions:</strong></p>
    <ul>
        {% for popup in session_popups %}
            <li>{{ popup }}</li>
        {% empty %}
            <li>No popup actions stored</li>
        {% endfor %}
    </ul>
    
    <!-- Circuit Definition Data -->
    <p><strong>Circuit Definition (from session):</strong></p>
    {% if session_circuit_definition %}
        <ul>
            {% for key, value in session_circuit_definition.items %}
                <li><strong>{{ key }}:</strong> {{ value }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No circuit definition data in session yet</p>
    {% endif %}
</div>

<!-- Popup Overlay -->
<div id="tower-popup-overlay" class="popup-overlay" style="display: none;">
    <div class="popup" id="tower-popup1">
        <div class="popup-header">
            <span class="popup-close">&times;</span>
            <h3>Is this a tap tower structure?</h3>
        </div>
        <button class="popup-btn blue" id="tower-yes-btn-1">Yes</button>
        <button class="popup-btn red" id="tower-no-btn-1">No</button>
    </div>

    <div class="popup" id="tower-popup2" style="display: none;">
        <div class="popup-header">
            <span class="popup-close">&times;</span>
            <h3>Is this a riser/terminal structure?</h3>
        </div>
        <button class="popup-btn blue" id="tower-yes-btn-2">Yes</button>
        <button class="popup-btn red" id="tower-no-btn-2">No</button>
    </div>

    <div class="popup" id="tower-popup3" style="display: none;">
        <div class="popup-header">
            <span class="popup-close">&times;</span>
            <h3>Switch to tangent Structure</h3>
        </div>
        <button class="popup-btn blue" id="tower-yes-btn-3">Yes</button>
        <button class="popup-btn red" id="tower-no-btn-3">Cancel</button>
    </div>
</div>

{% endblock %}

{% block extra_js %}


<script>
document.addEventListener('DOMContentLoaded', function() {
    const towerForm = document.getElementById('tower-form');
    const towerPopupOverlay = document.getElementById('tower-popup-overlay');
    const towerPopup1 = document.getElementById('tower-popup1');
    const towerPopup2 = document.getElementById('tower-popup2');
    const towerPopup3 = document.getElementById('tower-popup3');
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const structureId = urlParams.get('structure_id');
    const structureType = urlParams.get('structure_type');
    const refreshParam = urlParams.get('refresh');
    const circuitId = urlParams.get('circuit_id');
    
    // ðŸ”¥ Show popup immediately if we're redirected from a successful save
    if (refreshParam === 'true' && circuitId) {
        console.log('Auto-showing popup after successful save');
        towerPopupOverlay.style.display = 'flex';
        towerPopup1.style.display = 'block';
        
        // Store circuit ID in sessionStorage
        sessionStorage.setItem('circuitId', circuitId);
        
        // Remove refresh param from URL without reloading
        const newUrl = window.location.pathname + 
                      `?structure_id=${structureId}&structure_type=${structureType}&circuit_id=${circuitId}`;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // Store in sessionStorage for consistency
    if (structureId) {
        sessionStorage.setItem('selectedStructureId', structureId);
    }
    if (structureType) {
        sessionStorage.setItem('selectedStructureType', structureType);
    }
    if (circuitId) {
        sessionStorage.setItem('circuitId', circuitId);
    }
    
    // Handle "Continue to Upload" button for existing data
    const continueToUploadBtn = document.getElementById('continue-to-upload-btn');
    if (continueToUploadBtn) {
        continueToUploadBtn.addEventListener('click', function() {
            // Get the circuit ID from various sources
            let localCircuitId = circuitId || null;
            
            // Check if there's a hidden circuit_id field in the form
            if (!localCircuitId) {
                const circuitIdField = document.querySelector('[name="circuit_id"]');
                if (circuitIdField) {
                    localCircuitId = circuitIdField.value;
                }
            }
            
            // Check for the hidden div element
            if (!localCircuitId) {
                const existingCircuitIdDiv = document.getElementById('existing-circuit-id');
                if (existingCircuitIdDiv) {
                    localCircuitId = existingCircuitIdDiv.value;
                }
            }
            
            // Store circuit ID in sessionStorage for popup handlers
            if (localCircuitId) {
                sessionStorage.setItem('circuitId', localCircuitId);
                console.log('Stored circuitId in sessionStorage:', localCircuitId);
            }
            
            // Show the first popup
            towerPopupOverlay.style.display = 'flex';
            towerPopup1.style.display = 'block';
            console.log('Showing popup for existing data');
        });
    }
    
    // Auto-focus first input field (for new data form)
    if (towerForm) {
        const firstInput = towerForm.querySelector('.form-group input, .form-group select');
        if (firstInput) {
            firstInput.focus();
        }
    }
    
    // Form submission handler (for new data)
    if (towerForm) {
        towerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const saveButton = towerForm.querySelector('.save-button');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            const formData = new FormData(towerForm);
            
            // Add structure_id from URL if not in form
            if (structureId && !formData.has('structure')) {
                formData.append('structure', structureId);
            }
            
            fetch("{% url 'tdeadend' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData,
            })
            .then(response => {
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Handle non-JSON response (redirect)
                    return response.text().then(text => {
                        throw new Error('Expected JSON response, got HTML');
                    });
                }
            })
            .then(data => {
                if (data.status === 'success_redirect') {
                    // ðŸ”¥ Redirect to the page with circuit_id to show existing data view
                    console.log('Redirecting after successful save:', data.redirect_url);
                    window.location.href = data.redirect_url;
                    
                } else if (data.status === 'success') {
                    // Legacy success handling (shouldn't happen with new code)
                    // Store circuit ID in sessionStorage for popup handlers
                    if (data.circuit_id) {
                        sessionStorage.setItem('circuitId', data.circuit_id);
                    }
                    
                    // Redirect back with circuit_id to trigger existing data view
                    const redirectUrl = `/tdeadend/?structure_id=${structureId}&structure_type=${structureType}&circuit_id=${data.circuit_id}&refresh=true`;
                    window.location.href = redirectUrl;
                    
                } else if (data.status === 'error') {
                    console.error('Form validation error', data.errors);
                    
                    // Display errors on the form
                    if (data.errors) {
                        // Clear previous error messages
                        document.querySelectorAll('.error-message').forEach(el => el.remove());
                        
                        // Display new errors
                        for (const field in data.errors) {
                            const fieldElement = towerForm.querySelector(`[name="${field}"]`);
                            if (fieldElement) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'error-message';
                                errorDiv.innerHTML = `<p>${data.errors[field].join(', ')}</p>`;
                                fieldElement.parentNode.appendChild(errorDiv);
                            } else {
                                // For non-field errors
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'error-message';
                                errorDiv.innerHTML = `<p>${data.errors[field].join(', ')}</p>`;
                                towerForm.prepend(errorDiv);
                            }
                        }
                    } else {
                        alert('Please fill all fields correctly.');
                    }
                    
                    // Reset button state
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error saving form', error);
                alert('Something went wrong. Please try again.');
                
                // Reset button state
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        });
    }
    
    // ðŸ”¥ FIXED: Popup functionality - Ensure all popup elements exist before attaching events
    function closePopup() {
        towerPopupOverlay.style.display = 'none';
        towerPopup1.style.display = 'none';
        towerPopup2.style.display = 'none';
        towerPopup3.style.display = 'none';
    }
    
    // Attach close button event listener to all popups
    document.querySelectorAll('.popup-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', closePopup);
    });
    
    // ðŸ”¥ FIXED: Check if popup buttons exist before attaching events
    const towerYesBtn1 = document.getElementById('tower-yes-btn-1');
    const towerNoBtn1 = document.getElementById('tower-no-btn-1');
    const towerYesBtn2 = document.getElementById('tower-yes-btn-2');
    const towerNoBtn2 = document.getElementById('tower-no-btn-2');
    const towerYesBtn3 = document.getElementById('tower-yes-btn-3');
    const towerNoBtn3 = document.getElementById('tower-no-btn-3');
    
    if (towerYesBtn1) {
        towerYesBtn1.addEventListener('click', function() {
            // Get circuit_id from multiple sources
            let localCircuitId = circuitId || null;
            
            // 1. Check sessionStorage - handle string 'null' properly
            const storedCircuitId = sessionStorage.getItem('circuitId');
            if (storedCircuitId && storedCircuitId !== 'null' && storedCircuitId !== 'undefined') {
                localCircuitId = storedCircuitId;
            }
            
            // 2. Check hidden fields
            if (!localCircuitId) {
                const circuitIdField = document.querySelector('[name="circuit_id"]');
                if (circuitIdField && circuitIdField.value && circuitIdField.value !== 'null') {
                    localCircuitId = circuitIdField.value;
                }
            }
            
            // 3. Check for existing circuit ID div
            if (!localCircuitId) {
                const existingCircuitIdDiv = document.getElementById('existing-circuit-id');
                if (existingCircuitIdDiv && existingCircuitIdDiv.value && existingCircuitIdDiv.value !== 'null') {
                    localCircuitId = existingCircuitIdDiv.value;
                }
            }
            
            // Build URL
            let url = '/tupload1/?structure_id=' + structureId + '&structure_type=' + structureType;
            
            // Add circuit_id only if it's valid
            if (localCircuitId && localCircuitId !== 'null' && localCircuitId !== 'undefined') {
                url += '&circuit_id=' + encodeURIComponent(localCircuitId);
                console.log('Redirecting to tupload1 with circuit_id:', localCircuitId);
            } else {
                console.warn('No valid circuit_id found, redirecting without it');
            }
            
            // Store popup selection in session
            fetch('/update_session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    action: 'update_popup_selection',
                    key: 'tap_tower',
                    value: 'yes'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = url;
                } else {
                    alert('Error saving selection. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error saving popup selection:', error);
                window.location.href = url;
            });
        });
    }
    
    if (towerNoBtn1) {
        towerNoBtn1.addEventListener('click', function() {
            console.log('No button clicked on popup 1');
            towerPopup1.style.display = 'none';
            towerPopup2.style.display = 'block';
        });
    }
    
    if (towerYesBtn2) {
        towerYesBtn2.addEventListener('click', function() {
            // Get the circuit ID from sessionStorage or hidden field
            let localCircuitId = circuitId || null;
            const storedCircuitId = sessionStorage.getItem('circuitId');
            if (storedCircuitId && storedCircuitId !== 'null' && storedCircuitId !== 'undefined') {
                localCircuitId = storedCircuitId;
            }
            
            // Check hidden fields
            if (!localCircuitId) {
                const circuitIdField = document.querySelector('[name="circuit_id"]');
                if (circuitIdField && circuitIdField.value && circuitIdField.value !== 'null') {
                    localCircuitId = circuitIdField.value;
                }
            }
            
            let url = '/tupload2/?structure_id=' + structureId + '&structure_type=' + structureType;
            
            if (localCircuitId && localCircuitId !== 'null' && localCircuitId !== 'undefined') {
                url += '&circuit_id=' + encodeURIComponent(localCircuitId);
            }
            
            // Store popup selection in session
            fetch('/update_session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    action: 'update_popup_selection',
                    key: 'riser_terminal',
                    value: 'yes'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = url;
                } else {
                    alert('Error saving selection. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error saving popup selection:', error);
                window.location.href = url;
            });
        });
    }
    
    if (towerNoBtn2) {
        towerNoBtn2.addEventListener('click', function() {
            console.log('No button clicked on popup 2');
            towerPopup2.style.display = 'none';
            towerPopup3.style.display = 'block';
        });
    }
    
    if (towerYesBtn3) {
        towerYesBtn3.addEventListener('click', function() {
            console.log('Switching to tangent structure...');
            closePopup();
            // Add logic for switching to tangent structure here
            // For example, you might want to redirect to a different page:
            // window.location.href = '/ttangent/?structure_id=' + structureId + '&structure_type=' + structureType;
        });
    }
    
    if (towerNoBtn3) {
        towerNoBtn3.addEventListener('click', function() {
            console.log('Cancel button clicked on popup 3');
            towerPopup3.style.display = 'none';
            towerPopup2.style.display = 'block';
        });
    }
    
    // Also allow clicking outside popup to close
    towerPopupOverlay.addEventListener('click', function(e) {
        if (e.target === towerPopupOverlay) {
            closePopup();
        }
    });
});

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>


{% endblock %}
  


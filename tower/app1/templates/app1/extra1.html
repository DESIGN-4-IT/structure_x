Read the complete prompt and code carefully and act as an experienced Transmission Line / backend developer.

Problem summary

The Load Case page works correctly when selecting items from Imported Load Cases (this contains the full flat list).

For Group Load Cases and Custom Groups, load cases are organized into named groups.

When the user selects load cases from a group, the table must display results group-wise with the related group name.

When the user selects load cases from Imported, the table should behave exactly as it does now (flat list).

Currently, selecting multiple groups does not show all groups correctly ‚Äî results are merged or missing. It should return a grouping structure: group name ‚Üí records.

When a custom group is used, use the custom group name (as created by the user) and show that group's load cases.

Required behaviour

If selection source = imported: return selected load cases as a flat list (existing behavior).

If selection source = group or custom: return a grouped response: each group name with its associated records. If multiple groups selected, return all groups separately ‚Äî do not merge groups.

Pagination or filters must be applied after filtering, so the paginated results reflect the final (filtered/grouped) dataset.

Frontend should render the grouped results with group headers and rows for each group's load cases.
Note:
Provide clear hints about where exactly to add or modify the code, since I am a beginner.
this is views 
"def load_cases_page(request):
    """New dedicated page for Load Cases Selection and Load Values"""
    # Get selected values from session
    selected_values = request.session.get('selected_values', {})
    structure_id = selected_values.get('structure_id')
    selected_load_cases = selected_values.get('load_cases', [])
    
    # NEW: Get filter criteria from previous page
    filter_criteria = selected_values.get('filter_criteria', {})
    
    print(f"DEBUG load_cases_page: Session selected_values = {selected_values}")
    print(f"DEBUG: Filter criteria from session: {filter_criteria}")
    if 'set_phase_combinations' in filter_criteria:
        print(f"DEBUG: Number of combinations in filter_criteria: {len(filter_criteria['set_phase_combinations'])}")
        for i, combo in enumerate(filter_criteria['set_phase_combinations']):
            print(f"DEBUG: Combination {i}: Set={combo.get('set')}, Phase={combo.get('phase')}")
    
    # Handle load cases selection via AJAX only
    if request.method == 'POST' and 'load_cases_selection' in request.POST:
        if request.headers.get('x-requested-with') == 'XMLHttpRequest':
            selected_load_cases = request.POST.getlist('selected_load_cases')
            # Store selected load cases in session
            if 'selected_values' not in request.session:
                request.session['selected_values'] = {}
            request.session['selected_values']['load_cases'] = selected_load_cases
            request.session.modified = True
            
            # Return JSON response for AJAX requests
            return JsonResponse({'success': True, 'selected_cases': selected_load_cases})
    
    # NEW: Handle filter by previous selection
    if request.method == 'POST' and 'filter_by_previous' in request.POST:
        if request.headers.get('x-requested-with') == 'XMLHttpRequest':
            print(f"DEBUG: Filtering by previous selection - Criteria: {filter_criteria}")
            print(f"DEBUG: Current selected load cases: {selected_load_cases}")
            
            # Apply filter criteria to get filtered data - ONLY use currently selected load cases
            filtered_data = apply_previous_selection_filter(structure_id, filter_criteria, selected_load_cases)
            
            # DO NOT update the selected_load_cases in session - keep user's current selection
            # Only return the filtered data for display
            
            print(f"DEBUG: Filtered data count: {len(filtered_data)}")
            
            return JsonResponse({
                'success': True, 
                'filtered_data': filtered_data,  # Return the actual data
                'filter_criteria': filter_criteria,
                'record_count': len(filtered_data),
                'current_selected_cases': selected_load_cases  # Return current selection for reference
            })


    
    # AJAX handlers (moved from hdata1)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        return handle_load_cases_ajax(request)
    
    # Data processing for Load Values display
    load_data = []
    available_load_cases = []
    all_columns = []
    
    if structure_id:
        try:
            structure = ListOfStructure.objects.get(id=structure_id)
            
            # Try to get the latest file from different models
            latest_file = None
            file_models = [
                tUploadedFile6, hUploadedFile1, tUploadedFile1, tUploadedFile2,
                tUploadedFile3, tUploadedFile4, tUploadedFile5, hUploadedFile2,
                hUploadedFile3, hUploadedFile4, tUploadedFile7, tUploadedFile8,
                tUploadedFile9, tUploadedFile10, tUploadedFile11, UploadedFile1,
                UploadedFile22, mUploadedFile5, mUploadedFile6, mUploadedFile7,
                mUploadedFile8, mUploadedFile9, mUploadedFile10, mUploadedFile11
            ]
            
            for model in file_models:
                if model.objects.filter(structure=structure).exists():
                    latest_file = model.objects.filter(structure=structure).latest('uploaded_at')
                    break
            
            if latest_file:
                df = pd.read_excel(latest_file.file.path, engine='openpyxl')

                # Get available load cases for selection
                if 'Load Case Description' in df.columns:
                    available_load_cases = df['Load Case Description'].dropna().unique().tolist()

                # NEW: Apply filter criteria if available and no specific load cases selected
                if not selected_load_cases and filter_criteria:
                    filtered_load_cases = apply_previous_selection_filter(structure_id, filter_criteria)
                    if filtered_load_cases and 'Load Case Description' in df.columns:
                        df = df[df['Load Case Description'].isin(filtered_load_cases)]
                # Existing: Filter by selected load cases if any are selected
                elif selected_load_cases and 'Load Case Description' in df.columns:
                    df = df[df['Load Case Description'].isin(selected_load_cases)]

                # Prepare complete data for table display
                for _, row in df.iterrows():
                    row_data = {}
                    for col in df.columns:
                        if pd.notna(row[col]):
                            if pd.api.types.is_numeric_dtype(df[col]):
                                row_data[col] = float(row[col])
                            else:
                                row_data[col] = str(row[col])
                        else:
                            row_data[col] = '' if pd.api.types.is_string_dtype(df[col]) else 0
                    load_data.append(row_data)

                all_columns = list(df.columns)

        except Exception as e:
            print(f"Error processing Excel file: {str(e)}")

    # Handle calculation request
    if request.method == 'GET' and 'calculation_data' in request.GET:
        try:
            calculation_data = json.loads(request.GET.get('calculation_data', '[]'))
            return render(request, 'app1/calculation_results.html', {
                'calculation_data': calculation_data,
                'structure_id': structure_id
            })
        except json.JSONDecodeError:
            pass

    return render(request, 'app1/load_cases.html', {
        'load_data': load_data,
        'load_data_json': json.dumps(load_data),
        'selected_values': selected_values,
        'all_columns': all_columns,
        'available_load_cases': available_load_cases,
        'selected_load_cases': selected_load_cases,
        'structure_id': structure_id,
        'filter_criteria': filter_criteria,  # NEW: Pass filter criteria to template
    })
    
def get_filtered_load_data(request):
    """Get filtered load data based on selected load cases"""
    if request.headers.get('x-requested-with') != 'XMLHttpRequest':
        return JsonResponse({'error': 'Invalid request'}, status=400)
    
    structure_id = request.GET.get('structure_id')
    selected_load_cases = request.GET.getlist('selected_load_cases') or []
    
    if not structure_id:
        return JsonResponse({'error': 'Structure ID is required'}, status=400)
    
    try:
        structure = ListOfStructure.objects.get(id=structure_id)
        load_data = []
        all_columns = []
        
        # Try to get the latest file from different models
        latest_file = None
        file_models = [
            tUploadedFile6, hUploadedFile1, tUploadedFile1, tUploadedFile2,
            tUploadedFile3, tUploadedFile4, tUploadedFile5, hUploadedFile2,
            hUploadedFile3, hUploadedFile4, tUploadedFile7, tUploadedFile8,
            tUploadedFile9, tUploadedFile10, tUploadedFile11, UploadedFile1,
            UploadedFile22, mUploadedFile5, mUploadedFile6, mUploadedFile7,
            mUploadedFile8, mUploadedFile9, mUploadedFile10, mUploadedFile11
        ]
        
        for model in file_models:
            if model.objects.filter(structure=structure).exists():
                latest_file = model.objects.filter(structure=structure).latest('uploaded_at')
                break
        
        if latest_file:
            df = pd.read_excel(latest_file.file.path, engine='openpyxl')

            # Filter by selected load cases if any are selected
            if selected_load_cases and 'Load Case Description' in df.columns:
                df = df[df['Load Case Description'].isin(selected_load_cases)]

            # Prepare complete data for table display
            for _, row in df.iterrows():
                row_data = {}
                for col in df.columns:
                    if pd.notna(row[col]):
                        if pd.api.types.is_numeric_dtype(df[col]):
                            row_data[col] = float(row[col])
                        else:
                            row_data[col] = str(row[col])
                    else:
                        row_data[col] = '' if pd.api.types.is_string_dtype(df[col]) else 0
                load_data.append(row_data)

            all_columns = list(df.columns)
            
            return JsonResponse({
                'load_data': load_data,
                'all_columns': all_columns,
                'record_count': len(load_data)
            })
        else:
            return JsonResponse({'error': 'No file found for this structure'}, status=404)
            
    except ListOfStructure.DoesNotExist:
        return JsonResponse({'error': 'Structure not found'}, status=404)
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)
    
def get_all_load_cases(structure):
    """Get all available load cases from the database"""
    try:
        # Get all unique load case names from LoadCase model for this structure
        all_load_cases = LoadCase.objects.filter(
            structure=structure
        ).values_list('name', flat=True).distinct()
        
        return JsonResponse({'values': list(all_load_cases)})
        
    except Exception as e:
        return JsonResponse({'error': str(e)})

def handle_load_cases_ajax(request):
    """Handle all AJAX requests for load cases (moved from hdata1)"""
    structure_id = request.GET.get('structure_id') or request.POST.get('structure_id')
    
    if not structure_id:
        return JsonResponse({'error': 'Structure ID is required'}, status=400)
        
    try:
        structure = ListOfStructure.objects.get(id=structure_id)
        
        # Handle custom group creation
        if request.method == 'POST' and 'create_custom_group' in request.POST:
            group_name = request.POST.get('group_name')
            selected_cases = request.POST.getlist('selected_cases')
            
            if group_name and selected_cases:
                custom_group = LoadCaseGroup.objects.create(
                    name=group_name,
                    structure=structure,
                    is_custom=True
                )
                
                for case_name in selected_cases:
                    LoadCase.objects.create(
                        name=case_name,
                        group=custom_group,
                        structure=structure
                    )
                
                return JsonResponse({'success': True})
            return JsonResponse({'success': False, 'error': 'Group name and cases are required'})
        
        # Handle custom group deletion
        elif request.method == 'POST' and 'delete_custom_group' in request.POST:
            group_name = request.POST.get('group_name')
            
            if group_name:
                LoadCaseGroup.objects.filter(
                    structure=structure, 
                    name=group_name, 
                    is_custom=True
                ).delete()
                return JsonResponse({'success': True})
            return JsonResponse({'success': False, 'error': 'Group name is required'})
        
        # Handle custom group update
        elif request.method == 'POST' and 'update_custom_group' in request.POST:
            old_group_name = request.POST.get('old_group_name')
            new_group_name = request.POST.get('new_group_name')
            
            if old_group_name and new_group_name:
                groups = LoadCaseGroup.objects.filter(
                    structure=structure,
                    name=old_group_name,
                    is_custom=True
                )
                
                if not groups.exists():
                    return JsonResponse({'success': False, 'error': f'Group "{old_group_name}" not found'})
                
                for group in groups:
                    group.name = new_group_name
                    group.save()
                
                return JsonResponse({'success': True})
            return JsonResponse({'success': False, 'error': 'Old and new group names are required'})
        
        elif request.method == 'POST' and 'edit_custom_group' in request.POST:
            group_name = request.POST.get('group_name')
            selected_cases = request.POST.getlist('selected_cases[]')
            
            if group_name and selected_cases is not None:
                try:
                    # Get the custom group
                    group = LoadCaseGroup.objects.get(
                        structure=structure,
                        name=group_name,
                        is_custom=True
                    )
                    
                    # Clear existing load cases
                    group.load_cases.all().delete()
                    
                    # Add new load cases
                    for case_name in selected_cases:
                        LoadCase.objects.create(
                            name=case_name,
                            group=group,
                            structure=structure
                        )
                    
                    return JsonResponse({'success': True})
                    
                except LoadCaseGroup.DoesNotExist:
                    return JsonResponse({'success': False, 'error': f'Group "{group_name}" not found'})
                except Exception as e:
                    return JsonResponse({'success': False, 'error': str(e)})
            
            return JsonResponse({'success': False, 'error': 'Group name and cases are required'})
        
        # Handle GET requests for load case data
        elif request.method == 'GET':
            # Get filtered load data for table
            if request.GET.get('get_filtered_load_data'):
                return get_filtered_load_data(request)
            
            # Get imported load cases
            elif request.GET.get('get_load_cases'):
                return get_imported_load_cases(structure)
            
            # Get grouped load cases
            elif request.GET.get('get_grouped_load_cases'):
                return get_grouped_load_cases(structure)
            
            # Get custom groups
            elif request.GET.get('get_custom_groups_for_selection'):
                return get_custom_groups(structure)
            
            elif request.GET.get('get_all_load_cases'):
                return get_all_load_cases(structure)

    
    except ListOfStructure.DoesNotExist:
        return JsonResponse({'error': 'Structure not found'}, status=404)
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)
    
    return JsonResponse({'error': 'Invalid request'}, status=400)

def get_imported_load_cases(structure):
    """Get imported load cases from Excel files"""
    latest_file = None
    file_models = [
        hUploadedFile1, tUploadedFile6, tUploadedFile1, tUploadedFile2,
        tUploadedFile3, tUploadedFile4, tUploadedFile5, hUploadedFile2,
        hUploadedFile3, hUploadedFile4, tUploadedFile7, tUploadedFile8,
        tUploadedFile9, tUploadedFile10, tUploadedFile11, UploadedFile1,
        UploadedFile22, mUploadedFile5, mUploadedFile6, mUploadedFile7,
        mUploadedFile8, mUploadedFile9, mUploadedFile10, mUploadedFile11
    ]
    
    for model in file_models:
        if model.objects.filter(structure=structure).exists():
            latest_file = model.objects.filter(structure=structure).latest('uploaded_at')
            break
    
    if latest_file:
        df = pd.read_excel(latest_file.file.path, engine='openpyxl')
        if 'Load Case Description' in df.columns:
            load_cases = df['Load Case Description'].dropna().unique().tolist()
            return JsonResponse({'values': load_cases})
    
    return JsonResponse({'error': 'No load cases found'}, status=404)

def get_grouped_load_cases(structure):
    """Get grouped load cases from Excel files"""
    latest_file = None
    file_models = [hUploadedFile1, tUploadedFile6, tUploadedFile1]
    
    for model in file_models:
        if model.objects.filter(structure=structure).exists():
            latest_file = model.objects.filter(structure=structure).latest('uploaded_at')
            break
    
    if latest_file:
        df = pd.read_excel(latest_file.file.path, engine='openpyxl')
        if 'Load Case Description' in df.columns:
            load_cases = df['Load Case Description'].dropna().unique().tolist()
            
            # Group load cases by prefix
            grouped_cases = {}
            for case in load_cases:
                if ' ' in case:
                    prefix = case.split(' ')[0]
                else:
                    prefix = case
                    
                if prefix not in grouped_cases:
                    grouped_cases[prefix] = []
                grouped_cases[prefix].append(case)
            
            return JsonResponse({'groups': grouped_cases})
    
    return JsonResponse({'error': 'No grouped load cases found'}, status=404)

def get_custom_groups(structure):
    """Get custom groups from database"""
    custom_groups = LoadCaseGroup.objects.filter(
        structure=structure, 
        is_custom=True
    ).prefetch_related('load_cases')
    
    groups_data = {}
    for group in custom_groups:
        groups_data[group.name] = [case.name for case in group.load_cases.all()]
    
    return JsonResponse({'custom_groups': groups_data})

"

this is load_cases.html 
"  <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h3>Load Cases Selection & Load Values</h3>
                
                <!-- Navigation back to canvas container -->
                <div class="mb-3">
                    <a href="{% url 'hdata1' %}" class="btn btn-outline-secondary">
                        ‚Üê Back to Canvas Container
                    </a>
                </div>

                <!-- Load Cases Selection Section -->
                <div class="load-cases-section mb-4">
                    <h4>Load Cases Selection</h4>
                    
                    <div class="load-case-links mb-3">
                        <a href="#" id="imported-load-cases-link" class="load-case-link active">Imported Load Cases</a>
                        <a href="#" id="group-load-cases-link" class="load-case-link">Group Load Cases</a>
                        <a href="#" id="custom-groups-link" class="load-case-link">Custom Groups</a>
                    </div>
                    
                    <div id="load-cases-results" class="mb-3 p-3 border rounded bg-light">
                        <!-- Load cases will be displayed here -->
                    </div>
                    
                    <!-- Selected Load Cases Display -->
                    <div class="selected-load-cases mb-3 p-3 border rounded bg-light" id="selected-load-cases" style="display: none;">
                        <h5>Selected Load Cases:</h5>
                        <div id="selected-cases-list" class="d-flex flex-wrap gap-2"></div>
                        
                        <!-- Custom Group Creation -->
                        <div id="create-custom-group" class="mt-3 p-3 border rounded" style="display: none;">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <input type="text" id="custom-group-name" placeholder="Enter custom group name" 
                                       class="form-control" style="min-width: 200px;">
                                <button id="create-custom-group-btn" class="btn btn-primary">Create Custom Group</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Load Case Selection Form -->
                    <form method="post" id="load-cases-form">
                        {% csrf_token %}
                        <input type="hidden" name="load_cases_selection" value="true">
                        <input type="hidden" name="selected_load_cases_input" id="selected-load-cases-input">
                        
                        <button type="submit" class="btn btn-primary mt-2">Apply Selected Load Cases</button>
                    </form>
                </div>

                <hr>

                <div class="filter-section mb-3">
                    <form method="post" id="filter-previous-form">
                        {% csrf_token %}
                        <input type="hidden" name="filter_by_previous" value="true">
                        <button type="submit" class="btn btn-info" id="filter-previous-btn">
                            üîç Filter by Previous Selection
                        </button>
                        <small class="text-muted ms-2">
                            {% if filter_criteria %}
                                Active filters: 
                                {% if filter_criteria.joint_labels %}
                                    Joint Labels ({{ filter_criteria.joint_labels|length }})
                                {% endif %}
                                {% if filter_criteria.set_phase_combinations %}
                                    Set+Phase Combinations ({{ filter_criteria.set_phase_combinations|length }})
                                    <div class="debug-info small text-info mt-1">
                                        Combinations ({{ filter_criteria.set_phase_combinations|length }} total): 
                                        {% for combo in filter_criteria.set_phase_combinations %}
                                            Set {{ combo.set }} - Phase {{ combo.phase }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% else %}
                                No previous selection found
                            {% endif %}
                        </small>
                    </form>
                </div>


                <!-- Load Values Display Section -->
                <div id="load-values-section">
                    <h4>Load Values</h4>
                    <p class="text-muted">This data will be used for calculations based on your selected load cases.</p>
                    
                    <div class="btn-container mb-3">
                        <button id="calculate-btn" class="btn btn-success calculation-btn" disabled>
                            Calculate Selected Records
                        </button>
                        <span id="selected-count" class="selected-count badge bg-secondary ms-2">0 selected</span>
                    </div>

                    <div class="table-container">
                        <table class="table table-bordered table-striped" id="load-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Select</th>
                                    {% for column in all_columns %}
                                        <th>{{ column }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        
    </div>

    <!-- Edit Group Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel">Edit Group: <span id="edit-group-name"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Available Load Cases:</label>
                    <div id="available-load-cases-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- Available load cases will be populated here -->
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Selected Load Cases for this Group:</label>
                    <div id="group-selected-cases" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                        <!-- Selected cases will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-group-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>


    {% endblock %}

{% block extra_js %}


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const structureId = '{{ structure_id }}';
    const loadCasesResults = document.getElementById('load-cases-results');
    const selectedLoadCasesSection = document.getElementById('selected-load-cases');
    const selectedCasesList = document.getElementById('selected-cases-list');
    const selectedLoadCasesInput = document.getElementById('selected-load-cases-input');
    const createCustomGroupSection = document.getElementById('create-custom-group');
    const customGroupNameInput = document.getElementById('custom-group-name');
    const createCustomGroupBtn = document.getElementById('create-custom-group-btn');
    const loadCasesForm = document.getElementById('load-cases-form');
    const loadTable = document.getElementById('load-table');
    const loadTableBody = loadTable.querySelector('tbody');
    const calculateBtn = document.getElementById('calculate-btn');
    const selectedCount = document.getElementById('selected-count');
    
    const selectedLoadCases = new Set([...{{ selected_load_cases|safe }}]);
    const loadCaseLinks = document.querySelectorAll('.load-case-link');
    const selectedRecords = new Set();
    let allTableData = [];

    // Initialize with imported load cases
    loadImportedLoadCases();
    
    function updateSelectedLoadCases() {
        if (selectedLoadCases.size > 0) {
            selectedLoadCasesSection.style.display = 'block';
            selectedCasesList.innerHTML = '';
            
            selectedLoadCases.forEach(caseName => {
                const caseElement = document.createElement('span');
                caseElement.className = 'badge bg-primary selected-case';
                caseElement.innerHTML = `
                    ${caseName}
                    <span class="remove-case ms-1" data-case="${caseName}" style="cursor: pointer;">√ó</span>
                `;
                selectedCasesList.appendChild(caseElement);
            });
            
            // Show create custom group option
            createCustomGroupSection.style.display = 'block';
            
            // Update hidden input
            selectedLoadCasesInput.value = Array.from(selectedLoadCases).join(',');
            
            // Add remove event listeners
            document.querySelectorAll('.remove-case').forEach(btn => {
                btn.addEventListener('click', function() {
                    const caseName = this.dataset.case;
                    selectedLoadCases.delete(caseName);
                    updateSelectedLoadCases();
                    uncheckCorrespondingCheckbox(caseName);
                });
            });
        } else {
            selectedLoadCasesSection.style.display = 'none';
            createCustomGroupSection.style.display = 'none';
            selectedLoadCasesInput.value = '';
        }
    }
    
    function uncheckCorrespondingCheckbox(caseName) {
        const checkboxes = document.querySelectorAll(`input[type="checkbox"][value="${caseName}"]`);
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
    }
    
    // NEW: Function to clear all selections when switching tabs
    function clearAllSelections() {
        selectedLoadCases.clear();
        updateSelectedLoadCases();
        // Also clear any checkboxes in the current results section
        loadCasesResults.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
    }
    
    // Load Case Links Event Listeners - MODIFIED to clear selections
    document.getElementById('imported-load-cases-link').addEventListener('click', function(e) {
        e.preventDefault();
        setActiveLink(this);
        clearAllSelections(); // NEW: Clear selections when switching tabs
        loadImportedLoadCases();
    });
    
    document.getElementById('group-load-cases-link').addEventListener('click', function(e) {
        e.preventDefault();
        setActiveLink(this);
        clearAllSelections(); // NEW: Clear selections when switching tabs
        loadGroupedLoadCases();
    });
    
    document.getElementById('custom-groups-link').addEventListener('click', function(e) {
        e.preventDefault();
        setActiveLink(this);
        clearAllSelections(); // NEW: Clear selections when switching tabs
        loadCustomGroups();
    });
    
    function setActiveLink(activeLink) {
        loadCaseLinks.forEach(link => link.classList.remove('active'));
        activeLink.classList.add('active');
    }
    
    // Load Imported Load Cases - MODIFIED to add "Select All" functionality
    function loadImportedLoadCases() {
        if (!structureId) {
            loadCasesResults.innerHTML = '<div class="alert alert-warning">No structure selected</div>';
            return;
        }
        
        fetch(`/load-cases/?get_load_cases=true&structure_id=${structureId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                loadCasesResults.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            let html = '<h5>Imported Load Cases</h5>';
            
            // NEW: Add "Select All" checkbox for imported load cases
            if (data.values && data.values.length > 0) {
                html += `
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="select-all-imported">
                        <label class="form-check-label fw-bold" for="select-all-imported">
                            Select All Imported Load Cases
                        </label>
                    </div>
                `;
                
                html += '<div class="load-cases-list">';
                data.values.forEach(caseName => {
                    const isChecked = selectedLoadCases.has(caseName);
                    html += `
                        <div class="form-check">
                            <input class="form-check-input imported-case-checkbox" type="checkbox" value="${caseName}" 
                                   id="imported-${caseName.replace(/\s+/g, '-')}" 
                                   ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="imported-${caseName.replace(/\s+/g, '-')}">
                                ${caseName}
                            </label>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p class="text-muted">No load cases found</p>';
            }
            loadCasesResults.innerHTML = html;
            
            // NEW: Add "Select All" functionality for imported cases
            const selectAllImported = document.getElementById('select-all-imported');
            if (selectAllImported) {
                selectAllImported.addEventListener('change', function() {
                    const importedCheckboxes = document.querySelectorAll('.imported-case-checkbox');
                    importedCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                        if (this.checked) {
                            selectedLoadCases.add(cb.value);
                        } else {
                            selectedLoadCases.delete(cb.value);
                        }
                    });
                    updateSelectedLoadCases();
                });
            }
            
            // Add event listeners for individual checkboxes
            document.querySelectorAll('.imported-case-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedLoadCases.add(this.value);
                    } else {
                        selectedLoadCases.delete(this.value);
                        // Uncheck "Select All" if any checkbox is unchecked
                        if (selectAllImported) {
                            selectAllImported.checked = false;
                        }
                    }
                    updateSelectedLoadCases();
                });
            });
        })
        .catch(error => {
            loadCasesResults.innerHTML = `<div class="alert alert-danger">Error loading data: ${error}</div>`;
        });
    }
    
    // Load Grouped Load Cases - MODIFIED to enhance "Select All" functionality
    function loadGroupedLoadCases() {
        if (!structureId) {
            loadCasesResults.innerHTML = '<div class="alert alert-warning">No structure selected</div>';
            return;
        }
        
        fetch(`/load-cases/?get_grouped_load_cases=true&structure_id=${structureId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                loadCasesResults.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            let html = '<h5>Group Load Cases</h5>';
            if (data.groups && Object.keys(data.groups).length > 0) {
                // NEW: Add "Select All Groups" master checkbox
                html += `
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="select-all-groups">
                        <label class="form-check-label fw-bold" for="select-all-groups">
                            Select All Groups
                        </label>
                    </div>
                `;
                
                for (const [groupName, cases] of Object.entries(data.groups)) {
                    html += `
                        <div class="load-case-group mb-3 p-3 border rounded">
                            <h6 class="d-flex align-items-center">
                                ${groupName}
                                <div class="form-check ms-2">
                                    <input class="form-check-input select-all-group" type="checkbox" 
                                           id="select-all-${groupName.replace(/\s+/g, '-')}">
                                    <label class="form-check-label small" for="select-all-${groupName.replace(/\s+/g, '-')}">
                                        Select All in Group
                                    </label>
                                </div>
                            </h6>
                            <div class="group-cases ms-3">`;
                    
                    cases.forEach(caseName => {
                        const isChecked = selectedLoadCases.has(caseName);
                        html += `
                            <div class="form-check">
                                <input class="form-check-input group-case-checkbox" type="checkbox" 
                                       value="${caseName}" data-group="${groupName}"
                                       id="group-${caseName.replace(/\s+/g, '-')}" 
                                       ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="group-${caseName.replace(/\s+/g, '-')}">
                                    ${caseName}
                                </label>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
            } else {
                html += '<p class="text-muted">No grouped load cases found</p>';
            }
            loadCasesResults.innerHTML = html;
            
            // NEW: Add master "Select All Groups" functionality
            const selectAllGroups = document.getElementById('select-all-groups');
            if (selectAllGroups) {
                selectAllGroups.addEventListener('change', function() {
                    const groupSelectAlls = document.querySelectorAll('.select-all-group');
                    const groupCaseCheckboxes = document.querySelectorAll('.group-case-checkbox');
                    
                    groupSelectAlls.forEach(cb => {
                        cb.checked = this.checked;
                    });
                    
                    groupCaseCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                        if (this.checked) {
                            selectedLoadCases.add(cb.value);
                        } else {
                            selectedLoadCases.delete(cb.value);
                        }
                    });
                    updateSelectedLoadCases();
                });
            }
            
            // Add select all functionality for individual groups
            document.querySelectorAll('.select-all-group').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const groupName = this.id.replace('select-all-', '');
                    const caseCheckboxes = document.querySelectorAll(`.group-case-checkbox[data-group="${groupName}"]`);
                    caseCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                        if (this.checked) {
                            selectedLoadCases.add(cb.value);
                        } else {
                            selectedLoadCases.delete(cb.value);
                        }
                    });
                    updateSelectedLoadCases();
                    
                    // Update master "Select All Groups" checkbox
                    updateMasterSelectAllGroups();
                });
            });
            
            // Add individual checkbox listeners
            document.querySelectorAll('.group-case-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedLoadCases.add(this.value);
                    } else {
                        selectedLoadCases.delete(this.value);
                        // Uncheck group's select-all
                        const groupName = this.dataset.group;
                        const selectAll = document.getElementById(`select-all-${groupName}`);
                        if (selectAll) selectAll.checked = false;
                    }
                    updateSelectedLoadCases();
                    
                    // Update master "Select All Groups" checkbox
                    updateMasterSelectAllGroups();
                });
            });
            
            // NEW: Helper function to update master "Select All Groups" checkbox
            function updateMasterSelectAllGroups() {
                const selectAllGroups = document.getElementById('select-all-groups');
                if (selectAllGroups) {
                    const allGroupCheckboxes = document.querySelectorAll('.group-case-checkbox');
                    const allChecked = Array.from(allGroupCheckboxes).every(cb => cb.checked);
                    selectAllGroups.checked = allChecked;
                }
            }
        })
        .catch(error => {
            loadCasesResults.innerHTML = `<div class="alert alert-danger">Error loading data: ${error}</div>`;
        });
    }
    
    // Load Custom Groups - MODIFIED to enhance "Select All" functionality
    function loadCustomGroups() {
        if (!structureId) {
            loadCasesResults.innerHTML = '<div class="alert alert-warning">No structure selected</div>';
            return;
        }
        
        fetch(`/load-cases/?get_custom_groups_for_selection=true&structure_id=${structureId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                loadCasesResults.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            let html = '<h5>Custom Groups</h5>';
            if (data.custom_groups && Object.keys(data.custom_groups).length > 0) {
                // NEW: Add "Select All Custom Groups" master checkbox
                html += `
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="select-all-custom-groups">
                        <label class="form-check-label fw-bold" for="select-all-custom-groups">
                            Select All Custom Groups
                        </label>
                    </div>
                `;
                
                for (const [groupName, cases] of Object.entries(data.custom_groups)) {
                    html += `
                        <div class="load-case-group mb-3 p-3 border rounded" id="custom-group-${groupName.replace(/\s+/g, '-')}">
                            <h6 class="d-flex align-items-center">
                                <span class="group-name-display">${groupName}</span>
                                <div class="ms-2">
                                    <button class="btn btn-sm btn-outline-primary edit-group" data-group="${groupName}">Rename</button>
                                    <button class="btn btn-sm btn-outline-warning edit-group-members" data-group="${groupName}">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger delete-group" data-group="${groupName}">Delete</button>
                                </div>
                                <div class="form-check ms-2">
                                    <input class="form-check-input select-all-custom-group" type="checkbox" 
                                           id="select-all-custom-${groupName.replace(/\s+/g, '-')}">
                                    <label class="form-check-label small" for="select-all-custom-${groupName.replace(/\s+/g, '-')}">
                                        Select All in Group
                                    </label>
                                </div>
                            </h6>
                            <div class="group-edit-form mt-2" style="display: none;">
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control form-control-sm edit-group-input" value="${groupName}">
                                    <button class="btn btn-sm btn-success save-edit" data-group="${groupName}">Save</button>
                                    <button class="btn btn-sm btn-secondary cancel-edit" data-group="${groupName}">Cancel</button>
                                </div>
                            </div>
                            <div class="group-cases ms-3 mt-2">`;
                    
                    cases.forEach(caseName => {
                        const isChecked = selectedLoadCases.has(caseName);
                        html += `
                            <div class="form-check">
                                <input class="form-check-input custom-group-case-checkbox" type="checkbox" 
                                       value="${caseName}" data-group="${groupName}"
                                       id="custom-${caseName.replace(/\s+/g, '-')}" 
                                       ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="custom-${caseName.replace(/\s+/g, '-')}">
                                    ${caseName}
                                </label>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
            } else {
                html += '<p class="text-muted">No custom groups found</p>';
            }
            loadCasesResults.innerHTML = html;
            
            // Add custom group functionality
            setupCustomGroupFunctionality();
        })
        .catch(error => {
            loadCasesResults.innerHTML = `<div class="alert alert-danger">Error loading data: ${error}</div>`;
        });
    }
    
    // Setup custom group functionality (edit, delete, select all) - MODIFIED
    function setupCustomGroupFunctionality() {
        // NEW: Add master "Select All Custom Groups" functionality
        const selectAllCustomGroups = document.getElementById('select-all-custom-groups');
        if (selectAllCustomGroups) {
            selectAllCustomGroups.addEventListener('change', function() {
                const groupSelectAlls = document.querySelectorAll('.select-all-custom-group');
                const customGroupCaseCheckboxes = document.querySelectorAll('.custom-group-case-checkbox');
                
                groupSelectAlls.forEach(cb => {
                    cb.checked = this.checked;
                });
                
                customGroupCaseCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedLoadCases.add(cb.value);
                    } else {
                        selectedLoadCases.delete(cb.value);
                    }
                });
                updateSelectedLoadCases();
            });
        }
        
        // Select all functionality for individual custom groups
        document.querySelectorAll('.select-all-custom-group').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const groupName = this.id.replace('select-all-custom-', '');
                const caseCheckboxes = document.querySelectorAll(`.custom-group-case-checkbox[data-group="${groupName}"]`);
                caseCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedLoadCases.add(cb.value);
                    } else {
                        selectedLoadCases.delete(cb.value);
                    }
                });
                updateSelectedLoadCases();
                
                // Update master "Select All Custom Groups" checkbox
                updateMasterSelectAllCustomGroups();
            });
        });
        
        // Individual checkbox listeners
        document.querySelectorAll('.custom-group-case-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedLoadCases.add(this.value);
                } else {
                    selectedLoadCases.delete(this.value);
                    const groupName = this.dataset.group;
                    const selectAll = document.getElementById(`select-all-custom-${groupName}`);
                    if (selectAll) selectAll.checked = false;
                }
                updateSelectedLoadCases();
                
                // Update master "Select All Custom Groups" checkbox
                updateMasterSelectAllCustomGroups();
            });
        });

        document.querySelectorAll('.edit-group-members').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupName = this.dataset.group;
                openEditGroupModal(groupName);
            });
        });

        function openEditGroupModal(groupName) {
            // Set the group name in modal title
            document.getElementById('edit-group-name').textContent = groupName;
            
            // Show loading state
            document.getElementById('available-load-cases-list').innerHTML = '<div class="text-center py-3"><div class="spinner-border" role="status"></div></div>';
            document.getElementById('group-selected-cases').innerHTML = '<div class="text-center py-2">Loading...</div>';
            
            // Fetch available load cases and current group members
            fetch(`/load-cases/?get_all_load_cases=true&structure_id=${structureId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading load cases: ' + data.error);
                    return;
                }
                
                // Get current group members from the displayed checkboxes
                const currentGroupElement = document.getElementById(`custom-group-${groupName.replace(/\s+/g, '-')}`);
                const currentCases = [];
                if (currentGroupElement) {
                    const checkboxes = currentGroupElement.querySelectorAll('.custom-group-case-checkbox');
                    checkboxes.forEach(cb => {
                        currentCases.push(cb.value);
                    });
                }
                
                populateEditGroupModal(data.values || [], currentCases, groupName);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
                modal.show();
            })
            .catch(error => {
                alert('Error loading load cases: ' + error);
            });
        }

        // Function to populate the edit group modal
        function populateEditGroupModal(allLoadCases, currentGroupCases, groupName) {
            const availableList = document.getElementById('available-load-cases-list');
            const selectedList = document.getElementById('group-selected-cases');
            
            // Clear previous content
            availableList.innerHTML = '';
            selectedList.innerHTML = '';
            
            if (!allLoadCases || allLoadCases.length === 0) {
                availableList.innerHTML = '<p class="text-muted">No load cases available</p>';
                return;
            }
            
            // Sort load cases alphabetically for better UX
            allLoadCases.sort();
            
            // Create available load cases list
            allLoadCases.forEach(caseName => {
                const isInGroup = currentGroupCases.includes(caseName);
                const caseElement = document.createElement('div');
                caseElement.className = 'form-check';
                caseElement.innerHTML = `
                    <input class="form-check-input available-case-checkbox" type="checkbox" 
                        value="${caseName}" id="available-${caseName.replace(/\s+/g, '-')}"
                        ${isInGroup ? 'checked' : ''}>
                    <label class="form-check-label" for="available-${caseName.replace(/\s+/g, '-')}">
                        ${caseName}
                    </label>
                `;
                availableList.appendChild(caseElement);
            });
            
            // Populate selected cases display
            updateSelectedCasesDisplay(currentGroupCases);
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.available-case-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectedCasesDisplayFromCheckboxes();
                });
            });
            
            // Set up save button
            document.getElementById('save-group-changes').onclick = function() {
                saveGroupChanges(groupName);
            };
        }

        // Function to update selected cases display from checkboxes
        function updateSelectedCasesDisplayFromCheckboxes() {
            const selectedCases = [];
            document.querySelectorAll('.available-case-checkbox:checked').forEach(checkbox => {
                selectedCases.push(checkbox.value);
            });
            updateSelectedCasesDisplay(selectedCases);
        }

        // Function to update selected cases display
        function updateSelectedCasesDisplay(selectedCases) {
            const selectedList = document.getElementById('group-selected-cases');
            
            if (selectedCases.length === 0) {
                selectedList.innerHTML = '<p class="text-muted">No load cases selected</p>';
                return;
            }
            
            selectedList.innerHTML = '';
            
            // Sort selected cases alphabetically
            selectedCases.sort().forEach(caseName => {
                const caseElement = document.createElement('div');
                caseElement.className = 'selected-case-item d-flex justify-content-between align-items-center p-2 mb-1 bg-white rounded border';
                caseElement.innerHTML = `
                    <span class="flex-grow-1">${caseName}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-case-btn" data-case="${caseName}">
                        √ó
                    </button>
                `;
                selectedList.appendChild(caseElement);
            });
            
            // Add remove functionality
            document.querySelectorAll('.remove-case-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const caseName = this.dataset.case;
                    const checkbox = document.querySelector(`#available-${caseName.replace(/\s+/g, '-')}`);
                    if (checkbox) {
                        checkbox.checked = false;
                        updateSelectedCasesDisplayFromCheckboxes();
                    }
                });
            });
        }

        // Function to save group changes
        function saveGroupChanges(groupName) {
            const selectedCases = [];
            document.querySelectorAll('.available-case-checkbox:checked').forEach(checkbox => {
                selectedCases.push(checkbox.value);
            });
            
            if (selectedCases.length === 0) {
                alert('Please select at least one load case for the group');
                return;
            }
            
            const formData = new FormData();
            formData.append('edit_custom_group', 'true');
            formData.append('structure_id', structureId);
            formData.append('group_name', groupName);
            selectedCases.forEach(caseName => {
                formData.append('selected_cases[]', caseName);
            });
            
            // Show loading state
            const saveBtn = document.getElementById('save-group-changes');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
            saveBtn.disabled = true;
            
            fetch('/load-cases/', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Group "${groupName}" updated successfully!`, 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
                    if (modal) modal.hide();
                    // Reload custom groups to reflect changes
                    loadCustomGroups();
                } else {
                    alert('Error updating group: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error updating group: ' + error);
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }
                
        // NEW: Helper function to update master "Select All Custom Groups" checkbox
        function updateMasterSelectAllCustomGroups() {
            const selectAllCustomGroups = document.getElementById('select-all-custom-groups');
            if (selectAllCustomGroups) {
                const allCustomGroupCheckboxes = document.querySelectorAll('.custom-group-case-checkbox');
                const allChecked = allCustomGroupCheckboxes.length > 0 && 
                                 Array.from(allCustomGroupCheckboxes).every(cb => cb.checked);
                selectAllCustomGroups.checked = allChecked;
            }
        }
        
        // Edit group functionality
        document.querySelectorAll('.edit-group').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupName = this.dataset.group;
                const groupElement = this.closest('.load-case-group');
                const displayElement = groupElement.querySelector('.group-name-display');
                const editForm = groupElement.querySelector('.group-edit-form');
                
                displayElement.style.display = 'none';
                this.style.display = 'none';
                groupElement.querySelector('.delete-group').style.display = 'none';
                editForm.style.display = 'block';
            });
        });
        
        // Cancel edit
        document.querySelectorAll('.cancel-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupName = this.dataset.group;
                const groupElement = this.closest('.load-case-group');
                const displayElement = groupElement.querySelector('.group-name-display');
                const editForm = groupElement.querySelector('.group-edit-form');
                
                editForm.style.display = 'none';
                displayElement.style.display = 'inline';
                groupElement.querySelector('.edit-group').style.display = 'inline-block';
                groupElement.querySelector('.delete-group').style.display = 'inline-block';
            });
        });
        
        // Save edit
        document.querySelectorAll('.save-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const oldGroupName = this.dataset.group;
                const newGroupName = this.closest('.group-edit-form').querySelector('.edit-group-input').value.trim();
                
                if (!newGroupName) {
                    alert('Group name cannot be empty');
                    return;
                }
                
                if (newGroupName === oldGroupName) {
                    this.closest('.group-edit-form').querySelector('.cancel-edit').click();
                    return;
                }
                
                const formData = new FormData();
                formData.append('update_custom_group', 'true');
                formData.append('old_group_name', oldGroupName);
                formData.append('new_group_name', newGroupName);
                formData.append('structure_id', structureId);
                
                fetch('/load-cases/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload custom groups to reflect changes
                        loadCustomGroups();
                    } else {
                        alert('Error updating group: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error updating group: ' + error);
                });
            });
        });
        
        // Delete group functionality
        document.querySelectorAll('.delete-group').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupName = this.dataset.group;
                if (confirm(`Are you sure you want to delete the group "${groupName}"?`)) {
                    const formData = new FormData();
                    formData.append('delete_custom_group', 'true');
                    formData.append('structure_id', structureId);
                    formData.append('group_name', groupName);
                    
                    fetch('/load-cases/', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload custom groups
                            loadCustomGroups();
                        } else {
                            alert('Error deleting group: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error deleting group: ' + error);
                    });
                }
            });
        });
    }
    
    // Create Custom Group
    createCustomGroupBtn.addEventListener('click', function() {
        const groupName = customGroupNameInput.value.trim();
        
        if (!structureId) {
            alert('Please select a structure first');
            return;
        }
        
        if (!groupName) {
            alert('Please enter a group name');
            return;
        }
        
        if (selectedLoadCases.size === 0) {
            alert('Please select at least one load case');
            return;
        }
        
        const formData = new FormData();
        formData.append('create_custom_group', 'true');
        formData.append('structure_id', structureId);
        formData.append('group_name', groupName);
        selectedLoadCases.forEach(caseName => {
            formData.append('selected_cases', caseName);
        });
        
        fetch('/load-cases/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Custom group "${groupName}" created successfully!`);
                customGroupNameInput.value = '';
                // Switch to custom groups tab
                document.getElementById('custom-groups-link').click();
            } else {
                alert('Error creating custom group: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error creating custom group: ' + error);
        });
    });
    
    // Function to update the load values table with filtered data
    function updateLoadValuesTable(selectedCases) {
    if (!structureId) {
        return;
    }
    
    // Show loading state
    loadTableBody.innerHTML = '<tr><td colspan="100%" class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
    
    // Build URL with selected load cases
    const url = new URL('/load-cases/', window.location.origin);
    url.searchParams.append('get_filtered_load_data', 'true');
    url.searchParams.append('structure_id', structureId);
    selectedCases.forEach(caseName => {
        url.searchParams.append('selected_load_cases', caseName);
    });
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            loadTableBody.innerHTML = `<tr><td colspan="100%" class="text-center text-danger py-4">${data.error}</td></tr>`;
            return;
        }
        
        // Clear existing table data
        loadTableBody.innerHTML = '';
        allTableData = []; // Reset all table data
        selectedRecords.clear(); // Clear previous selections
        
        if (data.load_data && data.load_data.length > 0) {
            // Update table header if columns changed
            updateTableHeader(data.all_columns);
            
            // Populate table rows
            data.load_data.forEach((rowData, index) => {
                const row = document.createElement('tr');
                
                // Add select checkbox
                const selectCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'row-select';
                checkbox.dataset.index = index;
                selectCell.appendChild(checkbox);
                row.appendChild(selectCell);
                
                // Add data cells
                data.all_columns.forEach(column => {
                    const cell = document.createElement('td');
                    cell.textContent = rowData[column] || '';
                    row.appendChild(cell);
                });
                
                loadTableBody.appendChild(row);
                
                // Store the row data in allTableData
                allTableData.push(rowData);
            });
            
            // Update record count
            selectedCount.textContent = `${data.load_data.length} records`;
            calculateBtn.disabled = true; // Start with disabled calculate button
            
            // Add row selection functionality
            setupRowSelection();
            updateSelectedCount();
            
        } else {
            loadTableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted py-4">No data found for selected load cases</td></tr>';
            selectedCount.textContent = '0 records';
            calculateBtn.disabled = true;
        }
    })
    .catch(error => {
        loadTableBody.innerHTML = `<tr><td colspan="100%" class="text-center text-danger py-4">Error loading data: ${error}</td></tr>`;
    });
}

// Add select all functionality (optional but recommended)
function addSelectAllFunctionality() {
    // Add select all checkbox in header
    const thead = loadTable.querySelector('thead');
    const headerRow = thead.querySelector('tr');
    
    // Check if select all checkbox already exists
    if (!headerRow.querySelector('.select-all-checkbox')) {
        const selectAllTh = headerRow.querySelector('th:first-child');
        if (selectAllTh) {
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.className = 'select-all-checkbox';
            selectAllCheckbox.addEventListener('change', function() {
                const rowCheckboxes = document.querySelectorAll('.row-select');
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const index = parseInt(checkbox.dataset.index);
                    const record = allTableData[index];
                    
                    if (this.checked) {
                        selectedRecords.add(record);
                    } else {
                        selectedRecords.delete(record);
                    }
                });
                updateSelectedCount();
            });
            selectAllTh.innerHTML = '';
            selectAllTh.appendChild(selectAllCheckbox);
        }
    }
}
    // Function to update table header
    function updateTableHeader(columns) {
    const thead = loadTable.querySelector('thead');
    const headerRow = thead.querySelector('tr');
    
    // Keep the select column and update data columns
    headerRow.innerHTML = '<th>Select</th>';
    columns.forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        headerRow.appendChild(th);
    });
    
    // Add select all functionality
    addSelectAllFunctionality();
}
    
    // Function to setup row selection
    function setupRowSelection() {
    const rowSelects = document.querySelectorAll('.row-select');
    selectedRecords.clear();
    
    rowSelects.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const index = parseInt(this.dataset.index);
            const record = allTableData[index];
            
            if (this.checked) {
                selectedRecords.add(record);
            } else {
                selectedRecords.delete(record);
            }
            updateSelectedCount();
        });
    });
    }
    
    function updateSelectedCount() {
    const selectedCount = document.getElementById('selected-count');
    const calculateBtn = document.getElementById('calculate-btn');
    
    selectedCount.textContent = `${selectedRecords.size} selected`;
    calculateBtn.disabled = selectedRecords.size === 0;
}

// Add event listener for calculate button
document.getElementById('calculate-btn').addEventListener('click', function() {
    if (selectedRecords.size > 0) {
        // Prepare data for calculation - convert Set to Array
        const calculationData = Array.from(selectedRecords);
        
        // Create a form to submit the data via POST (FIX for 414 error)
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'calculation' %}";  // Make sure this matches your URL name
        form.target = '_blank';
        form.style.display = 'none';
        
        // Add CSRF token for Django POST requests
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        form.appendChild(csrfToken);
        
        // Add calculation data
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'calculation_data';
        input.value = JSON.stringify(calculationData);
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
});

    // Handle form submission with AJAX to prevent page refresh
    loadCasesForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        const formData = new FormData(this);
        
        // Add selected load cases to form data
        selectedLoadCases.forEach(caseName => {
            formData.append('selected_load_cases', caseName);
        });
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the table with filtered data
                updateLoadValuesTable(Array.from(selectedLoadCases));
                
                // Show success message (optional - you can remove this if you don't want popup)
                // showNotification('Load cases applied successfully!', 'success');
            } else {
                showNotification('Error applying load cases', 'error');
            }
        })
        .catch(error => {
            showNotification('Error applying load cases: ' + error, 'error');
        });
    });
    
    // Function to show notifications
document.getElementById('filter-previous-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const filterBtn = document.getElementById('filter-previous-btn');
    const originalText = filterBtn.innerHTML;
    
    // Show loading state
    filterBtn.innerHTML = '‚è≥ Applying Filter...';
    filterBtn.disabled = true;
    
    console.log('Current selected load cases:', Array.from(selectedLoadCases));
    console.log('Applying filter with criteria:', {{ filter_criteria|default:"{}"|safe }});
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Filter response:', data);
        
        if (data.success) {
            // Update the table with the actual filtered data
            if (data.filtered_data && data.filtered_data.length > 0) {
                updateTableWithFilteredData(data.filtered_data);
                
                let filterType = '';
                if (data.filter_criteria.joint_labels) {
                    filterType = `Joint Labels (${data.filter_criteria.joint_labels.length})`;
                }
                if (data.filter_criteria.set_phase_combinations) {
                    filterType = `Set+Phase Combinations (${data.filter_criteria.set_phase_combinations.length})`;
                }
                
                showNotification(`‚úÖ Filter applied! Found ${data.record_count} records matching ${filterType}`, 'success');
            } else {
                loadTableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-warning py-4">No matching records found for the current selection</td></tr>';
                selectedCount.textContent = '0 records';
                calculateBtn.disabled = true;
                showNotification('‚ö†Ô∏è No matching records found for the current selection', 'warning');
            }
        } else {
            showNotification('‚ùå Error applying filter', 'error');
        }
    })
    .catch(error => {
        console.error('Filter error:', error);
        showNotification('‚ùå Error applying filter: ' + error, 'error');
    })
    .finally(() => {
        // Reset button state
        filterBtn.innerHTML = 'üîç Filter by Previous Selection';
        filterBtn.disabled = false;
    });
});


// NEW: Function to update table with pre-filtered data
function updateTableWithFilteredData(filteredData) {
    // Clear existing table data
    loadTableBody.innerHTML = '';
    allTableData = []; // Reset all table data
    selectedRecords.clear(); // Clear previous selections
    
    if (filteredData && filteredData.length > 0) {
        // Get columns from the first data item
        const columns = Object.keys(filteredData[0]);
        
        // Update table header if needed
        updateTableHeader(columns);
        
        // Populate table rows with filtered data
        filteredData.forEach((rowData, index) => {
            const row = document.createElement('tr');
            
            // Add select checkbox
            const selectCell = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'row-select';
            checkbox.dataset.index = index;
            selectCell.appendChild(checkbox);
            row.appendChild(selectCell);
            
            // Add data cells
            columns.forEach(column => {
                const cell = document.createElement('td');
                const value = rowData[column] || '';
                cell.textContent = value;
                
                // Highlight Set No. and Phase No. columns for better visibility
                if (column === 'Set No.' || column === 'Phase No.') {
                    cell.style.fontWeight = 'bold';
                    cell.style.backgroundColor = '#e8f5e8'; // Light green
                    cell.style.borderLeft = '3px solid #28a745';
                }
                
                // Highlight Load Case Description
                if (column === 'Load Case Description') {
                    cell.style.fontWeight = 'bold';
                    cell.style.backgroundColor = '#e3f2fd'; // Light blue
                }
                
                row.appendChild(cell);
            });
            
            loadTableBody.appendChild(row);
            
            // Store the row data in allTableData
            allTableData.push(rowData);
        });
        
        // Update record count
        selectedCount.textContent = `${filteredData.length} records`;
        calculateBtn.disabled = true; // Start with disabled calculate button
        
        // Add row selection functionality
        setupRowSelection();
        updateSelectedCount();
        
        // Add select all functionality
        addSelectAllFunctionality();
        
    } else {
        loadTableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted py-4">No matching records found for the selected Set+Phase combinations</td></tr>';
        selectedCount.textContent = '0 records';
        calculateBtn.disabled = true;
    }
}


// NEW: Update all checkboxes based on filtered results
function updateAllCheckboxes(filteredCases) {
    // Update imported load cases checkboxes
    document.querySelectorAll('#load-cases-results input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = filteredCases.includes(checkbox.value);
    });
    
    // Update grouped load cases checkboxes
    document.querySelectorAll('.group-case-checkbox').forEach(checkbox => {
        checkbox.checked = filteredCases.includes(checkbox.value);
    });
    
    // Update custom group checkboxes  
    document.querySelectorAll('.custom-group-case-checkbox').forEach(checkbox => {
        checkbox.checked = filteredCases.includes(checkbox.value);
    });
}

// NEW: Enhanced notification function
// NEW: Enhanced notification function with better styling
function showNotification(message, type) {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger'} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500;
    `;
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="me-2">${getNotificationIcon(type)}</span>
            <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Helper function for notification icons
function getNotificationIcon(type) {
    switch(type) {
        case 'success': return '‚úÖ';
        case 'warning': return '‚ö†Ô∏è';
        case 'info': return '‚ÑπÔ∏è';
        case 'error': return '‚ùå';
        default: return 'üí°';
    }
}
    
    // Initialize selected cases display
    updateSelectedLoadCases();
    
    // Initialize table with current data on page load
    if (selectedLoadCases.size > 0) {
        updateLoadValuesTable(Array.from(selectedLoadCases));
    }
});
</script>"

